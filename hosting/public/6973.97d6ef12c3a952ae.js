"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6973],{6973:(hu,_s,w)=>{w.r(_s),w.d(_s,{HomePageModule:()=>uu});var Mr=w(177),K=w(7863),Fr=w(4341),ps=w(4964),g=w(4438),Lr=w(5797),Wr=w(1319),gt=w(9842),ee=w(1825),mt=w(9253),te=w(1977),Ne=w(6354),Ur=w(7647),gs=w(2816),ms=w(9974),tn=w(4360),Vr=w(8750),Br=w(3669),Hr=w(5343),Kr=w(3794),Yr=w(5558),jr=w(3294),$r=w(3236),zr=w(1985),ys=w(7786),qr=w(7673),Xr=(w(4635),w(3345)),pe=w(1362),Jr=w(467),yt=w(7852),c=w(1076),nn=w(8041);const vs="@firebase/database";let sn="";function rn(n){sn=n}class Zr{constructor(e){this.domStorage_=e,this.prefix_="firebase:"}set(e,t){null==t?this.domStorage_.removeItem(this.prefixedName_(e)):this.domStorage_.setItem(this.prefixedName_(e),(0,c.As)(t))}get(e){const t=this.domStorage_.getItem(this.prefixedName_(e));return null==t?null:(0,c.$L)(t)}remove(e){this.domStorage_.removeItem(this.prefixedName_(e))}prefixedName_(e){return this.prefix_+e}toString(){return this.domStorage_.toString()}}class eo{constructor(){this.cache_={},this.isInMemoryStorage=!0}set(e,t){null==t?delete this.cache_[e]:this.cache_[e]=t}get(e){return(0,c.gR)(this.cache_,e)?this.cache_[e]:null}remove(e){delete this.cache_[e]}}const ws=function(n){try{if(typeof window<"u"&&typeof window[n]<"u"){const e=window[n];return e.setItem("firebase:sentinel","cache"),e.removeItem("firebase:sentinel"),new Zr(e)}}catch{}return new eo},ge=ws("localStorage"),on=ws("sessionStorage"),Re=new nn.Vy("@firebase/database"),Es=function(){let n=1;return function(){return n++}}(),Ts=function(n){const e=(0,c.kj)(n),t=new c.gz;t.update(e);const s=t.digest();return c.K3.encodeByteArray(s)},Be=function(...n){let e="";for(let t=0;t<n.length;t++){const s=n[t];Array.isArray(s)||s&&"object"==typeof s&&"number"==typeof s.length?e+=Be.apply(null,s):e+="object"==typeof s?(0,c.As)(s):s,e+=" "}return e};let me=null,Is=!0;const Ss=function(n,e){(0,c.vA)(!e||!0===n||!1===n,"Can't turn on custom loggers persistently."),!0===n?(Re.logLevel=nn.$b.VERBOSE,me=Re.log.bind(Re),e&&on.set("logging_enabled",!0)):"function"==typeof n?me=n:(me=null,on.remove("logging_enabled"))},k=function(...n){if(!0===Is&&(Is=!1,null===me&&!0===on.get("logging_enabled")&&Ss(!0)),me){const e=Be.apply(null,n);me(e)}},He=function(n){return function(...e){k(n,...e)}},ln=function(...n){const e="FIREBASE INTERNAL ERROR: "+Be(...n);Re.error(e)},$=function(...n){const e=`FIREBASE FATAL ERROR: ${Be(...n)}`;throw Re.error(e),new Error(e)},O=function(...n){const e="FIREBASE WARNING: "+Be(...n);Re.warn(e)},vt=function(n){return"number"==typeof n&&(n!=n||n===Number.POSITIVE_INFINITY||n===Number.NEGATIVE_INFINITY)},ne="[MIN_NAME]",J="[MAX_NAME]",ye=function(n,e){if(n===e)return 0;if(n===ne||e===J)return-1;if(e===ne||n===J)return 1;{const t=Ns(n),s=Ns(e);return null!==t?null!==s?t-s==0?n.length-e.length:t-s:-1:null!==s?1:n<e?-1:1}},so=function(n,e){return n===e?0:n<e?-1:1},Ke=function(n,e){if(e&&n in e)return e[n];throw new Error("Missing required key ("+n+") in object: "+(0,c.As)(e))},an=function(n){if("object"!=typeof n||null===n)return(0,c.As)(n);const e=[];for(const s in n)e.push(s);e.sort();let t="{";for(let s=0;s<e.length;s++)0!==s&&(t+=","),t+=(0,c.As)(e[s]),t+=":",t+=an(n[e[s]]);return t+="}",t},As=function(n,e){const t=n.length;if(t<=e)return[n];const s=[];for(let i=0;i<t;i+=e)s.push(n.substring(i,i+e>t?t:i+e));return s};function x(n,e){for(const t in n)n.hasOwnProperty(t)&&e(t,n[t])}const bs=function(n){(0,c.vA)(!vt(n),"Invalid JSON number");const s=1023;let i,r,o,l,a;0===n?(r=0,o=0,i=1/n==-1/0?1:0):(i=n<0,(n=Math.abs(n))>=Math.pow(2,1-s)?(l=Math.min(Math.floor(Math.log(n)/Math.LN2),s),r=l+s,o=Math.round(n*Math.pow(2,52-l)-Math.pow(2,52))):(r=0,o=Math.round(n/Math.pow(2,-1074))));const u=[];for(a=52;a;a-=1)u.push(o%2?1:0),o=Math.floor(o/2);for(a=11;a;a-=1)u.push(r%2?1:0),r=Math.floor(r/2);u.push(i?1:0),u.reverse();const h=u.join("");let d="";for(a=0;a<64;a+=8){let f=parseInt(h.substr(a,8),2).toString(16);1===f.length&&(f="0"+f),d+=f}return d.toLowerCase()},lo=new RegExp("^-?(0*)\\d{1,10}$"),Ns=function(n){if(lo.test(n)){const e=Number(n);if(e>=-2147483648&&e<=2147483647)return e}return null},Pe=function(n){try{n()}catch(e){setTimeout(()=>{throw O("Exception was thrown by user callback.",e.stack||""),e},Math.floor(0))}},Ge=function(n,e){const t=setTimeout(n,e);return"number"==typeof t&&typeof Deno<"u"&&Deno.unrefTimer?Deno.unrefTimer(t):"object"==typeof t&&t.unref&&t.unref(),t};class ho{constructor(e,t){this.appName_=e,this.appCheckProvider=t,this.appCheck=null==t?void 0:t.getImmediate({optional:!0}),this.appCheck||null==t||t.get().then(s=>this.appCheck=s)}getToken(e){return this.appCheck?this.appCheck.getToken(e):new Promise((t,s)=>{setTimeout(()=>{this.appCheck?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){var t;null===(t=this.appCheckProvider)||void 0===t||t.get().then(s=>s.addTokenListener(e))}notifyForInvalidToken(){O(`Provided AppCheck credentials for the app named "${this.appName_}" are invalid. This usually indicates your app was not initialized correctly.`)}}class fo{constructor(e,t,s){this.appName_=e,this.firebaseOptions_=t,this.authProvider_=s,this.auth_=null,this.auth_=s.getImmediate({optional:!0}),this.auth_||s.onInit(i=>this.auth_=i)}getToken(e){return this.auth_?this.auth_.getToken(e).catch(t=>t&&"auth/token-not-initialized"===t.code?(k("Got auth/token-not-initialized error.  Treating as null token."),null):Promise.reject(t)):new Promise((t,s)=>{setTimeout(()=>{this.auth_?this.getToken(e).then(t,s):t(null)},0)})}addTokenChangeListener(e){this.auth_?this.auth_.addAuthTokenListener(e):this.authProvider_.get().then(t=>t.addAuthTokenListener(e))}removeTokenChangeListener(e){this.authProvider_.get().then(t=>t.removeAuthTokenListener(e))}notifyForInvalidToken(){let e='Provided authentication credentials for the app named "'+this.appName_+'" are invalid. This usually indicates your app was not initialized correctly. ';e+="credential"in this.firebaseOptions_?'Make sure the "credential" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':"serviceAccount"in this.firebaseOptions_?'Make sure the "serviceAccount" property provided to initializeApp() is authorized to access the specified "databaseURL" and is from the correct project.':'Make sure the "apiKey" and "databaseURL" properties provided to initializeApp() match the values provided for your app at https://console.firebase.google.com/.',O(e)}}let Qe=(()=>{class n{constructor(t){this.accessToken=t}getToken(t){return Promise.resolve({accessToken:this.accessToken})}addTokenChangeListener(t){t(this.accessToken)}removeTokenChangeListener(t){}notifyForInvalidToken(){}}return n.OWNER="owner",n})();const Ds=/(console\.firebase|firebase-console-\w+\.corp|firebase\.corp)\.google\.com/,Fs="websocket",Ls="long_polling";class un{constructor(e,t,s,i,r=!1,o="",l=!1,a=!1){this.secure=t,this.namespace=s,this.webSocketOnly=i,this.nodeAdmin=r,this.persistenceKey=o,this.includeNamespaceInQueryParams=l,this.isUsingEmulator=a,this._host=e.toLowerCase(),this._domain=this._host.substr(this._host.indexOf(".")+1),this.internalHost=ge.get("host:"+e)||this._host}isCacheableHost(){return"s-"===this.internalHost.substr(0,2)}isCustomHost(){return"firebaseio.com"!==this._domain&&"firebaseio-demo.com"!==this._domain}get host(){return this._host}set host(e){e!==this.internalHost&&(this.internalHost=e,this.isCacheableHost()&&ge.set("host:"+this._host,this.internalHost))}toString(){let e=this.toURLString();return this.persistenceKey&&(e+="<"+this.persistenceKey+">"),e}toURLString(){return`${this.secure?"https://":"http://"}${this.host}/${this.includeNamespaceInQueryParams?`?ns=${this.namespace}`:""}`}}function Ws(n,e,t){let s;if((0,c.vA)("string"==typeof e,"typeof type must == string"),(0,c.vA)("object"==typeof t,"typeof params must == object"),e===Fs)s=(n.secure?"wss://":"ws://")+n.internalHost+"/.ws?";else{if(e!==Ls)throw new Error("Unknown connection type: "+e);s=(n.secure?"https://":"http://")+n.internalHost+"/.lp?"}(function _o(n){return n.host!==n.internalHost||n.isCustomHost()||n.includeNamespaceInQueryParams})(n)&&(t.ns=n.namespace);const i=[];return x(t,(r,o)=>{i.push(r+"="+o)}),s+i.join("&")}class po{constructor(){this.counters_={}}incrementCounter(e,t=1){(0,c.gR)(this.counters_,e)||(this.counters_[e]=0),this.counters_[e]+=t}get(){return(0,c.A4)(this.counters_)}}const hn={},dn={};function fn(n){const e=n.toString();return hn[e]||(hn[e]=new po),hn[e]}class mo{constructor(e){this.onMessage_=e,this.pendingResponses=[],this.currentResponseNum=0,this.closeAfterResponse=-1,this.onClose=null}closeAfter(e,t){this.closeAfterResponse=e,this.onClose=t,this.closeAfterResponse<this.currentResponseNum&&(this.onClose(),this.onClose=null)}handleResponse(e,t){for(this.pendingResponses[e]=t;this.pendingResponses[this.currentResponseNum];){const s=this.pendingResponses[this.currentResponseNum];delete this.pendingResponses[this.currentResponseNum];for(let i=0;i<s.length;++i)s[i]&&Pe(()=>{this.onMessage_(s[i])});if(this.currentResponseNum===this.closeAfterResponse){this.onClose&&(this.onClose(),this.onClose=null);break}this.currentResponseNum++}}}class se{constructor(e,t,s,i,r,o,l){this.connId=e,this.repoInfo=t,this.applicationId=s,this.appCheckToken=i,this.authToken=r,this.transportSessionId=o,this.lastSessionId=l,this.bytesSent=0,this.bytesReceived=0,this.everConnected_=!1,this.log_=He(e),this.stats_=fn(t),this.urlFn=a=>(this.appCheckToken&&(a.ac=this.appCheckToken),Ws(t,Ls,a))}open(e,t){this.curSegmentNum=0,this.onDisconnect_=t,this.myPacketOrderer=new mo(e),this.isClosed_=!1,this.connectTimeoutTimer_=setTimeout(()=>{this.log_("Timed out trying to connect."),this.onClosed_(),this.connectTimeoutTimer_=null},Math.floor(3e4)),function(n){if((0,c.$g)()||"complete"===document.readyState)n();else{let e=!1;const t=function(){document.body?e||(e=!0,n()):setTimeout(t,Math.floor(10))};document.addEventListener?(document.addEventListener("DOMContentLoaded",t,!1),window.addEventListener("load",t,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",()=>{"complete"===document.readyState&&t()}),window.attachEvent("onload",t))}}(()=>{if(this.isClosed_)return;this.scriptTagHolder=new _n((...r)=>{const[o,l,a,u,h]=r;if(this.incrementIncomingBytes_(r),this.scriptTagHolder)if(this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null),this.everConnected_=!0,"start"===o)this.id=l,this.password=a;else{if("close"!==o)throw new Error("Unrecognized command received: "+o);l?(this.scriptTagHolder.sendNewPolls=!1,this.myPacketOrderer.closeAfter(l,()=>{this.onClosed_()})):this.onClosed_()}},(...r)=>{const[o,l]=r;this.incrementIncomingBytes_(r),this.myPacketOrderer.handleResponse(o,l)},()=>{this.onClosed_()},this.urlFn);const s={start:"t"};s.ser=Math.floor(1e8*Math.random()),this.scriptTagHolder.uniqueCallbackIdentifier&&(s.cb=this.scriptTagHolder.uniqueCallbackIdentifier),s.v="5",this.transportSessionId&&(s.s=this.transportSessionId),this.lastSessionId&&(s.ls=this.lastSessionId),this.applicationId&&(s.p=this.applicationId),this.appCheckToken&&(s.ac=this.appCheckToken),typeof location<"u"&&location.hostname&&Ds.test(location.hostname)&&(s.r="f");const i=this.urlFn(s);this.log_("Connecting via long-poll to "+i),this.scriptTagHolder.addTag(i,()=>{})})}start(){this.scriptTagHolder.startLongPoll(this.id,this.password),this.addDisconnectPingFrame(this.id,this.password)}static forceAllow(){se.forceAllow_=!0}static forceDisallow(){se.forceDisallow_=!0}static isAvailable(){return!((0,c.$g)()||!se.forceAllow_&&(se.forceDisallow_||!(typeof document<"u")||null==document.createElement||"object"==typeof window&&window.chrome&&window.chrome.extension&&!/^chrome/.test(window.location.href)||"object"==typeof Windows&&"object"==typeof Windows.UI))}markConnectionHealthy(){}shutdown_(){this.isClosed_=!0,this.scriptTagHolder&&(this.scriptTagHolder.close(),this.scriptTagHolder=null),this.myDisconnFrame&&(document.body.removeChild(this.myDisconnFrame),this.myDisconnFrame=null),this.connectTimeoutTimer_&&(clearTimeout(this.connectTimeoutTimer_),this.connectTimeoutTimer_=null)}onClosed_(){this.isClosed_||(this.log_("Longpoll is closing itself"),this.shutdown_(),this.onDisconnect_&&(this.onDisconnect_(this.everConnected_),this.onDisconnect_=null))}close(){this.isClosed_||(this.log_("Longpoll is being closed."),this.shutdown_())}send(e){const t=(0,c.As)(e);this.bytesSent+=t.length,this.stats_.incrementCounter("bytes_sent",t.length);const s=(0,c.KA)(t),i=As(s,1840);for(let r=0;r<i.length;r++)this.scriptTagHolder.enqueueSegment(this.curSegmentNum,i.length,i[r]),this.curSegmentNum++}addDisconnectPingFrame(e,t){if((0,c.$g)())return;this.myDisconnFrame=document.createElement("iframe");const s={dframe:"t"};s.id=e,s.pw=t,this.myDisconnFrame.src=this.urlFn(s),this.myDisconnFrame.style.display="none",document.body.appendChild(this.myDisconnFrame)}incrementIncomingBytes_(e){const t=(0,c.As)(e).length;this.bytesReceived+=t,this.stats_.incrementCounter("bytes_received",t)}}class _n{constructor(e,t,s,i){if(this.onDisconnect=s,this.urlFn=i,this.outstandingRequests=new Set,this.pendingSegs=[],this.currentSerial=Math.floor(1e8*Math.random()),this.sendNewPolls=!0,(0,c.$g)())this.commandCB=e,this.onMessageCB=t;else{this.uniqueCallbackIdentifier=Es(),window["pLPCommand"+this.uniqueCallbackIdentifier]=e,window["pRTLPCB"+this.uniqueCallbackIdentifier]=t,this.myIFrame=_n.createIFrame_();let r="";this.myIFrame.src&&"javascript:"===this.myIFrame.src.substr(0,11)&&(r='<script>document.domain="'+document.domain+'";<\/script>');const o="<html><body>"+r+"</body></html>";try{this.myIFrame.doc.open(),this.myIFrame.doc.write(o),this.myIFrame.doc.close()}catch(l){k("frame writing exception"),l.stack&&k(l.stack),k(l)}}}static createIFrame_(){const e=document.createElement("iframe");if(e.style.display="none",!document.body)throw"Document body has not initialized. Wait to initialize Firebase until after the document is ready.";document.body.appendChild(e);try{e.contentWindow.document||k("No IE domain setting required")}catch{const s=document.domain;e.src="javascript:void((function(){document.open();document.domain='"+s+"';document.close();})())"}return e.contentDocument?e.doc=e.contentDocument:e.contentWindow?e.doc=e.contentWindow.document:e.document&&(e.doc=e.document),e}close(){this.alive=!1,this.myIFrame&&(this.myIFrame.doc.body.textContent="",setTimeout(()=>{null!==this.myIFrame&&(document.body.removeChild(this.myIFrame),this.myIFrame=null)},Math.floor(0)));const e=this.onDisconnect;e&&(this.onDisconnect=null,e())}startLongPoll(e,t){for(this.myID=e,this.myPW=t,this.alive=!0;this.newRequest_(););}newRequest_(){if(this.alive&&this.sendNewPolls&&this.outstandingRequests.size<(this.pendingSegs.length>0?2:1)){this.currentSerial++;const e={};e.id=this.myID,e.pw=this.myPW,e.ser=this.currentSerial;let t=this.urlFn(e),s="",i=0;for(;this.pendingSegs.length>0&&this.pendingSegs[0].d.length+30+s.length<=1870;){const o=this.pendingSegs.shift();s=s+"&seg"+i+"="+o.seg+"&ts"+i+"="+o.ts+"&d"+i+"="+o.d,i++}return t+=s,this.addLongPollTag_(t,this.currentSerial),!0}return!1}enqueueSegment(e,t,s){this.pendingSegs.push({seg:e,ts:t,d:s}),this.alive&&this.newRequest_()}addLongPollTag_(e,t){this.outstandingRequests.add(t);const s=()=>{this.outstandingRequests.delete(t),this.newRequest_()},i=setTimeout(s,Math.floor(25e3));this.addTag(e,()=>{clearTimeout(i),s()})}addTag(e,t){(0,c.$g)()?this.doNodeLongPoll(e,t):setTimeout(()=>{try{if(!this.sendNewPolls)return;const s=this.myIFrame.doc.createElement("script");s.type="text/javascript",s.async=!0,s.src=e,s.onload=s.onreadystatechange=function(){const i=s.readyState;(!i||"loaded"===i||"complete"===i)&&(s.onload=s.onreadystatechange=null,s.parentNode&&s.parentNode.removeChild(s),t())},s.onerror=()=>{k("Long-poll script failed to load: "+e),this.sendNewPolls=!1,this.close()},this.myIFrame.doc.body.appendChild(s)}catch{}},Math.floor(1))}}let wt=null;typeof MozWebSocket<"u"?wt=MozWebSocket:typeof WebSocket<"u"&&(wt=WebSocket);let ke=(()=>{class n{constructor(t,s,i,r,o,l,a){this.connId=t,this.applicationId=i,this.appCheckToken=r,this.authToken=o,this.keepaliveTimer=null,this.frames=null,this.totalFrames=0,this.bytesSent=0,this.bytesReceived=0,this.log_=He(this.connId),this.stats_=fn(s),this.connURL=n.connectionURL_(s,l,a,r,i),this.nodeAdmin=s.nodeAdmin}static connectionURL_(t,s,i,r,o){const l={v:"5"};return!(0,c.$g)()&&typeof location<"u"&&location.hostname&&Ds.test(location.hostname)&&(l.r="f"),s&&(l.s=s),i&&(l.ls=i),r&&(l.ac=r),o&&(l.p=o),Ws(t,Fs,l)}open(t,s){this.onDisconnect=s,this.onMessage=t,this.log_("Websocket connecting to "+this.connURL),this.everConnected_=!1,ge.set("previous_websocket_failure",!0);try{let i;if((0,c.$g)()){i={headers:{"User-Agent":`Firebase/5/${sn}/${process.platform}/${this.nodeAdmin?"AdminNode":"Node"}`,"X-Firebase-GMPID":this.applicationId||""}},this.authToken&&(i.headers.Authorization=`Bearer ${this.authToken}`),this.appCheckToken&&(i.headers["X-Firebase-AppCheck"]=this.appCheckToken);const o=process.env,l=0===this.connURL.indexOf("wss://")?o.HTTPS_PROXY||o.https_proxy:o.HTTP_PROXY||o.http_proxy;l&&(i.proxy={origin:l})}this.mySock=new wt(this.connURL,[],i)}catch(i){this.log_("Error instantiating WebSocket.");const r=i.message||i.data;return r&&this.log_(r),void this.onClosed_()}this.mySock.onopen=()=>{this.log_("Websocket connected."),this.everConnected_=!0},this.mySock.onclose=()=>{this.log_("Websocket connection was disconnected."),this.mySock=null,this.onClosed_()},this.mySock.onmessage=i=>{this.handleIncomingFrame(i)},this.mySock.onerror=i=>{this.log_("WebSocket error.  Closing connection.");const r=i.message||i.data;r&&this.log_(r),this.onClosed_()}}start(){}static forceDisallow(){n.forceDisallow_=!0}static isAvailable(){let t=!1;if(typeof navigator<"u"&&navigator.userAgent){const i=navigator.userAgent.match(/Android ([0-9]{0,}\.[0-9]{0,})/);i&&i.length>1&&parseFloat(i[1])<4.4&&(t=!0)}return!t&&null!==wt&&!n.forceDisallow_}static previouslyFailed(){return ge.isInMemoryStorage||!0===ge.get("previous_websocket_failure")}markConnectionHealthy(){ge.remove("previous_websocket_failure")}appendFrame_(t){if(this.frames.push(t),this.frames.length===this.totalFrames){const s=this.frames.join("");this.frames=null;const i=(0,c.$L)(s);this.onMessage(i)}}handleNewFrameCount_(t){this.totalFrames=t,this.frames=[]}extractFrameCount_(t){if((0,c.vA)(null===this.frames,"We already have a frame buffer"),t.length<=6){const s=Number(t);if(!isNaN(s))return this.handleNewFrameCount_(s),null}return this.handleNewFrameCount_(1),t}handleIncomingFrame(t){if(null===this.mySock)return;const s=t.data;if(this.bytesReceived+=s.length,this.stats_.incrementCounter("bytes_received",s.length),this.resetKeepAlive(),null!==this.frames)this.appendFrame_(s);else{const i=this.extractFrameCount_(s);null!==i&&this.appendFrame_(i)}}send(t){this.resetKeepAlive();const s=(0,c.As)(t);this.bytesSent+=s.length,this.stats_.incrementCounter("bytes_sent",s.length);const i=As(s,16384);i.length>1&&this.sendString_(String(i.length));for(let r=0;r<i.length;r++)this.sendString_(i[r])}shutdown_(){this.isClosed_=!0,this.keepaliveTimer&&(clearInterval(this.keepaliveTimer),this.keepaliveTimer=null),this.mySock&&(this.mySock.close(),this.mySock=null)}onClosed_(){this.isClosed_||(this.log_("WebSocket is closing itself"),this.shutdown_(),this.onDisconnect&&(this.onDisconnect(this.everConnected_),this.onDisconnect=null))}close(){this.isClosed_||(this.log_("WebSocket is being closed"),this.shutdown_())}resetKeepAlive(){clearInterval(this.keepaliveTimer),this.keepaliveTimer=setInterval(()=>{this.mySock&&this.sendString_("0"),this.resetKeepAlive()},Math.floor(45e3))}sendString_(t){try{this.mySock.send(t)}catch(s){this.log_("Exception thrown from WebSocket.send():",s.message||s.data,"Closing connection."),setTimeout(this.onClosed_.bind(this),0)}}}return n.responsesRequiredToBeHealthy=2,n.healthyTimeout=3e4,n})(),Qs=(()=>{class n{constructor(t){this.initTransports_(t)}static get ALL_TRANSPORTS(){return[se,ke]}static get IS_TRANSPORT_INITIALIZED(){return this.globalTransportInitialized_}initTransports_(t){const s=ke&&ke.isAvailable();let i=s&&!ke.previouslyFailed();if(t.webSocketOnly&&(s||O("wss:// URL used, but browser isn't known to support websockets.  Trying anyway."),i=!0),i)this.transports_=[ke];else{const r=this.transports_=[];for(const o of n.ALL_TRANSPORTS)o&&o.isAvailable()&&r.push(o);n.globalTransportInitialized_=!0}}initialTransport(){if(this.transports_.length>0)return this.transports_[0];throw new Error("No transports available")}upgradeTransport(){return this.transports_.length>1?this.transports_[1]:null}}return n.globalTransportInitialized_=!1,n})();class Js{constructor(e,t,s,i,r,o,l,a,u,h){this.id=e,this.repoInfo_=t,this.applicationId_=s,this.appCheckToken_=i,this.authToken_=r,this.onMessage_=o,this.onReady_=l,this.onDisconnect_=a,this.onKill_=u,this.lastSessionId=h,this.connectionCount=0,this.pendingDataMessages=[],this.state_=0,this.log_=He("c:"+this.id+":"),this.transportManager_=new Qs(t),this.log_("Connection created"),this.start_()}start_(){const e=this.transportManager_.initialTransport();this.conn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,null,this.lastSessionId),this.primaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.conn_),s=this.disconnReceiver_(this.conn_);this.tx_=this.conn_,this.rx_=this.conn_,this.secondaryConn_=null,this.isHealthy_=!1,setTimeout(()=>{this.conn_&&this.conn_.open(t,s)},Math.floor(0));const i=e.healthyTimeout||0;i>0&&(this.healthyTimeout_=Ge(()=>{this.healthyTimeout_=null,this.isHealthy_||(this.conn_&&this.conn_.bytesReceived>102400?(this.log_("Connection exceeded healthy timeout but has received "+this.conn_.bytesReceived+" bytes.  Marking connection healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()):this.conn_&&this.conn_.bytesSent>10240?this.log_("Connection exceeded healthy timeout but has sent "+this.conn_.bytesSent+" bytes.  Leaving connection alive."):(this.log_("Closing unhealthy connection after timeout."),this.close()))},Math.floor(i)))}nextTransportId_(){return"c:"+this.id+":"+this.connectionCount++}disconnReceiver_(e){return t=>{e===this.conn_?this.onConnectionLost_(t):e===this.secondaryConn_?(this.log_("Secondary connection lost."),this.onSecondaryConnectionLost_()):this.log_("closing an old connection")}}connReceiver_(e){return t=>{2!==this.state_&&(e===this.rx_?this.onPrimaryMessageReceived_(t):e===this.secondaryConn_?this.onSecondaryMessageReceived_(t):this.log_("message on old connection"))}}sendRequest(e){this.sendData_({t:"d",d:e})}tryCleanupConnection(){this.tx_===this.secondaryConn_&&this.rx_===this.secondaryConn_&&(this.log_("cleaning up and promoting a connection: "+this.secondaryConn_.connId),this.conn_=this.secondaryConn_,this.secondaryConn_=null)}onSecondaryControl_(e){if("t"in e){const t=e.t;"a"===t?this.upgradeIfSecondaryHealthy_():"r"===t?(this.log_("Got a reset on secondary, closing it"),this.secondaryConn_.close(),(this.tx_===this.secondaryConn_||this.rx_===this.secondaryConn_)&&this.close()):"o"===t&&(this.log_("got pong on secondary."),this.secondaryResponsesRequired_--,this.upgradeIfSecondaryHealthy_())}}onSecondaryMessageReceived_(e){const t=Ke("t",e),s=Ke("d",e);if("c"===t)this.onSecondaryControl_(s);else{if("d"!==t)throw new Error("Unknown protocol layer: "+t);this.pendingDataMessages.push(s)}}upgradeIfSecondaryHealthy_(){this.secondaryResponsesRequired_<=0?(this.log_("Secondary connection is healthy."),this.isHealthy_=!0,this.secondaryConn_.markConnectionHealthy(),this.proceedWithUpgrade_()):(this.log_("sending ping on secondary."),this.secondaryConn_.send({t:"c",d:{t:"p",d:{}}}))}proceedWithUpgrade_(){this.secondaryConn_.start(),this.log_("sending client ack on secondary"),this.secondaryConn_.send({t:"c",d:{t:"a",d:{}}}),this.log_("Ending transmission on primary"),this.conn_.send({t:"c",d:{t:"n",d:{}}}),this.tx_=this.secondaryConn_,this.tryCleanupConnection()}onPrimaryMessageReceived_(e){const t=Ke("t",e),s=Ke("d",e);"c"===t?this.onControl_(s):"d"===t&&this.onDataMessage_(s)}onDataMessage_(e){this.onPrimaryResponse_(),this.onMessage_(e)}onPrimaryResponse_(){this.isHealthy_||(this.primaryResponsesRequired_--,this.primaryResponsesRequired_<=0&&(this.log_("Primary connection is healthy."),this.isHealthy_=!0,this.conn_.markConnectionHealthy()))}onControl_(e){const t=Ke("t",e);if("d"in e){const s=e.d;if("h"===t){const i=Object.assign({},s);this.repoInfo_.isUsingEmulator&&(i.h=this.repoInfo_.host),this.onHandshake_(i)}else if("n"===t){this.log_("recvd end transmission on primary"),this.rx_=this.secondaryConn_;for(let i=0;i<this.pendingDataMessages.length;++i)this.onDataMessage_(this.pendingDataMessages[i]);this.pendingDataMessages=[],this.tryCleanupConnection()}else"s"===t?this.onConnectionShutdown_(s):"r"===t?this.onReset_(s):"e"===t?ln("Server Error: "+s):"o"===t?(this.log_("got pong on primary."),this.onPrimaryResponse_(),this.sendPingOnPrimaryIfNecessary_()):ln("Unknown control packet command: "+t)}}onHandshake_(e){const t=e.ts,s=e.v,i=e.h;this.sessionId=e.s,this.repoInfo_.host=i,0===this.state_&&(this.conn_.start(),this.onConnectionEstablished_(this.conn_,t),"5"!==s&&O("Protocol version mismatch detected"),this.tryStartUpgrade_())}tryStartUpgrade_(){const e=this.transportManager_.upgradeTransport();e&&this.startUpgrade_(e)}startUpgrade_(e){this.secondaryConn_=new e(this.nextTransportId_(),this.repoInfo_,this.applicationId_,this.appCheckToken_,this.authToken_,this.sessionId),this.secondaryResponsesRequired_=e.responsesRequiredToBeHealthy||0;const t=this.connReceiver_(this.secondaryConn_),s=this.disconnReceiver_(this.secondaryConn_);this.secondaryConn_.open(t,s),Ge(()=>{this.secondaryConn_&&(this.log_("Timed out trying to upgrade."),this.secondaryConn_.close())},Math.floor(6e4))}onReset_(e){this.log_("Reset packet received.  New host: "+e),this.repoInfo_.host=e,1===this.state_?this.close():(this.closeConnections_(),this.start_())}onConnectionEstablished_(e,t){this.log_("Realtime connection established."),this.conn_=e,this.state_=1,this.onReady_&&(this.onReady_(t,this.sessionId),this.onReady_=null),0===this.primaryResponsesRequired_?(this.log_("Primary connection is healthy."),this.isHealthy_=!0):Ge(()=>{this.sendPingOnPrimaryIfNecessary_()},Math.floor(5e3))}sendPingOnPrimaryIfNecessary_(){!this.isHealthy_&&1===this.state_&&(this.log_("sending ping on primary."),this.sendData_({t:"c",d:{t:"p",d:{}}}))}onSecondaryConnectionLost_(){const e=this.secondaryConn_;this.secondaryConn_=null,(this.tx_===e||this.rx_===e)&&this.close()}onConnectionLost_(e){this.conn_=null,e||0!==this.state_?1===this.state_&&this.log_("Realtime connection lost."):(this.log_("Realtime connection failed."),this.repoInfo_.isCacheableHost()&&(ge.remove("host:"+this.repoInfo_.host),this.repoInfo_.internalHost=this.repoInfo_.host)),this.close()}onConnectionShutdown_(e){this.log_("Connection shutdown command received. Shutting down..."),this.onKill_&&(this.onKill_(e),this.onKill_=null),this.onDisconnect_=null,this.close()}sendData_(e){if(1!==this.state_)throw"Connection is not connected";this.tx_.send(e)}close(){2!==this.state_&&(this.log_("Closing realtime connection."),this.state_=2,this.closeConnections_(),this.onDisconnect_&&(this.onDisconnect_(),this.onDisconnect_=null))}closeConnections_(){this.log_("Shutting down all connections"),this.conn_&&(this.conn_.close(),this.conn_=null),this.secondaryConn_&&(this.secondaryConn_.close(),this.secondaryConn_=null),this.healthyTimeout_&&(clearTimeout(this.healthyTimeout_),this.healthyTimeout_=null)}}class Zs{put(e,t,s,i){}merge(e,t,s,i){}refreshAuthToken(e){}refreshAppCheckToken(e){}onDisconnectPut(e,t,s){}onDisconnectMerge(e,t,s){}onDisconnectCancel(e,t){}reportStats(e){}}class ei{constructor(e){this.allowedEvents_=e,this.listeners_={},(0,c.vA)(Array.isArray(e)&&e.length>0,"Requires a non-empty array")}trigger(e,...t){if(Array.isArray(this.listeners_[e])){const s=[...this.listeners_[e]];for(let i=0;i<s.length;i++)s[i].callback.apply(s[i].context,t)}}on(e,t,s){this.validateEventType_(e),this.listeners_[e]=this.listeners_[e]||[],this.listeners_[e].push({callback:t,context:s});const i=this.getInitialEvent(e);i&&t.apply(s,i)}off(e,t,s){this.validateEventType_(e);const i=this.listeners_[e]||[];for(let r=0;r<i.length;r++)if(i[r].callback===t&&(!s||s===i[r].context))return void i.splice(r,1)}validateEventType_(e){(0,c.vA)(this.allowedEvents_.find(t=>t===e),"Unknown event: "+e)}}class Et extends ei{constructor(){super(["online"]),this.online_=!0,typeof window<"u"&&typeof window.addEventListener<"u"&&!(0,c.jZ)()&&(window.addEventListener("online",()=>{this.online_||(this.online_=!0,this.trigger("online",!0))},!1),window.addEventListener("offline",()=>{this.online_&&(this.online_=!1,this.trigger("online",!1))},!1))}static getInstance(){return new Et}getInitialEvent(e){return(0,c.vA)("online"===e,"Unknown event type: "+e),[this.online_]}currentlyOnline(){return this.online_}}class I{constructor(e,t){if(void 0===t){this.pieces_=e.split("/");let s=0;for(let i=0;i<this.pieces_.length;i++)this.pieces_[i].length>0&&(this.pieces_[s]=this.pieces_[i],s++);this.pieces_.length=s,this.pieceNum_=0}else this.pieces_=e,this.pieceNum_=t}toString(){let e="";for(let t=this.pieceNum_;t<this.pieces_.length;t++)""!==this.pieces_[t]&&(e+="/"+this.pieces_[t]);return e||"/"}}function T(){return new I("")}function y(n){return n.pieceNum_>=n.pieces_.length?null:n.pieces_[n.pieceNum_]}function ie(n){return n.pieces_.length-n.pieceNum_}function S(n){let e=n.pieceNum_;return e<n.pieces_.length&&e++,new I(n.pieces_,e)}function gn(n){return n.pieceNum_<n.pieces_.length?n.pieces_[n.pieces_.length-1]:null}function Ye(n,e=0){return n.pieces_.slice(n.pieceNum_+e)}function si(n){if(n.pieceNum_>=n.pieces_.length)return null;const e=[];for(let t=n.pieceNum_;t<n.pieces_.length-1;t++)e.push(n.pieces_[t]);return new I(e,0)}function N(n,e){const t=[];for(let s=n.pieceNum_;s<n.pieces_.length;s++)t.push(n.pieces_[s]);if(e instanceof I)for(let s=e.pieceNum_;s<e.pieces_.length;s++)t.push(e.pieces_[s]);else{const s=e.split("/");for(let i=0;i<s.length;i++)s[i].length>0&&t.push(s[i])}return new I(t,0)}function v(n){return n.pieceNum_>=n.pieces_.length}function M(n,e){const t=y(n),s=y(e);if(null===t)return e;if(t===s)return M(S(n),S(e));throw new Error("INTERNAL ERROR: innerPath ("+e+") is not within outerPath ("+n+")")}function Uo(n,e){const t=Ye(n,0),s=Ye(e,0);for(let i=0;i<t.length&&i<s.length;i++){const r=ye(t[i],s[i]);if(0!==r)return r}return t.length===s.length?0:t.length<s.length?-1:1}function mn(n,e){if(ie(n)!==ie(e))return!1;for(let t=n.pieceNum_,s=e.pieceNum_;t<=n.pieces_.length;t++,s++)if(n.pieces_[t]!==e.pieces_[s])return!1;return!0}function V(n,e){let t=n.pieceNum_,s=e.pieceNum_;if(ie(n)>ie(e))return!1;for(;t<n.pieces_.length;){if(n.pieces_[t]!==e.pieces_[s])return!1;++t,++s}return!0}class Vo{constructor(e,t){this.errorPrefix_=t,this.parts_=Ye(e,0),this.byteLength_=Math.max(1,this.parts_.length);for(let s=0;s<this.parts_.length;s++)this.byteLength_+=(0,c.OE)(this.parts_[s]);ii(this)}}function ii(n){if(n.byteLength_>768)throw new Error(n.errorPrefix_+"has a key path longer than 768 bytes ("+n.byteLength_+").");if(n.parts_.length>32)throw new Error(n.errorPrefix_+"path specified exceeds the maximum depth that can be written (32) or object contains a cycle "+ve(n))}function ve(n){return 0===n.parts_.length?"":"in property '"+n.parts_.join(".")+"'"}class yn extends ei{constructor(){let e,t;super(["visible"]),typeof document<"u"&&typeof document.addEventListener<"u"&&(typeof document.hidden<"u"?(t="visibilitychange",e="hidden"):typeof document.mozHidden<"u"?(t="mozvisibilitychange",e="mozHidden"):typeof document.msHidden<"u"?(t="msvisibilitychange",e="msHidden"):typeof document.webkitHidden<"u"&&(t="webkitvisibilitychange",e="webkitHidden")),this.visible_=!0,t&&document.addEventListener(t,()=>{const s=!document[e];s!==this.visible_&&(this.visible_=s,this.trigger("visible",s))},!1)}static getInstance(){return new yn}getInitialEvent(e){return(0,c.vA)("visible"===e,"Unknown event type: "+e),[this.visible_]}}const je=1e3;let It,Ce=(()=>{class n extends Zs{constructor(t,s,i,r,o,l,a,u){if(super(),this.repoInfo_=t,this.applicationId_=s,this.onDataUpdate_=i,this.onConnectStatus_=r,this.onServerInfoUpdate_=o,this.authTokenProvider_=l,this.appCheckTokenProvider_=a,this.authOverride_=u,this.id=n.nextPersistentConnectionId_++,this.log_=He("p:"+this.id+":"),this.interruptReasons_={},this.listens=new Map,this.outstandingPuts_=[],this.outstandingGets_=[],this.outstandingPutCount_=0,this.outstandingGetCount_=0,this.onDisconnectRequestQueue_=[],this.connected_=!1,this.reconnectDelay_=je,this.maxReconnectDelay_=3e5,this.securityDebugCallback_=null,this.lastSessionId=null,this.establishConnectionTimer_=null,this.visible_=!1,this.requestCBHash_={},this.requestNumber_=0,this.realtime_=null,this.authToken_=null,this.appCheckToken_=null,this.forceTokenRefresh_=!1,this.invalidAuthTokenCount_=0,this.invalidAppCheckTokenCount_=0,this.firstConnection_=!0,this.lastConnectionAttemptTime_=null,this.lastConnectionEstablishedTime_=null,u&&!(0,c.$g)())throw new Error("Auth override specified in options, but not supported on non Node.js platforms");yn.getInstance().on("visible",this.onVisible_,this),-1===t.host.indexOf("fblocal")&&Et.getInstance().on("online",this.onOnline_,this)}sendRequest(t,s,i){const r=++this.requestNumber_,o={r,a:t,b:s};this.log_((0,c.As)(o)),(0,c.vA)(this.connected_,"sendRequest call when we're not connected not allowed."),this.realtime_.sendRequest(o),i&&(this.requestCBHash_[r]=i)}get(t){this.initConnection_();const s=new c.cY,r={action:"g",request:{p:t._path.toString(),q:t._queryObject},onComplete:l=>{const a=l.d;"ok"===l.s?s.resolve(a):s.reject(a)}};return this.outstandingGets_.push(r),this.outstandingGetCount_++,this.connected_&&this.sendGet_(this.outstandingGets_.length-1),s.promise}listen(t,s,i,r){this.initConnection_();const o=t._queryIdentifier,l=t._path.toString();this.log_("Listen called for "+l+" "+o),this.listens.has(l)||this.listens.set(l,new Map),(0,c.vA)(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"listen() called for non-default but complete query"),(0,c.vA)(!this.listens.get(l).has(o),"listen() called twice for same path/queryId.");const a={onComplete:r,hashFn:s,query:t,tag:i};this.listens.get(l).set(o,a),this.connected_&&this.sendListen_(a)}sendGet_(t){const s=this.outstandingGets_[t];this.sendRequest("g",s.request,i=>{delete this.outstandingGets_[t],this.outstandingGetCount_--,0===this.outstandingGetCount_&&(this.outstandingGets_=[]),s.onComplete&&s.onComplete(i)})}sendListen_(t){const s=t.query,i=s._path.toString(),r=s._queryIdentifier;this.log_("Listen on "+i+" for "+r);const o={p:i};t.tag&&(o.q=s._queryObject,o.t=t.tag),o.h=t.hashFn(),this.sendRequest("q",o,a=>{const u=a.d,h=a.s;n.warnOnListenWarnings_(u,s),(this.listens.get(i)&&this.listens.get(i).get(r))===t&&(this.log_("listen response",a),"ok"!==h&&this.removeListen_(i,r),t.onComplete&&t.onComplete(h,u))})}static warnOnListenWarnings_(t,s){if(t&&"object"==typeof t&&(0,c.gR)(t,"w")){const i=(0,c.yw)(t,"w");if(Array.isArray(i)&&~i.indexOf("no_index")){const r='".indexOn": "'+s._queryParams.getIndex().toString()+'"',o=s._path.toString();O(`Using an unspecified index. Your data will be downloaded and filtered on the client. Consider adding ${r} at ${o} to your security rules for better performance.`)}}}refreshAuthToken(t){this.authToken_=t,this.log_("Auth token refreshed"),this.authToken_?this.tryAuth():this.connected_&&this.sendRequest("unauth",{},()=>{}),this.reduceReconnectDelayIfAdminCredential_(t)}reduceReconnectDelayIfAdminCredential_(t){(t&&40===t.length||(0,c.qc)(t))&&(this.log_("Admin auth credential detected.  Reducing max reconnect time."),this.maxReconnectDelay_=3e4)}refreshAppCheckToken(t){this.appCheckToken_=t,this.log_("App check token refreshed"),this.appCheckToken_?this.tryAppCheck():this.connected_&&this.sendRequest("unappeck",{},()=>{})}tryAuth(){if(this.connected_&&this.authToken_){const t=this.authToken_,s=(0,c.Cv)(t)?"auth":"gauth",i={cred:t};null===this.authOverride_?i.noauth=!0:"object"==typeof this.authOverride_&&(i.authvar=this.authOverride_),this.sendRequest(s,i,r=>{const o=r.s,l=r.d||"error";this.authToken_===t&&("ok"===o?this.invalidAuthTokenCount_=0:this.onAuthRevoked_(o,l))})}}tryAppCheck(){this.connected_&&this.appCheckToken_&&this.sendRequest("appcheck",{token:this.appCheckToken_},t=>{const s=t.s,i=t.d||"error";"ok"===s?this.invalidAppCheckTokenCount_=0:this.onAppCheckRevoked_(s,i)})}unlisten(t,s){const i=t._path.toString(),r=t._queryIdentifier;this.log_("Unlisten called for "+i+" "+r),(0,c.vA)(t._queryParams.isDefault()||!t._queryParams.loadsAllData(),"unlisten() called for non-default but complete query"),this.removeListen_(i,r)&&this.connected_&&this.sendUnlisten_(i,r,t._queryObject,s)}sendUnlisten_(t,s,i,r){this.log_("Unlisten on "+t+" for "+s);const o={p:t};r&&(o.q=i,o.t=r),this.sendRequest("n",o)}onDisconnectPut(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("o",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"o",data:s,onComplete:i})}onDisconnectMerge(t,s,i){this.initConnection_(),this.connected_?this.sendOnDisconnect_("om",t,s,i):this.onDisconnectRequestQueue_.push({pathString:t,action:"om",data:s,onComplete:i})}onDisconnectCancel(t,s){this.initConnection_(),this.connected_?this.sendOnDisconnect_("oc",t,null,s):this.onDisconnectRequestQueue_.push({pathString:t,action:"oc",data:null,onComplete:s})}sendOnDisconnect_(t,s,i,r){const o={p:s,d:i};this.log_("onDisconnect "+t,o),this.sendRequest(t,o,l=>{r&&setTimeout(()=>{r(l.s,l.d)},Math.floor(0))})}put(t,s,i,r){this.putInternal("p",t,s,i,r)}merge(t,s,i,r){this.putInternal("m",t,s,i,r)}putInternal(t,s,i,r,o){this.initConnection_();const l={p:s,d:i};void 0!==o&&(l.h=o),this.outstandingPuts_.push({action:t,request:l,onComplete:r}),this.outstandingPutCount_++,this.connected_?this.sendPut_(this.outstandingPuts_.length-1):this.log_("Buffering put: "+s)}sendPut_(t){const s=this.outstandingPuts_[t].action,i=this.outstandingPuts_[t].request,r=this.outstandingPuts_[t].onComplete;this.outstandingPuts_[t].queued=this.connected_,this.sendRequest(s,i,o=>{this.log_(s+" response",o),delete this.outstandingPuts_[t],this.outstandingPutCount_--,0===this.outstandingPutCount_&&(this.outstandingPuts_=[]),r&&r(o.s,o.d)})}reportStats(t){if(this.connected_){const s={c:t};this.log_("reportStats",s),this.sendRequest("s",s,i=>{"ok"!==i.s&&this.log_("reportStats","Error sending stats: "+i.d)})}}onDataMessage_(t){if("r"in t){this.log_("from server: "+(0,c.As)(t));const s=t.r,i=this.requestCBHash_[s];i&&(delete this.requestCBHash_[s],i(t.b))}else{if("error"in t)throw"A server-side error has occurred: "+t.error;"a"in t&&this.onDataPush_(t.a,t.b)}}onDataPush_(t,s){this.log_("handleServerMessage",t,s),"d"===t?this.onDataUpdate_(s.p,s.d,!1,s.t):"m"===t?this.onDataUpdate_(s.p,s.d,!0,s.t):"c"===t?this.onListenRevoked_(s.p,s.q):"ac"===t?this.onAuthRevoked_(s.s,s.d):"apc"===t?this.onAppCheckRevoked_(s.s,s.d):"sd"===t?this.onSecurityDebugPacket_(s):ln("Unrecognized action received from server: "+(0,c.As)(t)+"\nAre you using the latest client?")}onReady_(t,s){this.log_("connection ready"),this.connected_=!0,this.lastConnectionEstablishedTime_=(new Date).getTime(),this.handleTimestamp_(t),this.lastSessionId=s,this.firstConnection_&&this.sendConnectStats_(),this.restoreState_(),this.firstConnection_=!1,this.onConnectStatus_(!0)}scheduleConnect_(t){(0,c.vA)(!this.realtime_,"Scheduling a connect when we're already connected/ing?"),this.establishConnectionTimer_&&clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=setTimeout(()=>{this.establishConnectionTimer_=null,this.establishConnection_()},Math.floor(t))}initConnection_(){!this.realtime_&&this.firstConnection_&&this.scheduleConnect_(0)}onVisible_(t){t&&!this.visible_&&this.reconnectDelay_===this.maxReconnectDelay_&&(this.log_("Window became visible.  Reducing delay."),this.reconnectDelay_=je,this.realtime_||this.scheduleConnect_(0)),this.visible_=t}onOnline_(t){t?(this.log_("Browser went online."),this.reconnectDelay_=je,this.realtime_||this.scheduleConnect_(0)):(this.log_("Browser went offline.  Killing connection."),this.realtime_&&this.realtime_.close())}onRealtimeDisconnect_(){if(this.log_("data client disconnected"),this.connected_=!1,this.realtime_=null,this.cancelSentTransactions_(),this.requestCBHash_={},this.shouldReconnect_()){this.visible_?this.lastConnectionEstablishedTime_&&((new Date).getTime()-this.lastConnectionEstablishedTime_>3e4&&(this.reconnectDelay_=je),this.lastConnectionEstablishedTime_=null):(this.log_("Window isn't visible.  Delaying reconnect."),this.reconnectDelay_=this.maxReconnectDelay_,this.lastConnectionAttemptTime_=(new Date).getTime());const t=(new Date).getTime()-this.lastConnectionAttemptTime_;let s=Math.max(0,this.reconnectDelay_-t);s=Math.random()*s,this.log_("Trying to reconnect in "+s+"ms"),this.scheduleConnect_(s),this.reconnectDelay_=Math.min(this.maxReconnectDelay_,1.3*this.reconnectDelay_)}this.onConnectStatus_(!1)}establishConnection_(){var t=this;return(0,Jr.A)(function*(){if(t.shouldReconnect_()){t.log_("Making a connection attempt"),t.lastConnectionAttemptTime_=(new Date).getTime(),t.lastConnectionEstablishedTime_=null;const s=t.onDataMessage_.bind(t),i=t.onReady_.bind(t),r=t.onRealtimeDisconnect_.bind(t),o=t.id+":"+n.nextConnectionId_++,l=t.lastSessionId;let a=!1,u=null;const h=function(){u?u.close():(a=!0,r())};t.realtime_={close:h,sendRequest:function(_){(0,c.vA)(u,"sendRequest call when we're not connected not allowed."),u.sendRequest(_)}};const f=t.forceTokenRefresh_;t.forceTokenRefresh_=!1;try{const[_,p]=yield Promise.all([t.authTokenProvider_.getToken(f),t.appCheckTokenProvider_.getToken(f)]);a?k("getToken() completed but was canceled"):(k("getToken() completed. Creating connection."),t.authToken_=_&&_.accessToken,t.appCheckToken_=p&&p.token,u=new Js(o,t.repoInfo_,t.applicationId_,t.appCheckToken_,t.authToken_,s,i,r,E=>{O(E+" ("+t.repoInfo_.toString()+")"),t.interrupt("server_kill")},l))}catch(_){t.log_("Failed to get token: "+_),a||(t.repoInfo_.nodeAdmin&&O(_),h())}}})()}interrupt(t){k("Interrupting connection for reason: "+t),this.interruptReasons_[t]=!0,this.realtime_?this.realtime_.close():(this.establishConnectionTimer_&&(clearTimeout(this.establishConnectionTimer_),this.establishConnectionTimer_=null),this.connected_&&this.onRealtimeDisconnect_())}resume(t){k("Resuming connection for reason: "+t),delete this.interruptReasons_[t],(0,c.Im)(this.interruptReasons_)&&(this.reconnectDelay_=je,this.realtime_||this.scheduleConnect_(0))}handleTimestamp_(t){const s=t-(new Date).getTime();this.onServerInfoUpdate_({serverTimeOffset:s})}cancelSentTransactions_(){for(let t=0;t<this.outstandingPuts_.length;t++){const s=this.outstandingPuts_[t];s&&"h"in s.request&&s.queued&&(s.onComplete&&s.onComplete("disconnect"),delete this.outstandingPuts_[t],this.outstandingPutCount_--)}0===this.outstandingPutCount_&&(this.outstandingPuts_=[])}onListenRevoked_(t,s){let i;i=s?s.map(o=>an(o)).join("$"):"default";const r=this.removeListen_(t,i);r&&r.onComplete&&r.onComplete("permission_denied")}removeListen_(t,s){const i=new I(t).toString();let r;if(this.listens.has(i)){const o=this.listens.get(i);r=o.get(s),o.delete(s),0===o.size&&this.listens.delete(i)}else r=void 0;return r}onAuthRevoked_(t,s){k("Auth token revoked: "+t+"/"+s),this.authToken_=null,this.forceTokenRefresh_=!0,this.realtime_.close(),("invalid_token"===t||"permission_denied"===t)&&(this.invalidAuthTokenCount_++,this.invalidAuthTokenCount_>=3&&(this.reconnectDelay_=3e4,this.authTokenProvider_.notifyForInvalidToken()))}onAppCheckRevoked_(t,s){k("App check token revoked: "+t+"/"+s),this.appCheckToken_=null,this.forceTokenRefresh_=!0,("invalid_token"===t||"permission_denied"===t)&&(this.invalidAppCheckTokenCount_++,this.invalidAppCheckTokenCount_>=3&&this.appCheckTokenProvider_.notifyForInvalidToken())}onSecurityDebugPacket_(t){this.securityDebugCallback_?this.securityDebugCallback_(t):"msg"in t&&console.log("FIREBASE: "+t.msg.replace("\n","\nFIREBASE: "))}restoreState_(){this.tryAuth(),this.tryAppCheck();for(const t of this.listens.values())for(const s of t.values())this.sendListen_(s);for(let t=0;t<this.outstandingPuts_.length;t++)this.outstandingPuts_[t]&&this.sendPut_(t);for(;this.onDisconnectRequestQueue_.length;){const t=this.onDisconnectRequestQueue_.shift();this.sendOnDisconnect_(t.action,t.pathString,t.data,t.onComplete)}for(let t=0;t<this.outstandingGets_.length;t++)this.outstandingGets_[t]&&this.sendGet_(t)}sendConnectStats_(){const t={};let s="js";(0,c.$g)()&&(s=this.repoInfo_.nodeAdmin?"admin_node":"node"),t["sdk."+s+"."+sn.replace(/\./g,"-")]=1,(0,c.jZ)()?t["framework.cordova"]=1:(0,c.lV)()&&(t["framework.reactnative"]=1),this.reportStats(t)}shouldReconnect_(){const t=Et.getInstance().currentlyOnline();return(0,c.Im)(this.interruptReasons_)&&t}}return n.nextPersistentConnectionId_=0,n.nextConnectionId_=0,n})();class C{constructor(e,t){this.name=e,this.node=t}static Wrap(e,t){return new C(e,t)}}class Tt{getCompare(){return this.compare.bind(this)}indexedValueChanged(e,t){const s=new C(ne,e),i=new C(ne,t);return 0!==this.compare(s,i)}minPost(){return C.MIN}}class li extends Tt{static get __EMPTY_NODE(){return It}static set __EMPTY_NODE(e){It=e}compare(e,t){return ye(e.name,t.name)}isDefinedOn(e){throw(0,c.Hk)("KeyIndex.isDefinedOn not expected to be called.")}indexedValueChanged(e,t){return!1}minPost(){return C.MIN}maxPost(){return new C(J,It)}makePost(e,t){return(0,c.vA)("string"==typeof e,"KeyIndex indexValue must always be a string."),new C(e,It)}toString(){return".key"}}const z=new li;class St{constructor(e,t,s,i,r=null){this.isReverse_=i,this.resultGenerator_=r,this.nodeStack_=[];let o=1;for(;!e.isEmpty();)if(o=t?s(e.key,t):1,i&&(o*=-1),o<0)e=this.isReverse_?e.left:e.right;else{if(0===o){this.nodeStack_.push(e);break}this.nodeStack_.push(e),e=this.isReverse_?e.right:e.left}}getNext(){if(0===this.nodeStack_.length)return null;let t,e=this.nodeStack_.pop();if(t=this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value},this.isReverse_)for(e=e.left;!e.isEmpty();)this.nodeStack_.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack_.push(e),e=e.left;return t}hasNext(){return this.nodeStack_.length>0}peek(){if(0===this.nodeStack_.length)return null;const e=this.nodeStack_[this.nodeStack_.length-1];return this.resultGenerator_?this.resultGenerator_(e.key,e.value):{key:e.key,value:e.value}}}let Cn,G=(()=>{class n{constructor(t,s,i,r,o){this.key=t,this.value=s,this.color=null!=i?i:n.RED,this.left=null!=r?r:F.EMPTY_NODE,this.right=null!=o?o:F.EMPTY_NODE}copy(t,s,i,r,o){return new n(null!=t?t:this.key,null!=s?s:this.value,null!=i?i:this.color,null!=r?r:this.left,null!=o?o:this.right)}count(){return this.left.count()+1+this.right.count()}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||!!t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min_(){return this.left.isEmpty()?this:this.left.min_()}minKey(){return this.min_().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,s,i){let r=this;const o=i(t,r.key);return r=o<0?r.copy(null,null,null,r.left.insert(t,s,i),null):0===o?r.copy(null,s,null,null,null):r.copy(null,null,null,null,r.right.insert(t,s,i)),r.fixUp_()}removeMin_(){if(this.left.isEmpty())return F.EMPTY_NODE;let t=this;return!t.left.isRed_()&&!t.left.left.isRed_()&&(t=t.moveRedLeft_()),t=t.copy(null,null,null,t.left.removeMin_(),null),t.fixUp_()}remove(t,s){let i,r;if(i=this,s(t,i.key)<0)!i.left.isEmpty()&&!i.left.isRed_()&&!i.left.left.isRed_()&&(i=i.moveRedLeft_()),i=i.copy(null,null,null,i.left.remove(t,s),null);else{if(i.left.isRed_()&&(i=i.rotateRight_()),!i.right.isEmpty()&&!i.right.isRed_()&&!i.right.left.isRed_()&&(i=i.moveRedRight_()),0===s(t,i.key)){if(i.right.isEmpty())return F.EMPTY_NODE;r=i.right.min_(),i=i.copy(r.key,r.value,null,null,i.right.removeMin_())}i=i.copy(null,null,null,null,i.right.remove(t,s))}return i.fixUp_()}isRed_(){return this.color}fixUp_(){let t=this;return t.right.isRed_()&&!t.left.isRed_()&&(t=t.rotateLeft_()),t.left.isRed_()&&t.left.left.isRed_()&&(t=t.rotateRight_()),t.left.isRed_()&&t.right.isRed_()&&(t=t.colorFlip_()),t}moveRedLeft_(){let t=this.colorFlip_();return t.right.left.isRed_()&&(t=t.copy(null,null,null,null,t.right.rotateRight_()),t=t.rotateLeft_(),t=t.colorFlip_()),t}moveRedRight_(){let t=this.colorFlip_();return t.left.left.isRed_()&&(t=t.rotateRight_(),t=t.colorFlip_()),t}rotateLeft_(){const t=this.copy(null,null,n.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight_(){const t=this.copy(null,null,n.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip_(){const t=this.left.copy(null,null,!this.left.color,null,null),s=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,s)}checkMaxDepth_(){const t=this.check_();return Math.pow(2,t)<=this.count()+1}check_(){if(this.isRed_()&&this.left.isRed_())throw new Error("Red node has red child("+this.key+","+this.value+")");if(this.right.isRed_())throw new Error("Right child of ("+this.key+","+this.value+") is red");const t=this.left.check_();if(t!==this.right.check_())throw new Error("Black depths differ");return t+(this.isRed_()?0:1)}}return n.RED=!0,n.BLACK=!1,n})();class F{constructor(e,t=F.EMPTY_NODE){this.comparator_=e,this.root_=t}insert(e,t){return new F(this.comparator_,this.root_.insert(e,t,this.comparator_).copy(null,null,G.BLACK,null,null))}remove(e){return new F(this.comparator_,this.root_.remove(e,this.comparator_).copy(null,null,G.BLACK,null,null))}get(e){let t,s=this.root_;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),0===t)return s.value;t<0?s=s.left:t>0&&(s=s.right)}return null}getPredecessorKey(e){let t,s=this.root_,i=null;for(;!s.isEmpty();){if(t=this.comparator_(e,s.key),0===t){if(s.left.isEmpty())return i?i.key:null;for(s=s.left;!s.right.isEmpty();)s=s.right;return s.key}t<0?s=s.left:t>0&&(i=s,s=s.right)}throw new Error("Attempted to find predecessor key for a nonexistent key.  What gives?")}isEmpty(){return this.root_.isEmpty()}count(){return this.root_.count()}minKey(){return this.root_.minKey()}maxKey(){return this.root_.maxKey()}inorderTraversal(e){return this.root_.inorderTraversal(e)}reverseTraversal(e){return this.root_.reverseTraversal(e)}getIterator(e){return new St(this.root_,null,this.comparator_,!1,e)}getIteratorFrom(e,t){return new St(this.root_,e,this.comparator_,!1,t)}getReverseIteratorFrom(e,t){return new St(this.root_,e,this.comparator_,!0,t)}getReverseIterator(e){return new St(this.root_,null,this.comparator_,!0,e)}}function $o(n,e){return ye(n.name,e.name)}function vn(n,e){return ye(n,e)}F.EMPTY_NODE=new class jo{copy(e,t,s,i,r){return this}insert(e,t,s){return new G(e,t,null)}remove(e,t){return this}count(){return 0}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}check_(){return 0}isRed_(){return!1}};const ai=function(n){return"number"==typeof n?"number:"+bs(n):"string:"+n},ci=function(n){if(n.isLeafNode()){const e=n.val();(0,c.vA)("string"==typeof e||"number"==typeof e||"object"==typeof e&&(0,c.gR)(e,".sv"),"Priority must be a string or number.")}else(0,c.vA)(n===Cn||n.isEmpty(),"priority of unexpected type.");(0,c.vA)(n===Cn||n.getPriority().isEmpty(),"Priority nodes can't have a priority of their own.")};let ui,hi,di,xe=(()=>{class n{constructor(t,s=n.__childrenNodeConstructor.EMPTY_NODE){this.value_=t,this.priorityNode_=s,this.lazyHash_=null,(0,c.vA)(null!=this.value_,"LeafNode shouldn't be created with null/undefined value."),ci(this.priorityNode_)}static set __childrenNodeConstructor(t){ui=t}static get __childrenNodeConstructor(){return ui}isLeafNode(){return!0}getPriority(){return this.priorityNode_}updatePriority(t){return new n(this.value_,t)}getImmediateChild(t){return".priority"===t?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}getChild(t){return v(t)?this:".priority"===y(t)?this.priorityNode_:n.__childrenNodeConstructor.EMPTY_NODE}hasChild(){return!1}getPredecessorChildName(t,s){return null}updateImmediateChild(t,s){return".priority"===t?this.updatePriority(s):s.isEmpty()&&".priority"!==t?this:n.__childrenNodeConstructor.EMPTY_NODE.updateImmediateChild(t,s).updatePriority(this.priorityNode_)}updateChild(t,s){const i=y(t);return null===i?s:s.isEmpty()&&".priority"!==i?this:((0,c.vA)(".priority"!==i||1===ie(t),".priority must be the last token in a path"),this.updateImmediateChild(i,n.__childrenNodeConstructor.EMPTY_NODE.updateChild(S(t),s)))}isEmpty(){return!1}numChildren(){return 0}forEachChild(t,s){return!1}val(t){return t&&!this.getPriority().isEmpty()?{".value":this.getValue(),".priority":this.getPriority().val()}:this.getValue()}hash(){if(null===this.lazyHash_){let t="";this.priorityNode_.isEmpty()||(t+="priority:"+ai(this.priorityNode_.val())+":");const s=typeof this.value_;t+=s+":",t+="number"===s?bs(this.value_):this.value_,this.lazyHash_=Ts(t)}return this.lazyHash_}getValue(){return this.value_}compareTo(t){return t===n.__childrenNodeConstructor.EMPTY_NODE?1:t instanceof n.__childrenNodeConstructor?-1:((0,c.vA)(t.isLeafNode(),"Unknown node type"),this.compareToLeafNode_(t))}compareToLeafNode_(t){const s=typeof t.value_,i=typeof this.value_,r=n.VALUE_TYPE_ORDER.indexOf(s),o=n.VALUE_TYPE_ORDER.indexOf(i);return(0,c.vA)(r>=0,"Unknown leaf type: "+s),(0,c.vA)(o>=0,"Unknown leaf type: "+i),r===o?"object"===i?0:this.value_<t.value_?-1:this.value_===t.value_?0:1:o-r}withIndex(){return this}isIndexed(){return!0}equals(t){return t===this||!!t.isLeafNode()&&(this.value_===t.value_&&this.priorityNode_.equals(t.priorityNode_))}}return n.VALUE_TYPE_ORDER=["object","boolean","number","string"],n})();const A=new class Jo extends Tt{compare(e,t){const s=e.node.getPriority(),i=t.node.getPriority(),r=s.compareTo(i);return 0===r?ye(e.name,t.name):r}isDefinedOn(e){return!e.getPriority().isEmpty()}indexedValueChanged(e,t){return!e.getPriority().equals(t.getPriority())}minPost(){return C.MIN}maxPost(){return new C(J,new xe("[PRIORITY-POST]",di))}makePost(e,t){const s=hi(e);return new C(t,new xe("[PRIORITY-POST]",s))}toString(){return".priority"}},Zo=Math.log(2);class el{constructor(e){this.count=parseInt(Math.log(e+1)/Zo,10),this.current_=this.count-1;const i=(r=>parseInt(Array(this.count+1).join("1"),2))();this.bits_=e+1&i}nextBitIsOne(){const e=!(this.bits_&1<<this.current_);return this.current_--,e}}const At=function(n,e,t,s){n.sort(e);const i=function(a,u){const h=u-a;let d,f;if(0===h)return null;if(1===h)return d=n[a],f=t?t(d):d,new G(f,d.node,G.BLACK,null,null);{const _=parseInt(h/2,10)+a,p=i(a,_),E=i(_+1,u);return d=n[_],f=t?t(d):d,new G(f,d.node,G.BLACK,p,E)}},l=function(a){let u=null,h=null,d=n.length;const f=function(p,E){const P=d-p,be=d;d-=p;const fe=i(P+1,be),_e=n[P],en=t?t(_e):_e;_(new G(en,_e.node,E,null,fe))},_=function(p){u?(u.left=p,u=p):(h=p,u=p)};for(let p=0;p<a.count;++p){const E=a.nextBitIsOne(),P=Math.pow(2,a.count-(p+1));E?f(P,G.BLACK):(f(P,G.BLACK),f(P,G.RED))}return h}(new el(n.length));return new F(s||e,l)};let wn;const De={};class Z{constructor(e,t){this.indexes_=e,this.indexSet_=t}static get Default(){return(0,c.vA)(De&&A,"ChildrenNode.ts has not been loaded"),wn=wn||new Z({".priority":De},{".priority":A}),wn}get(e){const t=(0,c.yw)(this.indexes_,e);if(!t)throw new Error("No index defined for "+e);return t instanceof F?t:null}hasIndex(e){return(0,c.gR)(this.indexSet_,e.toString())}addIndex(e,t){(0,c.vA)(e!==z,"KeyIndex always exists and isn't meant to be added to the IndexMap.");const s=[];let i=!1;const r=t.getIterator(C.Wrap);let l,o=r.getNext();for(;o;)i=i||e.isDefinedOn(o.node),s.push(o),o=r.getNext();l=i?At(s,e.getCompare()):De;const a=e.toString(),u=Object.assign({},this.indexSet_);u[a]=e;const h=Object.assign({},this.indexes_);return h[a]=l,new Z(h,u)}addToIndexes(e,t){const s=(0,c.kH)(this.indexes_,(i,r)=>{const o=(0,c.yw)(this.indexSet_,r);if((0,c.vA)(o,"Missing index implementation for "+r),i===De){if(o.isDefinedOn(e.node)){const l=[],a=t.getIterator(C.Wrap);let u=a.getNext();for(;u;)u.name!==e.name&&l.push(u),u=a.getNext();return l.push(e),At(l,o.getCompare())}return De}{const l=t.get(e.name);let a=i;return l&&(a=a.remove(new C(e.name,l))),a.insert(e,e.node)}});return new Z(s,this.indexSet_)}removeFromIndexes(e,t){const s=(0,c.kH)(this.indexes_,i=>{if(i===De)return i;{const r=t.get(e.name);return r?i.remove(new C(e.name,r)):i}});return new Z(s,this.indexSet_)}}let $e,m=(()=>{class n{constructor(t,s,i){this.children_=t,this.priorityNode_=s,this.indexMap_=i,this.lazyHash_=null,this.priorityNode_&&ci(this.priorityNode_),this.children_.isEmpty()&&(0,c.vA)(!this.priorityNode_||this.priorityNode_.isEmpty(),"An empty node cannot have a priority")}static get EMPTY_NODE(){return $e||($e=new n(new F(vn),null,Z.Default))}isLeafNode(){return!1}getPriority(){return this.priorityNode_||$e}updatePriority(t){return this.children_.isEmpty()?this:new n(this.children_,t,this.indexMap_)}getImmediateChild(t){if(".priority"===t)return this.getPriority();{const s=this.children_.get(t);return null===s?$e:s}}getChild(t){const s=y(t);return null===s?this:this.getImmediateChild(s).getChild(S(t))}hasChild(t){return null!==this.children_.get(t)}updateImmediateChild(t,s){if((0,c.vA)(s,"We should always be passing snapshot nodes"),".priority"===t)return this.updatePriority(s);{const i=new C(t,s);let r,o;s.isEmpty()?(r=this.children_.remove(t),o=this.indexMap_.removeFromIndexes(i,this.children_)):(r=this.children_.insert(t,s),o=this.indexMap_.addToIndexes(i,this.children_));const l=r.isEmpty()?$e:this.priorityNode_;return new n(r,l,o)}}updateChild(t,s){const i=y(t);if(null===i)return s;{(0,c.vA)(".priority"!==y(t)||1===ie(t),".priority must be the last token in a path");const r=this.getImmediateChild(i).updateChild(S(t),s);return this.updateImmediateChild(i,r)}}isEmpty(){return this.children_.isEmpty()}numChildren(){return this.children_.count()}val(t){if(this.isEmpty())return null;const s={};let i=0,r=0,o=!0;if(this.forEachChild(A,(l,a)=>{s[l]=a.val(t),i++,o&&n.INTEGER_REGEXP_.test(l)?r=Math.max(r,Number(l)):o=!1}),!t&&o&&r<2*i){const l=[];for(const a in s)l[a]=s[a];return l}return t&&!this.getPriority().isEmpty()&&(s[".priority"]=this.getPriority().val()),s}hash(){if(null===this.lazyHash_){let t="";this.getPriority().isEmpty()||(t+="priority:"+ai(this.getPriority().val())+":"),this.forEachChild(A,(s,i)=>{const r=i.hash();""!==r&&(t+=":"+s+":"+r)}),this.lazyHash_=""===t?"":Ts(t)}return this.lazyHash_}getPredecessorChildName(t,s,i){const r=this.resolveIndex_(i);if(r){const o=r.getPredecessorKey(new C(t,s));return o?o.name:null}return this.children_.getPredecessorKey(t)}getFirstChildName(t){const s=this.resolveIndex_(t);if(s){const i=s.minKey();return i&&i.name}return this.children_.minKey()}getFirstChild(t){const s=this.getFirstChildName(t);return s?new C(s,this.children_.get(s)):null}getLastChildName(t){const s=this.resolveIndex_(t);if(s){const i=s.maxKey();return i&&i.name}return this.children_.maxKey()}getLastChild(t){const s=this.getLastChildName(t);return s?new C(s,this.children_.get(s)):null}forEachChild(t,s){const i=this.resolveIndex_(t);return i?i.inorderTraversal(r=>s(r.name,r.node)):this.children_.inorderTraversal(s)}getIterator(t){return this.getIteratorFrom(t.minPost(),t)}getIteratorFrom(t,s){const i=this.resolveIndex_(s);if(i)return i.getIteratorFrom(t,r=>r);{const r=this.children_.getIteratorFrom(t.name,C.Wrap);let o=r.peek();for(;null!=o&&s.compare(o,t)<0;)r.getNext(),o=r.peek();return r}}getReverseIterator(t){return this.getReverseIteratorFrom(t.maxPost(),t)}getReverseIteratorFrom(t,s){const i=this.resolveIndex_(s);if(i)return i.getReverseIteratorFrom(t,r=>r);{const r=this.children_.getReverseIteratorFrom(t.name,C.Wrap);let o=r.peek();for(;null!=o&&s.compare(o,t)>0;)r.getNext(),o=r.peek();return r}}compareTo(t){return this.isEmpty()?t.isEmpty()?0:-1:t.isLeafNode()||t.isEmpty()?1:t===ze?-1:0}withIndex(t){if(t===z||this.indexMap_.hasIndex(t))return this;{const s=this.indexMap_.addIndex(t,this.children_);return new n(this.children_,this.priorityNode_,s)}}isIndexed(t){return t===z||this.indexMap_.hasIndex(t)}equals(t){if(t===this)return!0;if(t.isLeafNode())return!1;{const s=t;if(this.getPriority().equals(s.getPriority())){if(this.children_.count()===s.children_.count()){const i=this.getIterator(A),r=s.getIterator(A);let o=i.getNext(),l=r.getNext();for(;o&&l;){if(o.name!==l.name||!o.node.equals(l.node))return!1;o=i.getNext(),l=r.getNext()}return null===o&&null===l}return!1}return!1}}resolveIndex_(t){return t===z?null:this.indexMap_.get(t.toString())}}return n.INTEGER_REGEXP_=/^(0|[1-9]\d*)$/,n})();const ze=new class tl extends m{constructor(){super(new F(vn),m.EMPTY_NODE,Z.Default)}compareTo(e){return e===this?0:1}equals(e){return e===this}getPriority(){return this}getImmediateChild(e){return m.EMPTY_NODE}isEmpty(){return!1}};Object.defineProperties(C,{MIN:{value:new C(ne,m.EMPTY_NODE)},MAX:{value:new C(J,ze)}}),li.__EMPTY_NODE=m.EMPTY_NODE,xe.__childrenNodeConstructor=m,function zo(n){Cn=n}(ze),function Xo(n){di=n}(ze);const nl=!0;function R(n,e=null){if(null===n)return m.EMPTY_NODE;if("object"==typeof n&&".priority"in n&&(e=n[".priority"]),(0,c.vA)(null===e||"string"==typeof e||"number"==typeof e||"object"==typeof e&&".sv"in e,"Invalid priority type found: "+typeof e),"object"==typeof n&&".value"in n&&null!==n[".value"]&&(n=n[".value"]),"object"!=typeof n||".sv"in n)return new xe(n,R(e));if(n instanceof Array||!nl){let t=m.EMPTY_NODE;return x(n,(s,i)=>{if((0,c.gR)(n,s)&&"."!==s.substring(0,1)){const r=R(i);(r.isLeafNode()||!r.isEmpty())&&(t=t.updateImmediateChild(s,r))}}),t.updatePriority(R(e))}{const t=[];let s=!1;if(x(n,(o,l)=>{if("."!==o.substring(0,1)){const a=R(l);a.isEmpty()||(s=s||!a.getPriority().isEmpty(),t.push(new C(o,a)))}}),0===t.length)return m.EMPTY_NODE;const r=At(t,$o,o=>o.name,vn);if(s){const o=At(t,A.getCompare());return new m(r,R(e),new Z({".priority":o},{".priority":A}))}return new m(r,R(e),Z.Default)}}!function qo(n){hi=n}(R);class En extends Tt{constructor(e){super(),this.indexPath_=e,(0,c.vA)(!v(e)&&".priority"!==y(e),"Can't create PathIndex with empty path or .priority key")}extractChild(e){return e.getChild(this.indexPath_)}isDefinedOn(e){return!e.getChild(this.indexPath_).isEmpty()}compare(e,t){const s=this.extractChild(e.node),i=this.extractChild(t.node),r=s.compareTo(i);return 0===r?ye(e.name,t.name):r}makePost(e,t){const s=R(e),i=m.EMPTY_NODE.updateChild(this.indexPath_,s);return new C(t,i)}maxPost(){const e=m.EMPTY_NODE.updateChild(this.indexPath_,ze);return new C(J,e)}toString(){return Ye(this.indexPath_,0).join("/")}}const Tn=new class sl extends Tt{compare(e,t){const s=e.node.compareTo(t.node);return 0===s?ye(e.name,t.name):s}isDefinedOn(e){return!0}indexedValueChanged(e,t){return!e.equals(t)}minPost(){return C.MIN}maxPost(){return C.MAX}makePost(e,t){const s=R(e);return new C(t,s)}toString(){return".value"}};function fi(n){return{type:"value",snapshotNode:n}}function Oe(n,e){return{type:"child_added",snapshotNode:e,childName:n}}function qe(n,e){return{type:"child_removed",snapshotNode:e,childName:n}}function Xe(n,e,t){return{type:"child_changed",snapshotNode:e,childName:n,oldSnap:t}}class In{constructor(e){this.index_=e}updateChild(e,t,s,i,r,o){(0,c.vA)(e.isIndexed(this.index_),"A node must be indexed if only a child is updated");const l=e.getImmediateChild(t);return l.getChild(i).equals(s.getChild(i))&&l.isEmpty()===s.isEmpty()||(null!=o&&(s.isEmpty()?e.hasChild(t)?o.trackChildChange(qe(t,l)):(0,c.vA)(e.isLeafNode(),"A child remove without an old child only makes sense on a leaf node"):l.isEmpty()?o.trackChildChange(Oe(t,s)):o.trackChildChange(Xe(t,s,l))),e.isLeafNode()&&s.isEmpty())?e:e.updateImmediateChild(t,s).withIndex(this.index_)}updateFullNode(e,t,s){return null!=s&&(e.isLeafNode()||e.forEachChild(A,(i,r)=>{t.hasChild(i)||s.trackChildChange(qe(i,r))}),t.isLeafNode()||t.forEachChild(A,(i,r)=>{if(e.hasChild(i)){const o=e.getImmediateChild(i);o.equals(r)||s.trackChildChange(Xe(i,r,o))}else s.trackChildChange(Oe(i,r))})),t.withIndex(this.index_)}updatePriority(e,t){return e.isEmpty()?m.EMPTY_NODE:e.updatePriority(t)}filtersNodes(){return!1}getIndexedFilter(){return this}getIndex(){return this.index_}}class Je{constructor(e){this.indexedFilter_=new In(e.getIndex()),this.index_=e.getIndex(),this.startPost_=Je.getStartPost_(e),this.endPost_=Je.getEndPost_(e),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}getStartPost(){return this.startPost_}getEndPost(){return this.endPost_}matches(e){const t=this.startIsInclusive_?this.index_.compare(this.getStartPost(),e)<=0:this.index_.compare(this.getStartPost(),e)<0,s=this.endIsInclusive_?this.index_.compare(e,this.getEndPost())<=0:this.index_.compare(e,this.getEndPost())<0;return t&&s}updateChild(e,t,s,i,r,o){return this.matches(new C(t,s))||(s=m.EMPTY_NODE),this.indexedFilter_.updateChild(e,t,s,i,r,o)}updateFullNode(e,t,s){t.isLeafNode()&&(t=m.EMPTY_NODE);let i=t.withIndex(this.index_);i=i.updatePriority(m.EMPTY_NODE);const r=this;return t.forEachChild(A,(o,l)=>{r.matches(new C(o,l))||(i=i.updateImmediateChild(o,m.EMPTY_NODE))}),this.indexedFilter_.updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.indexedFilter_}getIndex(){return this.index_}static getStartPost_(e){if(e.hasStart()){const t=e.getIndexStartName();return e.getIndex().makePost(e.getIndexStartValue(),t)}return e.getIndex().minPost()}static getEndPost_(e){if(e.hasEnd()){const t=e.getIndexEndName();return e.getIndex().makePost(e.getIndexEndValue(),t)}return e.getIndex().maxPost()}}class rl{constructor(e){this.withinDirectionalStart=t=>this.reverse_?this.withinEndPost(t):this.withinStartPost(t),this.withinDirectionalEnd=t=>this.reverse_?this.withinStartPost(t):this.withinEndPost(t),this.withinStartPost=t=>{const s=this.index_.compare(this.rangedFilter_.getStartPost(),t);return this.startIsInclusive_?s<=0:s<0},this.withinEndPost=t=>{const s=this.index_.compare(t,this.rangedFilter_.getEndPost());return this.endIsInclusive_?s<=0:s<0},this.rangedFilter_=new Je(e),this.index_=e.getIndex(),this.limit_=e.getLimit(),this.reverse_=!e.isViewFromLeft(),this.startIsInclusive_=!e.startAfterSet_,this.endIsInclusive_=!e.endBeforeSet_}updateChild(e,t,s,i,r,o){return this.rangedFilter_.matches(new C(t,s))||(s=m.EMPTY_NODE),e.getImmediateChild(t).equals(s)?e:e.numChildren()<this.limit_?this.rangedFilter_.getIndexedFilter().updateChild(e,t,s,i,r,o):this.fullLimitUpdateChild_(e,t,s,r,o)}updateFullNode(e,t,s){let i;if(t.isLeafNode()||t.isEmpty())i=m.EMPTY_NODE.withIndex(this.index_);else if(2*this.limit_<t.numChildren()&&t.isIndexed(this.index_)){let r;i=m.EMPTY_NODE.withIndex(this.index_),r=this.reverse_?t.getReverseIteratorFrom(this.rangedFilter_.getEndPost(),this.index_):t.getIteratorFrom(this.rangedFilter_.getStartPost(),this.index_);let o=0;for(;r.hasNext()&&o<this.limit_;){const l=r.getNext();if(this.withinDirectionalStart(l)){if(!this.withinDirectionalEnd(l))break;i=i.updateImmediateChild(l.name,l.node),o++}}}else{let r;i=t.withIndex(this.index_),i=i.updatePriority(m.EMPTY_NODE),r=this.reverse_?i.getReverseIterator(this.index_):i.getIterator(this.index_);let o=0;for(;r.hasNext();){const l=r.getNext();o<this.limit_&&this.withinDirectionalStart(l)&&this.withinDirectionalEnd(l)?o++:i=i.updateImmediateChild(l.name,m.EMPTY_NODE)}}return this.rangedFilter_.getIndexedFilter().updateFullNode(e,i,s)}updatePriority(e,t){return e}filtersNodes(){return!0}getIndexedFilter(){return this.rangedFilter_.getIndexedFilter()}getIndex(){return this.index_}fullLimitUpdateChild_(e,t,s,i,r){let o;if(this.reverse_){const d=this.index_.getCompare();o=(f,_)=>d(_,f)}else o=this.index_.getCompare();const l=e;(0,c.vA)(l.numChildren()===this.limit_,"");const a=new C(t,s),u=this.reverse_?l.getFirstChild(this.index_):l.getLastChild(this.index_),h=this.rangedFilter_.matches(a);if(l.hasChild(t)){const d=l.getImmediateChild(t);let f=i.getChildAfterChild(this.index_,u,this.reverse_);for(;null!=f&&(f.name===t||l.hasChild(f.name));)f=i.getChildAfterChild(this.index_,f,this.reverse_);const _=null==f?1:o(f,a);if(h&&!s.isEmpty()&&_>=0)return null!=r&&r.trackChildChange(Xe(t,s,d)),l.updateImmediateChild(t,s);{null!=r&&r.trackChildChange(qe(t,d));const E=l.updateImmediateChild(t,m.EMPTY_NODE);return null!=f&&this.rangedFilter_.matches(f)?(null!=r&&r.trackChildChange(Oe(f.name,f.node)),E.updateImmediateChild(f.name,f.node)):E}}return s.isEmpty()?e:h&&o(u,a)>=0?(null!=r&&(r.trackChildChange(qe(u.name,u.node)),r.trackChildChange(Oe(t,s))),l.updateImmediateChild(t,s).updateImmediateChild(u.name,m.EMPTY_NODE)):e}}class bt{constructor(){this.limitSet_=!1,this.startSet_=!1,this.startNameSet_=!1,this.startAfterSet_=!1,this.endSet_=!1,this.endNameSet_=!1,this.endBeforeSet_=!1,this.limit_=0,this.viewFrom_="",this.indexStartValue_=null,this.indexStartName_="",this.indexEndValue_=null,this.indexEndName_="",this.index_=A}hasStart(){return this.startSet_}isViewFromLeft(){return""===this.viewFrom_?this.startSet_:"l"===this.viewFrom_}getIndexStartValue(){return(0,c.vA)(this.startSet_,"Only valid if start has been set"),this.indexStartValue_}getIndexStartName(){return(0,c.vA)(this.startSet_,"Only valid if start has been set"),this.startNameSet_?this.indexStartName_:ne}hasEnd(){return this.endSet_}getIndexEndValue(){return(0,c.vA)(this.endSet_,"Only valid if end has been set"),this.indexEndValue_}getIndexEndName(){return(0,c.vA)(this.endSet_,"Only valid if end has been set"),this.endNameSet_?this.indexEndName_:J}hasLimit(){return this.limitSet_}hasAnchoredLimit(){return this.limitSet_&&""!==this.viewFrom_}getLimit(){return(0,c.vA)(this.limitSet_,"Only valid if limit has been set"),this.limit_}getIndex(){return this.index_}loadsAllData(){return!(this.startSet_||this.endSet_||this.limitSet_)}isDefault(){return this.loadsAllData()&&this.index_===A}copy(){const e=new bt;return e.limitSet_=this.limitSet_,e.limit_=this.limit_,e.startSet_=this.startSet_,e.startAfterSet_=this.startAfterSet_,e.indexStartValue_=this.indexStartValue_,e.startNameSet_=this.startNameSet_,e.indexStartName_=this.indexStartName_,e.endSet_=this.endSet_,e.endBeforeSet_=this.endBeforeSet_,e.indexEndValue_=this.indexEndValue_,e.endNameSet_=this.endNameSet_,e.indexEndName_=this.indexEndName_,e.index_=this.index_,e.viewFrom_=this.viewFrom_,e}}function Sn(n,e,t){const s=n.copy();return s.startSet_=!0,void 0===e&&(e=null),s.indexStartValue_=e,null!=t?(s.startNameSet_=!0,s.indexStartName_=t):(s.startNameSet_=!1,s.indexStartName_=""),s}function An(n,e,t){const s=n.copy();return s.endSet_=!0,void 0===e&&(e=null),s.indexEndValue_=e,void 0!==t?(s.endNameSet_=!0,s.indexEndName_=t):(s.endNameSet_=!1,s.indexEndName_=""),s}function Nt(n,e){const t=n.copy();return t.index_=e,t}function _i(n){const e={};if(n.isDefault())return e;let t;if(n.index_===A?t="$priority":n.index_===Tn?t="$value":n.index_===z?t="$key":((0,c.vA)(n.index_ instanceof En,"Unrecognized index type!"),t=n.index_.toString()),e.orderBy=(0,c.As)(t),n.startSet_){const s=n.startAfterSet_?"startAfter":"startAt";e[s]=(0,c.As)(n.indexStartValue_),n.startNameSet_&&(e[s]+=","+(0,c.As)(n.indexStartName_))}if(n.endSet_){const s=n.endBeforeSet_?"endBefore":"endAt";e[s]=(0,c.As)(n.indexEndValue_),n.endNameSet_&&(e[s]+=","+(0,c.As)(n.indexEndName_))}return n.limitSet_&&(n.isViewFromLeft()?e.limitToFirst=n.limit_:e.limitToLast=n.limit_),e}function pi(n){const e={};if(n.startSet_&&(e.sp=n.indexStartValue_,n.startNameSet_&&(e.sn=n.indexStartName_),e.sin=!n.startAfterSet_),n.endSet_&&(e.ep=n.indexEndValue_,n.endNameSet_&&(e.en=n.indexEndName_),e.ein=!n.endBeforeSet_),n.limitSet_){e.l=n.limit_;let t=n.viewFrom_;""===t&&(t=n.isViewFromLeft()?"l":"r"),e.vf=t}return n.index_!==A&&(e.i=n.index_.toString()),e}class Rt extends Zs{constructor(e,t,s,i){super(),this.repoInfo_=e,this.onDataUpdate_=t,this.authTokenProvider_=s,this.appCheckTokenProvider_=i,this.log_=He("p:rest:"),this.listens_={}}reportStats(e){throw new Error("Method not implemented.")}static getListenId_(e,t){return void 0!==t?"tag$"+t:((0,c.vA)(e._queryParams.isDefault(),"should have a tag if it's not a default query."),e._path.toString())}listen(e,t,s,i){const r=e._path.toString();this.log_("Listen called for "+r+" "+e._queryIdentifier);const o=Rt.getListenId_(e,s),l={};this.listens_[o]=l;const a=_i(e._queryParams);this.restRequest_(r+".json",a,(u,h)=>{let d=h;if(404===u&&(d=null,u=null),null===u&&this.onDataUpdate_(r,d,!1,s),(0,c.yw)(this.listens_,o)===l){let f;f=u?401===u?"permission_denied":"rest_error:"+u:"ok",i(f,null)}})}unlisten(e,t){const s=Rt.getListenId_(e,t);delete this.listens_[s]}get(e){const t=_i(e._queryParams),s=e._path.toString(),i=new c.cY;return this.restRequest_(s+".json",t,(r,o)=>{let l=o;404===r&&(l=null,r=null),null===r?(this.onDataUpdate_(s,l,!1,null),i.resolve(l)):i.reject(new Error(l))}),i.promise}refreshAuthToken(e){}restRequest_(e,t={},s){return t.format="export",Promise.all([this.authTokenProvider_.getToken(!1),this.appCheckTokenProvider_.getToken(!1)]).then(([i,r])=>{i&&i.accessToken&&(t.auth=i.accessToken),r&&r.token&&(t.ac=r.token);const o=(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host+e+"?ns="+this.repoInfo_.namespace+(0,c.Am)(t);this.log_("Sending REST request for "+o);const l=new XMLHttpRequest;l.onreadystatechange=()=>{if(s&&4===l.readyState){this.log_("REST Response for "+o+" received. status:",l.status,"response:",l.responseText);let a=null;if(l.status>=200&&l.status<300){try{a=(0,c.$L)(l.responseText)}catch{O("Failed to parse JSON response for "+o+": "+l.responseText)}s(null,a)}else 401!==l.status&&404!==l.status&&O("Got unsuccessful REST response for "+o+" Status: "+l.status),s(l.status);s=null}},l.open("GET",o,!0),l.send()})}}class hl{constructor(){this.rootNode_=m.EMPTY_NODE}getNode(e){return this.rootNode_.getChild(e)}updateSnapshot(e,t){this.rootNode_=this.rootNode_.updateChild(e,t)}}function Pt(){return{value:null,children:new Map}}function Me(n,e,t){if(v(e))n.value=t,n.children.clear();else if(null!==n.value)n.value=n.value.updateChild(e,t);else{const s=y(e);n.children.has(s)||n.children.set(s,Pt()),Me(n.children.get(s),e=S(e),t)}}function bn(n,e){if(v(e))return n.value=null,n.children.clear(),!0;if(null!==n.value){if(n.value.isLeafNode())return!1;{const t=n.value;return n.value=null,t.forEachChild(A,(s,i)=>{Me(n,new I(s),i)}),bn(n,e)}}if(n.children.size>0){const t=y(e);return e=S(e),n.children.has(t)&&bn(n.children.get(t),e)&&n.children.delete(t),0===n.children.size}return!0}function Nn(n,e,t){null!==n.value?t(e,n.value):function dl(n,e){n.children.forEach((t,s)=>{e(s,t)})}(n,(s,i)=>{Nn(i,new I(e.toString()+"/"+s),t)})}class fl{constructor(e){this.collection_=e,this.last_=null}get(){const e=this.collection_.get(),t=Object.assign({},e);return this.last_&&x(this.last_,(s,i)=>{t[s]=t[s]-i}),this.last_=e,t}}class gl{constructor(e,t){this.server_=t,this.statsToReport_={},this.statsListener_=new fl(e);const s=1e4+2e4*Math.random();Ge(this.reportStats_.bind(this),Math.floor(s))}reportStats_(){const e=this.statsListener_.get(),t={};let s=!1;x(e,(i,r)=>{r>0&&(0,c.gR)(this.statsToReport_,i)&&(t[i]=r,s=!0)}),s&&this.server_.reportStats(t),Ge(this.reportStats_.bind(this),Math.floor(2*Math.random()*3e5))}}var q=function(n){return n[n.OVERWRITE=0]="OVERWRITE",n[n.MERGE=1]="MERGE",n[n.ACK_USER_WRITE=2]="ACK_USER_WRITE",n[n.LISTEN_COMPLETE=3]="LISTEN_COMPLETE",n}(q||{});function kn(n){return{fromUser:!1,fromServer:!0,queryId:n,tagged:!0}}class kt{constructor(e,t,s){this.path=e,this.affectedTree=t,this.revert=s,this.type=q.ACK_USER_WRITE,this.source={fromUser:!0,fromServer:!1,queryId:null,tagged:!1}}operationForChild(e){if(v(this.path)){if(null!=this.affectedTree.value)return(0,c.vA)(this.affectedTree.children.isEmpty(),"affectedTree should not have overlapping affected paths."),this;{const t=this.affectedTree.subtree(new I(e));return new kt(T(),t,this.revert)}}return(0,c.vA)(y(this.path)===e,"operationForChild called for unrelated child."),new kt(S(this.path),this.affectedTree,this.revert)}}class Ze{constructor(e,t){this.source=e,this.path=t,this.type=q.LISTEN_COMPLETE}operationForChild(e){return v(this.path)?new Ze(this.source,T()):new Ze(this.source,S(this.path))}}class we{constructor(e,t,s){this.source=e,this.path=t,this.snap=s,this.type=q.OVERWRITE}operationForChild(e){return v(this.path)?new we(this.source,T(),this.snap.getImmediateChild(e)):new we(this.source,S(this.path),this.snap)}}class Fe{constructor(e,t,s){this.source=e,this.path=t,this.children=s,this.type=q.MERGE}operationForChild(e){if(v(this.path)){const t=this.children.subtree(new I(e));return t.isEmpty()?null:t.value?new we(this.source,T(),t.value):new Fe(this.source,T(),t)}return(0,c.vA)(y(this.path)===e,"Can't get a merge for a child not on the path of the operation"),new Fe(this.source,S(this.path),this.children)}toString(){return"Operation("+this.path+": "+this.source.toString()+" merge: "+this.children.toString()+")"}}class re{constructor(e,t,s){this.node_=e,this.fullyInitialized_=t,this.filtered_=s}isFullyInitialized(){return this.fullyInitialized_}isFiltered(){return this.filtered_}isCompleteForPath(e){if(v(e))return this.isFullyInitialized()&&!this.filtered_;const t=y(e);return this.isCompleteForChild(t)}isCompleteForChild(e){return this.isFullyInitialized()&&!this.filtered_||this.node_.hasChild(e)}getNode(){return this.node_}}class ml{constructor(e){this.query_=e,this.index_=this.query_._queryParams.getIndex()}}function et(n,e,t,s,i,r){const o=s.filter(l=>l.type===t);o.sort((l,a)=>function Cl(n,e,t){if(null==e.childName||null==t.childName)throw(0,c.Hk)("Should only compare child_ events.");const s=new C(e.childName,e.snapshotNode),i=new C(t.childName,t.snapshotNode);return n.index_.compare(s,i)}(n,l,a)),o.forEach(l=>{const a=function vl(n,e,t){return"value"===e.type||"child_removed"===e.type||(e.prevName=t.getPredecessorChildName(e.childName,e.snapshotNode,n.index_)),e}(n,l,r);i.forEach(u=>{u.respondsTo(l.type)&&e.push(u.createEvent(a,n.query_))})})}function xt(n,e){return{eventCache:n,serverCache:e}}function tt(n,e,t,s){return xt(new re(e,t,s),n.serverCache)}function mi(n,e,t,s){return xt(n.eventCache,new re(e,t,s))}function Dt(n){return n.eventCache.isFullyInitialized()?n.eventCache.getNode():null}function Ee(n){return n.serverCache.isFullyInitialized()?n.serverCache.getNode():null}let xn;class b{constructor(e,t=(()=>(xn||(xn=new F(so)),xn))()){this.value=e,this.children=t}static fromObject(e){let t=new b(null);return x(e,(s,i)=>{t=t.set(new I(s),i)}),t}isEmpty(){return null===this.value&&this.children.isEmpty()}findRootMostMatchingPathAndValue(e,t){if(null!=this.value&&t(this.value))return{path:T(),value:this.value};if(v(e))return null;{const s=y(e),i=this.children.get(s);if(null!==i){const r=i.findRootMostMatchingPathAndValue(S(e),t);return null!=r?{path:N(new I(s),r.path),value:r.value}:null}return null}}findRootMostValueAndPath(e){return this.findRootMostMatchingPathAndValue(e,()=>!0)}subtree(e){if(v(e))return this;{const t=y(e),s=this.children.get(t);return null!==s?s.subtree(S(e)):new b(null)}}set(e,t){if(v(e))return new b(t,this.children);{const s=y(e),r=(this.children.get(s)||new b(null)).set(S(e),t),o=this.children.insert(s,r);return new b(this.value,o)}}remove(e){if(v(e))return this.children.isEmpty()?new b(null):new b(null,this.children);{const t=y(e),s=this.children.get(t);if(s){const i=s.remove(S(e));let r;return r=i.isEmpty()?this.children.remove(t):this.children.insert(t,i),null===this.value&&r.isEmpty()?new b(null):new b(this.value,r)}return this}}get(e){if(v(e))return this.value;{const t=y(e),s=this.children.get(t);return s?s.get(S(e)):null}}setTree(e,t){if(v(e))return t;{const s=y(e),r=(this.children.get(s)||new b(null)).setTree(S(e),t);let o;return o=r.isEmpty()?this.children.remove(s):this.children.insert(s,r),new b(this.value,o)}}fold(e){return this.fold_(T(),e)}fold_(e,t){const s={};return this.children.inorderTraversal((i,r)=>{s[i]=r.fold_(N(e,i),t)}),t(e,this.value,s)}findOnPath(e,t){return this.findOnPath_(e,T(),t)}findOnPath_(e,t,s){const i=!!this.value&&s(t,this.value);if(i)return i;if(v(e))return null;{const r=y(e),o=this.children.get(r);return o?o.findOnPath_(S(e),N(t,r),s):null}}foreachOnPath(e,t){return this.foreachOnPath_(e,T(),t)}foreachOnPath_(e,t,s){if(v(e))return this;{this.value&&s(t,this.value);const i=y(e),r=this.children.get(i);return r?r.foreachOnPath_(S(e),N(t,i),s):new b(null)}}foreach(e){this.foreach_(T(),e)}foreach_(e,t){this.children.inorderTraversal((s,i)=>{i.foreach_(N(e,s),t)}),this.value&&t(e,this.value)}foreachChild(e){this.children.inorderTraversal((t,s)=>{s.value&&e(t,s.value)})}}class Q{constructor(e){this.writeTree_=e}static empty(){return new Q(new b(null))}}function nt(n,e,t){if(v(e))return new Q(new b(t));{const s=n.writeTree_.findRootMostValueAndPath(e);if(null!=s){const i=s.path;let r=s.value;const o=M(i,e);return r=r.updateChild(o,t),new Q(n.writeTree_.set(i,r))}{const i=new b(t),r=n.writeTree_.setTree(e,i);return new Q(r)}}}function Dn(n,e,t){let s=n;return x(t,(i,r)=>{s=nt(s,N(e,i),r)}),s}function yi(n,e){if(v(e))return Q.empty();{const t=n.writeTree_.setTree(e,new b(null));return new Q(t)}}function On(n,e){return null!=Te(n,e)}function Te(n,e){const t=n.writeTree_.findRootMostValueAndPath(e);return null!=t?n.writeTree_.get(t.path).getChild(M(t.path,e)):null}function vi(n){const e=[],t=n.writeTree_.value;return null!=t?t.isLeafNode()||t.forEachChild(A,(s,i)=>{e.push(new C(s,i))}):n.writeTree_.children.inorderTraversal((s,i)=>{null!=i.value&&e.push(new C(s,i.value))}),e}function oe(n,e){if(v(e))return n;{const t=Te(n,e);return new Q(null!=t?new b(t):n.writeTree_.subtree(e))}}function Mn(n){return n.writeTree_.isEmpty()}function Le(n,e){return Ci(T(),n.writeTree_,e)}function Ci(n,e,t){if(null!=e.value)return t.updateChild(n,e.value);{let s=null;return e.children.inorderTraversal((i,r)=>{".priority"===i?((0,c.vA)(null!==r.value,"Priority writes must always be leaf nodes"),s=r.value):t=Ci(N(n,i),r,t)}),!t.getChild(n).isEmpty()&&null!==s&&(t=t.updateChild(N(n,".priority"),s)),t}}function Ot(n,e){return Si(e,n)}function Al(n,e){if(n.snap)return V(n.path,e);for(const t in n.children)if(n.children.hasOwnProperty(t)&&V(N(n.path,t),e))return!0;return!1}function Nl(n){return n.visible}function wi(n,e,t){let s=Q.empty();for(let i=0;i<n.length;++i){const r=n[i];if(e(r)){const o=r.path;let l;if(r.snap)V(t,o)?(l=M(t,o),s=nt(s,l,r.snap)):V(o,t)&&(l=M(o,t),s=nt(s,T(),r.snap.getChild(l)));else{if(!r.children)throw(0,c.Hk)("WriteRecord should have .snap or .children");if(V(t,o))l=M(t,o),s=Dn(s,l,r.children);else if(V(o,t))if(l=M(o,t),v(l))s=Dn(s,T(),r.children);else{const a=(0,c.yw)(r.children,y(l));if(a){const u=a.getChild(S(l));s=nt(s,T(),u)}}}}}return s}function Ei(n,e,t,s,i){if(s||i){const r=oe(n.visibleWrites,e);return!i&&Mn(r)?t:i||null!=t||On(r,T())?Le(wi(n.allWrites,function(u){return(u.visible||i)&&(!s||!~s.indexOf(u.writeId))&&(V(u.path,e)||V(e,u.path))},e),t||m.EMPTY_NODE):null}{const r=Te(n.visibleWrites,e);if(null!=r)return r;{const o=oe(n.visibleWrites,e);return Mn(o)?t:null!=t||On(o,T())?Le(o,t||m.EMPTY_NODE):null}}}function Mt(n,e,t,s){return Ei(n.writeTree,n.treePath,e,t,s)}function Fn(n,e){return function Rl(n,e,t){let s=m.EMPTY_NODE;const i=Te(n.visibleWrites,e);if(i)return i.isLeafNode()||i.forEachChild(A,(r,o)=>{s=s.updateImmediateChild(r,o)}),s;if(t){const r=oe(n.visibleWrites,e);return t.forEachChild(A,(o,l)=>{const a=Le(oe(r,new I(o)),l);s=s.updateImmediateChild(o,a)}),vi(r).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}return vi(oe(n.visibleWrites,e)).forEach(o=>{s=s.updateImmediateChild(o.name,o.node)}),s}(n.writeTree,n.treePath,e)}function Ti(n,e,t,s){return function Pl(n,e,t,s,i){(0,c.vA)(s||i,"Either existingEventSnap or existingServerSnap must exist");const r=N(e,t);if(On(n.visibleWrites,r))return null;{const o=oe(n.visibleWrites,r);return Mn(o)?i.getChild(t):Le(o,i.getChild(t))}}(n.writeTree,n.treePath,e,t,s)}function Ft(n,e){return function xl(n,e){return Te(n.visibleWrites,e)}(n.writeTree,N(n.treePath,e))}function Ln(n,e,t){return function kl(n,e,t,s){const i=N(e,t),r=Te(n.visibleWrites,i);return null!=r?r:s.isCompleteForChild(t)?Le(oe(n.visibleWrites,i),s.getNode().getImmediateChild(t)):null}(n.writeTree,n.treePath,e,t)}function Ii(n,e){return Si(N(n.treePath,e),n.writeTree)}function Si(n,e){return{treePath:n,writeTree:e}}class Fl{constructor(){this.changeMap=new Map}trackChildChange(e){const t=e.type,s=e.childName;(0,c.vA)("child_added"===t||"child_changed"===t||"child_removed"===t,"Only child changes supported for tracking"),(0,c.vA)(".priority"!==s,"Only non-priority child changes can be tracked.");const i=this.changeMap.get(s);if(i){const r=i.type;if("child_added"===t&&"child_removed"===r)this.changeMap.set(s,Xe(s,e.snapshotNode,i.snapshotNode));else if("child_removed"===t&&"child_added"===r)this.changeMap.delete(s);else if("child_removed"===t&&"child_changed"===r)this.changeMap.set(s,qe(s,i.oldSnap));else if("child_changed"===t&&"child_added"===r)this.changeMap.set(s,Oe(s,e.snapshotNode));else{if("child_changed"!==t||"child_changed"!==r)throw(0,c.Hk)("Illegal combination of changes: "+e+" occurred after "+i);this.changeMap.set(s,Xe(s,e.snapshotNode,i.oldSnap))}}else this.changeMap.set(s,e)}getChanges(){return Array.from(this.changeMap.values())}}const Ai=new class Ll{getCompleteChild(e){return null}getChildAfterChild(e,t,s){return null}};class Wn{constructor(e,t,s=null){this.writes_=e,this.viewCache_=t,this.optCompleteServerCache_=s}getCompleteChild(e){const t=this.viewCache_.eventCache;if(t.isCompleteForChild(e))return t.getNode().getImmediateChild(e);{const s=null!=this.optCompleteServerCache_?new re(this.optCompleteServerCache_,!0,!1):this.viewCache_.serverCache;return Ln(this.writes_,e,s)}}getChildAfterChild(e,t,s){const i=null!=this.optCompleteServerCache_?this.optCompleteServerCache_:Ee(this.viewCache_),r=function Ml(n,e,t,s,i,r){return function Dl(n,e,t,s,i,r,o){let l;const a=oe(n.visibleWrites,e),u=Te(a,T());if(null!=u)l=u;else{if(null==t)return[];l=Le(a,t)}if(l=l.withIndex(o),l.isEmpty()||l.isLeafNode())return[];{const h=[],d=o.getCompare(),f=r?l.getReverseIteratorFrom(s,o):l.getIteratorFrom(s,o);let _=f.getNext();for(;_&&h.length<i;)0!==d(_,s)&&h.push(_),_=f.getNext();return h}}(n.writeTree,n.treePath,e,t,s,i,r)}(this.writes_,i,t,1,s,e);return 0===r.length?null:r[0]}}function bi(n,e,t,s,i,r){const o=e.eventCache;if(null!=Ft(s,t))return e;{let l,a;if(v(t))if((0,c.vA)(e.serverCache.isFullyInitialized(),"If change path is empty, we must have complete server data"),e.serverCache.isFiltered()){const u=Ee(e),d=Fn(s,u instanceof m?u:m.EMPTY_NODE);l=n.filter.updateFullNode(e.eventCache.getNode(),d,r)}else{const u=Mt(s,Ee(e));l=n.filter.updateFullNode(e.eventCache.getNode(),u,r)}else{const u=y(t);if(".priority"===u){(0,c.vA)(1===ie(t),"Can't have a priority with additional path components");const h=o.getNode();a=e.serverCache.getNode();const d=Ti(s,t,h,a);l=null!=d?n.filter.updatePriority(h,d):o.getNode()}else{const h=S(t);let d;if(o.isCompleteForChild(u)){a=e.serverCache.getNode();const f=Ti(s,t,o.getNode(),a);d=null!=f?o.getNode().getImmediateChild(u).updateChild(h,f):o.getNode().getImmediateChild(u)}else d=Ln(s,u,e.serverCache);l=null!=d?n.filter.updateChild(o.getNode(),u,d,h,i,r):o.getNode()}}return tt(e,l,o.isFullyInitialized()||v(t),n.filter.filtersNodes())}}function Lt(n,e,t,s,i,r,o,l){const a=e.serverCache;let u;const h=o?n.filter:n.filter.getIndexedFilter();if(v(t))u=h.updateFullNode(a.getNode(),s,null);else if(h.filtersNodes()&&!a.isFiltered()){const _=a.getNode().updateChild(t,s);u=h.updateFullNode(a.getNode(),_,null)}else{const _=y(t);if(!a.isCompleteForPath(t)&&ie(t)>1)return e;const p=S(t),P=a.getNode().getImmediateChild(_).updateChild(p,s);u=".priority"===_?h.updatePriority(a.getNode(),P):h.updateChild(a.getNode(),_,P,p,Ai,null)}const d=mi(e,u,a.isFullyInitialized()||v(t),h.filtersNodes());return bi(n,d,t,i,new Wn(i,d,r),l)}function Un(n,e,t,s,i,r,o){const l=e.eventCache;let a,u;const h=new Wn(i,e,r);if(v(t))u=n.filter.updateFullNode(e.eventCache.getNode(),s,o),a=tt(e,u,!0,n.filter.filtersNodes());else{const d=y(t);if(".priority"===d)u=n.filter.updatePriority(e.eventCache.getNode(),s),a=tt(e,u,l.isFullyInitialized(),l.isFiltered());else{const f=S(t),_=l.getNode().getImmediateChild(d);let p;if(v(f))p=s;else{const E=h.getCompleteChild(d);p=null!=E?".priority"===gn(f)&&E.getChild(si(f)).isEmpty()?E:E.updateChild(f,s):m.EMPTY_NODE}a=_.equals(p)?e:tt(e,n.filter.updateChild(l.getNode(),d,p,f,h,o),l.isFullyInitialized(),n.filter.filtersNodes())}}return a}function Ni(n,e){return n.eventCache.isCompleteForChild(e)}function Ri(n,e,t){return t.foreach((s,i)=>{e=e.updateChild(s,i)}),e}function Vn(n,e,t,s,i,r,o,l){if(e.serverCache.getNode().isEmpty()&&!e.serverCache.isFullyInitialized())return e;let u,a=e;u=v(t)?s:new b(null).setTree(t,s);const h=e.serverCache.getNode();return u.children.inorderTraversal((d,f)=>{if(h.hasChild(d)){const p=Ri(0,e.serverCache.getNode().getImmediateChild(d),f);a=Lt(n,a,new I(d),p,i,r,o,l)}}),u.children.inorderTraversal((d,f)=>{const _=!e.serverCache.isCompleteForChild(d)&&null===f.value;if(!h.hasChild(d)&&!_){const E=Ri(0,e.serverCache.getNode().getImmediateChild(d),f);a=Lt(n,a,new I(d),E,i,r,o,l)}}),a}class Yl{constructor(e,t){this.query_=e,this.eventRegistrations_=[];const s=this.query_._queryParams,i=new In(s.getIndex()),r=function ol(n){return n.loadsAllData()?new In(n.getIndex()):n.hasLimit()?new rl(n):new Je(n)}(s);this.processor_=function Wl(n){return{filter:n}}(r);const o=t.serverCache,l=t.eventCache,a=i.updateFullNode(m.EMPTY_NODE,o.getNode(),null),u=r.updateFullNode(m.EMPTY_NODE,l.getNode(),null),h=new re(a,o.isFullyInitialized(),i.filtersNodes()),d=new re(u,l.isFullyInitialized(),r.filtersNodes());this.viewCache_=xt(d,h),this.eventGenerator_=new ml(this.query_)}get query(){return this.query_}}function zl(n,e){const t=Ee(n.viewCache_);return t&&(n.query._queryParams.loadsAllData()||!v(e)&&!t.getImmediateChild(y(e)).isEmpty())?t.getChild(e):null}function Pi(n){return 0===n.eventRegistrations_.length}function ki(n,e,t){const s=[];if(t){(0,c.vA)(null==e,"A cancel should cancel all event registrations.");const i=n.query._path;n.eventRegistrations_.forEach(r=>{const o=r.createCancelEvent(t,i);o&&s.push(o)})}if(e){let i=[];for(let r=0;r<n.eventRegistrations_.length;++r){const o=n.eventRegistrations_[r];if(o.matches(e)){if(e.hasAnyCallback()){i=i.concat(n.eventRegistrations_.slice(r+1));break}}else i.push(o)}n.eventRegistrations_=i}else n.eventRegistrations_=[];return s}function xi(n,e,t,s){e.type===q.MERGE&&null!==e.source.queryId&&((0,c.vA)(Ee(n.viewCache_),"We should always have a full cache before handling merges"),(0,c.vA)(Dt(n.viewCache_),"Missing event cache, even though we have a server cache"));const i=n.viewCache_,r=function Vl(n,e,t,s,i){const r=new Fl;let o,l;if(t.type===q.OVERWRITE){const u=t;u.source.fromUser?o=Un(n,e,u.path,u.snap,s,i,r):((0,c.vA)(u.source.fromServer,"Unknown source."),l=u.source.tagged||e.serverCache.isFiltered()&&!v(u.path),o=Lt(n,e,u.path,u.snap,s,i,l,r))}else if(t.type===q.MERGE){const u=t;u.source.fromUser?o=function Hl(n,e,t,s,i,r,o){let l=e;return s.foreach((a,u)=>{const h=N(t,a);Ni(e,y(h))&&(l=Un(n,l,h,u,i,r,o))}),s.foreach((a,u)=>{const h=N(t,a);Ni(e,y(h))||(l=Un(n,l,h,u,i,r,o))}),l}(n,e,u.path,u.children,s,i,r):((0,c.vA)(u.source.fromServer,"Unknown source."),l=u.source.tagged||e.serverCache.isFiltered(),o=Vn(n,e,u.path,u.children,s,i,l,r))}else if(t.type===q.ACK_USER_WRITE){const u=t;o=u.revert?function Ql(n,e,t,s,i,r){let o;if(null!=Ft(s,t))return e;{const l=new Wn(s,e,i),a=e.eventCache.getNode();let u;if(v(t)||".priority"===y(t)){let h;if(e.serverCache.isFullyInitialized())h=Mt(s,Ee(e));else{const d=e.serverCache.getNode();(0,c.vA)(d instanceof m,"serverChildren would be complete if leaf node"),h=Fn(s,d)}u=n.filter.updateFullNode(a,h,r)}else{const h=y(t);let d=Ln(s,h,e.serverCache);null==d&&e.serverCache.isCompleteForChild(h)&&(d=a.getImmediateChild(h)),u=null!=d?n.filter.updateChild(a,h,d,S(t),l,r):e.eventCache.getNode().hasChild(h)?n.filter.updateChild(a,h,m.EMPTY_NODE,S(t),l,r):a,u.isEmpty()&&e.serverCache.isFullyInitialized()&&(o=Mt(s,Ee(e)),o.isLeafNode()&&(u=n.filter.updateFullNode(u,o,r)))}return o=e.serverCache.isFullyInitialized()||null!=Ft(s,T()),tt(e,u,o,n.filter.filtersNodes())}}(n,e,u.path,s,i,r):function Kl(n,e,t,s,i,r,o){if(null!=Ft(i,t))return e;const l=e.serverCache.isFiltered(),a=e.serverCache;if(null!=s.value){if(v(t)&&a.isFullyInitialized()||a.isCompleteForPath(t))return Lt(n,e,t,a.getNode().getChild(t),i,r,l,o);if(v(t)){let u=new b(null);return a.getNode().forEachChild(z,(h,d)=>{u=u.set(new I(h),d)}),Vn(n,e,t,u,i,r,l,o)}return e}{let u=new b(null);return s.foreach((h,d)=>{const f=N(t,h);a.isCompleteForPath(f)&&(u=u.set(h,a.getNode().getChild(f)))}),Vn(n,e,t,u,i,r,l,o)}}(n,e,u.path,u.affectedTree,s,i,r)}else{if(t.type!==q.LISTEN_COMPLETE)throw(0,c.Hk)("Unknown operation type: "+t.type);o=function Gl(n,e,t,s,i){const r=e.serverCache;return bi(n,mi(e,r.getNode(),r.isFullyInitialized()||v(t),r.isFiltered()),t,s,Ai,i)}(n,e,t.path,s,r)}const a=r.getChanges();return function Bl(n,e,t){const s=e.eventCache;if(s.isFullyInitialized()){const i=s.getNode().isLeafNode()||s.getNode().isEmpty(),r=Dt(n);(t.length>0||!n.eventCache.isFullyInitialized()||i&&!s.getNode().equals(r)||!s.getNode().getPriority().equals(r.getPriority()))&&t.push(fi(Dt(e)))}}(e,o,a),{viewCache:o,changes:a}}(n.processor_,i,e,t,s);return function Ul(n,e){(0,c.vA)(e.eventCache.getNode().isIndexed(n.filter.getIndex()),"Event snap not indexed"),(0,c.vA)(e.serverCache.getNode().isIndexed(n.filter.getIndex()),"Server snap not indexed")}(n.processor_,r.viewCache),(0,c.vA)(r.viewCache.serverCache.isFullyInitialized()||!i.serverCache.isFullyInitialized(),"Once a server snap is complete, it should never go back"),n.viewCache_=r.viewCache,Di(n,r.changes,r.viewCache.eventCache.getNode(),null)}function Di(n,e,t,s){return function yl(n,e,t,s){const i=[],r=[];return e.forEach(o=>{"child_changed"===o.type&&n.index_.indexedValueChanged(o.oldSnap,o.snapshotNode)&&r.push(function il(n,e){return{type:"child_moved",snapshotNode:e,childName:n}}(o.childName,o.snapshotNode))}),et(n,i,"child_removed",e,s,t),et(n,i,"child_added",e,s,t),et(n,i,"child_moved",r,s,t),et(n,i,"child_changed",e,s,t),et(n,i,"value",e,s,t),i}(n.eventGenerator_,e,t,s?[s]:n.eventRegistrations_)}let Wt,Vt;class Oi{constructor(){this.views=new Map}}function Bn(n,e,t,s){const i=e.source.queryId;if(null!==i){const r=n.views.get(i);return(0,c.vA)(null!=r,"SyncTree gave us an op for an invalid query."),xi(r,e,t,s)}{let r=[];for(const o of n.views.values())r=r.concat(xi(o,e,t,s));return r}}function Mi(n,e,t,s,i){const o=n.views.get(e._queryIdentifier);if(!o){let l=Mt(t,i?s:null),a=!1;l?a=!0:s instanceof m?(l=Fn(t,s),a=!1):(l=m.EMPTY_NODE,a=!1);const u=xt(new re(l,a,!1),new re(s,i,!1));return new Yl(e,u)}return o}function Fi(n){const e=[];for(const t of n.views.values())t.query._queryParams.loadsAllData()||e.push(t);return e}function le(n,e){let t=null;for(const s of n.views.values())t=t||zl(s,e);return t}function Li(n,e){return e._queryParams.loadsAllData()?Ut(n):n.views.get(e._queryIdentifier)}function Wi(n,e){return null!=Li(n,e)}function ae(n){return null!=Ut(n)}function Ut(n){for(const e of n.views.values())if(e.query._queryParams.loadsAllData())return e;return null}let ra=1;class Ui{constructor(e){this.listenProvider_=e,this.syncPointTree_=new b(null),this.pendingWriteTree_=function Ol(){return{visibleWrites:Q.empty(),allWrites:[],lastWriteId:-1}}(),this.tagToQueryMap=new Map,this.queryToTagMap=new Map}}function Hn(n,e,t,s,i){return function El(n,e,t,s,i){(0,c.vA)(s>n.lastWriteId,"Stacking an older write on top of newer ones"),void 0===i&&(i=!0),n.allWrites.push({path:e,snap:t,writeId:s,visible:i}),i&&(n.visibleWrites=nt(n.visibleWrites,e,t)),n.lastWriteId=s}(n.pendingWriteTree_,e,t,s,i),i?We(n,new we({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},e,t)):[]}function ce(n,e,t=!1){const s=function Il(n,e){for(let t=0;t<n.allWrites.length;t++){const s=n.allWrites[t];if(s.writeId===e)return s}return null}(n.pendingWriteTree_,e);if(function Sl(n,e){const t=n.allWrites.findIndex(l=>l.writeId===e);(0,c.vA)(t>=0,"removeWrite called with nonexistent writeId.");const s=n.allWrites[t];n.allWrites.splice(t,1);let i=s.visible,r=!1,o=n.allWrites.length-1;for(;i&&o>=0;){const l=n.allWrites[o];l.visible&&(o>=t&&Al(l,s.path)?i=!1:V(s.path,l.path)&&(r=!0)),o--}return!!i&&(r?(function bl(n){n.visibleWrites=wi(n.allWrites,Nl,T()),n.lastWriteId=n.allWrites.length>0?n.allWrites[n.allWrites.length-1].writeId:-1}(n),!0):(s.snap?n.visibleWrites=yi(n.visibleWrites,s.path):x(s.children,a=>{n.visibleWrites=yi(n.visibleWrites,N(s.path,a))}),!0))}(n.pendingWriteTree_,e)){let r=new b(null);return null!=s.snap?r=r.set(T(),!0):x(s.children,o=>{r=r.set(new I(o),!0)}),We(n,new kt(s.path,r,t))}return[]}function st(n,e,t){return We(n,new we({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e,t))}function Bt(n,e,t,s,i=!1){const r=e._path,o=n.syncPointTree_.get(r);let l=[];if(o&&("default"===e._queryIdentifier||Wi(o,e))){const a=function na(n,e,t,s){const i=e._queryIdentifier,r=[];let o=[];const l=ae(n);if("default"===i)for(const[a,u]of n.views.entries())o=o.concat(ki(u,t,s)),Pi(u)&&(n.views.delete(a),u.query._queryParams.loadsAllData()||r.push(u.query));else{const a=n.views.get(i);a&&(o=o.concat(ki(a,t,s)),Pi(a)&&(n.views.delete(i),a.query._queryParams.loadsAllData()||r.push(a.query)))}return l&&!ae(n)&&r.push(new(function Zl(){return(0,c.vA)(Wt,"Reference.ts has not been loaded"),Wt}())(e._repo,e._path)),{removed:r,events:o}}(o,e,t,s);(function ea(n){return 0===n.views.size})(o)&&(n.syncPointTree_=n.syncPointTree_.remove(r));const u=a.removed;if(l=a.events,!i){const h=-1!==u.findIndex(f=>f._queryParams.loadsAllData()),d=n.syncPointTree_.findOnPath(r,(f,_)=>ae(_));if(h&&!d){const f=n.syncPointTree_.subtree(r);if(!f.isEmpty()){const _=function da(n){return n.fold((e,t,s)=>{if(t&&ae(t))return[Ut(t)];{let i=[];return t&&(i=Fi(t)),x(s,(r,o)=>{i=i.concat(o)}),i}})}(f);for(let p=0;p<_.length;++p){const E=_[p],P=E.query,be=Ki(n,E);n.listenProvider_.startListening(rt(P),it(n,P),be.hashFn,be.onComplete)}}}!d&&u.length>0&&!s&&(h?n.listenProvider_.stopListening(rt(e),null):u.forEach(f=>{const _=n.queryToTagMap.get(Kt(f));n.listenProvider_.stopListening(rt(f),_)}))}!function fa(n,e){for(let t=0;t<e.length;++t){const s=e[t];if(!s._queryParams.loadsAllData()){const i=Kt(s),r=n.queryToTagMap.get(i);n.queryToTagMap.delete(i),n.tagToQueryMap.delete(r)}}}(n,u)}return l}function Vi(n,e,t,s){const i=Gn(n,s);if(null!=i){const r=Qn(i),o=r.path,l=r.queryId,a=M(o,e);return Yn(n,o,new we(kn(l),a,t))}return[]}function Kn(n,e,t,s=!1){const i=e._path;let r=null,o=!1;n.syncPointTree_.foreachOnPath(i,(f,_)=>{const p=M(f,i);r=r||le(_,p),o=o||ae(_)});let a,l=n.syncPointTree_.get(i);l?(o=o||ae(l),r=r||le(l,T())):(l=new Oi,n.syncPointTree_=n.syncPointTree_.set(i,l)),null!=r?a=!0:(a=!1,r=m.EMPTY_NODE,n.syncPointTree_.subtree(i).foreachChild((_,p)=>{const E=le(p,T());E&&(r=r.updateImmediateChild(_,E))}));const u=Wi(l,e);if(!u&&!e._queryParams.loadsAllData()){const f=Kt(e);(0,c.vA)(!n.queryToTagMap.has(f),"View does not exist, but we have a tag");const _=function _a(){return ra++}();n.queryToTagMap.set(f,_),n.tagToQueryMap.set(_,f)}let d=function ta(n,e,t,s,i,r){const o=Mi(n,e,s,i,r);return n.views.has(e._queryIdentifier)||n.views.set(e._queryIdentifier,o),function ql(n,e){n.eventRegistrations_.push(e)}(o,t),function Xl(n,e){const t=n.viewCache_.eventCache,s=[];return t.getNode().isLeafNode()||t.getNode().forEachChild(A,(r,o)=>{s.push(Oe(r,o))}),t.isFullyInitialized()&&s.push(fi(t.getNode())),Di(n,s,t.getNode(),e)}(o,t)}(l,e,t,Ot(n.pendingWriteTree_,i),r,a);if(!u&&!o&&!s){const f=Li(l,e);d=d.concat(function pa(n,e,t){const s=e._path,i=it(n,e),r=Ki(n,t),o=n.listenProvider_.startListening(rt(e),i,r.hashFn,r.onComplete),l=n.syncPointTree_.subtree(s);if(i)(0,c.vA)(!ae(l.value),"If we're adding a query, it shouldn't be shadowed");else{const a=l.fold((u,h,d)=>{if(!v(u)&&h&&ae(h))return[Ut(h).query];{let f=[];return h&&(f=f.concat(Fi(h).map(_=>_.query))),x(d,(_,p)=>{f=f.concat(p)}),f}});for(let u=0;u<a.length;++u){const h=a[u];n.listenProvider_.stopListening(rt(h),it(n,h))}}return o}(n,e,f))}return d}function Ht(n,e,t){const i=n.pendingWriteTree_,r=n.syncPointTree_.findOnPath(e,(o,l)=>{const u=le(l,M(o,e));if(u)return u});return Ei(i,e,r,t,!0)}function We(n,e){return Bi(e,n.syncPointTree_,null,Ot(n.pendingWriteTree_,T()))}function Bi(n,e,t,s){if(v(n.path))return Hi(n,e,t,s);{const i=e.get(T());null==t&&null!=i&&(t=le(i,T()));let r=[];const o=y(n.path),l=n.operationForChild(o),a=e.children.get(o);if(a&&l){const u=t?t.getImmediateChild(o):null,h=Ii(s,o);r=r.concat(Bi(l,a,u,h))}return i&&(r=r.concat(Bn(i,n,s,t))),r}}function Hi(n,e,t,s){const i=e.get(T());null==t&&null!=i&&(t=le(i,T()));let r=[];return e.children.inorderTraversal((o,l)=>{const a=t?t.getImmediateChild(o):null,u=Ii(s,o),h=n.operationForChild(o);h&&(r=r.concat(Hi(h,l,a,u)))}),i&&(r=r.concat(Bn(i,n,s,t))),r}function Ki(n,e){const t=e.query,s=it(n,t);return{hashFn:()=>(function jl(n){return n.viewCache_.serverCache.getNode()}(e)||m.EMPTY_NODE).hash(),onComplete:i=>{if("ok"===i)return s?function ca(n,e,t){const s=Gn(n,t);if(s){const i=Qn(s),r=i.path,o=i.queryId,l=M(r,e);return Yn(n,r,new Ze(kn(o),l))}return[]}(n,t._path,s):function aa(n,e){return We(n,new Ze({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e))}(n,t._path);{const r=function oo(n,e){let t="Unknown Error";"too_big"===n?t="The data requested exceeds the maximum size that can be accessed with a single request.":"permission_denied"===n?t="Client doesn't have permission to access the desired data.":"unavailable"===n&&(t="The service is unavailable");const s=new Error(n+" at "+e._path.toString()+": "+t);return s.code=n.toUpperCase(),s}(i,t);return Bt(n,t,null,r)}}}}function it(n,e){const t=Kt(e);return n.queryToTagMap.get(t)}function Kt(n){return n._path.toString()+"$"+n._queryIdentifier}function Gn(n,e){return n.tagToQueryMap.get(e)}function Qn(n){const e=n.indexOf("$");return(0,c.vA)(-1!==e&&e<n.length-1,"Bad queryKey."),{queryId:n.substr(e+1),path:new I(n.substr(0,e))}}function Yn(n,e,t){const s=n.syncPointTree_.get(e);return(0,c.vA)(s,"Missing sync point for query tag that we're tracking"),Bn(s,t,Ot(n.pendingWriteTree_,e),null)}function rt(n){return n._queryParams.loadsAllData()&&!n._queryParams.isDefault()?new(function ia(){return(0,c.vA)(Vt,"Reference.ts has not been loaded"),Vt}())(n._repo,n._path):n}class jn{constructor(e){this.node_=e}getImmediateChild(e){const t=this.node_.getImmediateChild(e);return new jn(t)}node(){return this.node_}}class $n{constructor(e,t){this.syncTree_=e,this.path_=t}getImmediateChild(e){const t=N(this.path_,e);return new $n(this.syncTree_,t)}node(){return Ht(this.syncTree_,this.path_)}}const ga=function(n){return(n=n||{}).timestamp=n.timestamp||(new Date).getTime(),n},Gi=function(n,e,t){return n&&"object"==typeof n?((0,c.vA)(".sv"in n,"Unexpected leaf node or priority contents"),"string"==typeof n[".sv"]?ma(n[".sv"],e,t):"object"==typeof n[".sv"]?ya(n[".sv"],e):void(0,c.vA)(!1,"Unexpected server value: "+JSON.stringify(n,null,2))):n},ma=function(n,e,t){if("timestamp"===n)return t.timestamp;(0,c.vA)(!1,"Unexpected server value: "+n)},ya=function(n,e,t){n.hasOwnProperty("increment")||(0,c.vA)(!1,"Unexpected server value: "+JSON.stringify(n,null,2));const s=n.increment;"number"!=typeof s&&(0,c.vA)(!1,"Unexpected increment value: "+s);const i=e.node();if((0,c.vA)(null!==i&&typeof i<"u","Expected ChildrenNode.EMPTY_NODE for nulls"),!i.isLeafNode())return s;const o=i.getValue();return"number"!=typeof o?s:o+s},Qi=function(n,e,t,s){return qn(e,new $n(t,n),s)},zn=function(n,e,t){return qn(n,new jn(e),t)};function qn(n,e,t){const s=n.getPriority().val(),i=Gi(s,e.getImmediateChild(".priority"),t);let r;if(n.isLeafNode()){const o=n,l=Gi(o.getValue(),e,t);return l!==o.getValue()||i!==o.getPriority().val()?new xe(l,R(i)):n}{const o=n;return r=o,i!==o.getPriority().val()&&(r=r.updatePriority(new xe(i))),o.forEachChild(A,(l,a)=>{const u=qn(a,e.getImmediateChild(l),t);u!==a&&(r=r.updateImmediateChild(l,u))}),r}}class Xn{constructor(e="",t=null,s={children:{},childCount:0}){this.name=e,this.parent=t,this.node=s}}function Gt(n,e){let t=e instanceof I?e:new I(e),s=n,i=y(t);for(;null!==i;){const r=(0,c.yw)(s.node.children,i)||{children:{},childCount:0};s=new Xn(i,s,r),t=S(t),i=y(t)}return s}function Ie(n){return n.node.value}function Jn(n,e){n.node.value=e,Zn(n)}function Yi(n){return n.node.childCount>0}function Qt(n,e){x(n.node.children,(t,s)=>{e(new Xn(t,n,s))})}function ji(n,e,t,s){t&&!s&&e(n),Qt(n,i=>{ji(i,e,!0,s)}),t&&s&&e(n)}function ot(n){return new I(null===n.parent?n.name:ot(n.parent)+"/"+n.name)}function Zn(n){null!==n.parent&&function wa(n,e,t){const s=function va(n){return void 0===Ie(n)&&!Yi(n)}(t),i=(0,c.gR)(n.node.children,e);s&&i?(delete n.node.children[e],n.node.childCount--,Zn(n)):!s&&!i&&(n.node.children[e]=t.node,n.node.childCount++,Zn(n))}(n.parent,n.name,n)}const Ea=/[\[\].#$\/\u0000-\u001F\u007F]/,Ta=/[\[\].#$\u0000-\u001F\u007F]/,es=10485760,Yt=function(n){return"string"==typeof n&&0!==n.length&&!Ea.test(n)},$i=function(n){return"string"==typeof n&&0!==n.length&&!Ta.test(n)},lt=function(n){return null===n||"string"==typeof n||"number"==typeof n&&!vt(n)||n&&"object"==typeof n&&(0,c.gR)(n,".sv")},X=function(n,e,t,s){s&&void 0===e||at((0,c.dI)(n,"value"),e,t)},at=function(n,e,t){const s=t instanceof I?new Vo(t,n):t;if(void 0===e)throw new Error(n+"contains undefined "+ve(s));if("function"==typeof e)throw new Error(n+"contains a function "+ve(s)+" with contents = "+e.toString());if(vt(e))throw new Error(n+"contains "+e.toString()+" "+ve(s));if("string"==typeof e&&e.length>es/3&&(0,c.OE)(e)>es)throw new Error(n+"contains a string greater than "+es+" utf8 bytes "+ve(s)+" ('"+e.substring(0,50)+"...')");if(e&&"object"==typeof e){let i=!1,r=!1;if(x(e,(o,l)=>{if(".value"===o)i=!0;else if(".priority"!==o&&".sv"!==o&&(r=!0,!Yt(o)))throw new Error(n+" contains an invalid key ("+o+") "+ve(s)+'.  Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"');(function Bo(n,e){n.parts_.length>0&&(n.byteLength_+=1),n.parts_.push(e),n.byteLength_+=(0,c.OE)(e),ii(n)})(s,o),at(n,l,s),function Ho(n){const e=n.parts_.pop();n.byteLength_-=(0,c.OE)(e),n.parts_.length>0&&(n.byteLength_-=1)}(s)}),i&&r)throw new Error(n+' contains ".value" child '+ve(s)+" in addition to actual children.")}},zi=function(n,e,t,s){if(s&&void 0===e)return;const i=(0,c.dI)(n,"values");if(!e||"object"!=typeof e||Array.isArray(e))throw new Error(i+" must be an object containing the children to replace.");const r=[];x(e,(o,l)=>{const a=new I(o);if(at(i,l,N(t,a)),".priority"===gn(a)&&!lt(l))throw new Error(i+"contains an invalid value for '"+a.toString()+"', which must be a valid Firebase priority (a string, finite number, server value, or null).");r.push(a)}),function(n,e){let t,s;for(t=0;t<e.length;t++){s=e[t];const r=Ye(s);for(let o=0;o<r.length;o++)if((".priority"!==r[o]||o!==r.length-1)&&!Yt(r[o]))throw new Error(n+"contains an invalid key ("+r[o]+") in path "+s.toString()+'. Keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]"')}e.sort(Uo);let i=null;for(t=0;t<e.length;t++){if(s=e[t],null!==i&&V(i,s))throw new Error(n+"contains a path "+i.toString()+" that is ancestor of another path "+s.toString());i=s}}(i,r)},ts=function(n,e,t){if(!t||void 0!==e){if(vt(e))throw new Error((0,c.dI)(n,"priority")+"is "+e.toString()+", but must be a valid Firebase priority (a string, finite number, server value, or null).");if(!lt(e))throw new Error((0,c.dI)(n,"priority")+"must be a valid Firebase priority (a string, finite number, server value, or null).")}},ct=function(n,e,t,s){if(!(s&&void 0===t||Yt(t)))throw new Error((0,c.dI)(n,e)+'was an invalid key = "'+t+'".  Firebase keys must be non-empty strings and can\'t contain ".", "#", "$", "/", "[", or "]").')},ut=function(n,e,t,s){if(!(s&&void 0===t||$i(t)))throw new Error((0,c.dI)(n,e)+'was an invalid path = "'+t+'". Paths must be non-empty strings and can\'t contain ".", "#", "$", "[", or "]"')},Aa=function(n,e,t,s){t&&(t=t.replace(/^\/*\.info(\/|$)/,"/")),ut(n,e,t,s)},B=function(n,e){if(".info"===y(e))throw new Error(n+" failed = Can't modify data under /.info/")},qi=function(n,e){const t=e.path.toString();if("string"!=typeof e.repoInfo.host||0===e.repoInfo.host.length||!Yt(e.repoInfo.namespace)&&"localhost"!==e.repoInfo.host.split(":")[0]||0!==t.length&&!function(n){return n&&(n=n.replace(/^\/*\.info(\/|$)/,"/")),$i(n)}(t))throw new Error((0,c.dI)(n,"url")+'must be a valid firebase URL and the path can\'t contain ".", "#", "$", "[", or "]".')};class ba{constructor(){this.eventLists_=[],this.recursionDepth_=0}}function jt(n,e){let t=null;for(let s=0;s<e.length;s++){const i=e[s],r=i.getPath();null!==t&&!mn(r,t.path)&&(n.eventLists_.push(t),t=null),null===t&&(t={events:[],path:r}),t.events.push(i)}t&&n.eventLists_.push(t)}function Xi(n,e,t){jt(n,t),Ji(n,s=>mn(s,e))}function W(n,e,t){jt(n,t),Ji(n,s=>V(s,e)||V(e,s))}function Ji(n,e){n.recursionDepth_++;let t=!0;for(let s=0;s<n.eventLists_.length;s++){const i=n.eventLists_[s];i&&(e(i.path)?(Na(n.eventLists_[s]),n.eventLists_[s]=null):t=!1)}t&&(n.eventLists_=[]),n.recursionDepth_--}function Na(n){for(let e=0;e<n.events.length;e++){const t=n.events[e];if(null!==t){n.events[e]=null;const s=t.getEventRunner();me&&k("event: "+t.toString()),Pe(s)}}}const Zi="repo_interrupt",Ra=25;class Pa{constructor(e,t,s,i){this.repoInfo_=e,this.forceRestClient_=t,this.authTokenProvider_=s,this.appCheckProvider_=i,this.dataUpdateCount=0,this.statsListener_=null,this.eventQueue_=new ba,this.nextWriteId_=1,this.interceptServerDataCallback_=null,this.onDisconnect_=Pt(),this.transactionQueueTree_=new Xn,this.persistentConnection_=null,this.key=this.repoInfo_.toURLString()}toString(){return(this.repoInfo_.secure?"https://":"http://")+this.repoInfo_.host}}function er(n){const t=n.infoData_.getNode(new I(".info/serverTimeOffset")).val()||0;return(new Date).getTime()+t}function ht(n){return ga({timestamp:er(n)})}function tr(n,e,t,s,i){n.dataUpdateCount++;const r=new I(e);t=n.interceptServerDataCallback_?n.interceptServerDataCallback_(e,t):t;let o=[];if(i)if(s){const a=(0,c.kH)(t,u=>R(u));o=function ua(n,e,t,s){const i=Gn(n,s);if(i){const r=Qn(i),o=r.path,l=r.queryId,a=M(o,e),u=b.fromObject(t);return Yn(n,o,new Fe(kn(l),a,u))}return[]}(n.serverSyncTree_,r,a,i)}else{const a=R(t);o=Vi(n.serverSyncTree_,r,a,i)}else if(s){const a=(0,c.kH)(t,u=>R(u));o=function la(n,e,t){const s=b.fromObject(t);return We(n,new Fe({fromUser:!1,fromServer:!0,queryId:null,tagged:!1},e,s))}(n.serverSyncTree_,r,a)}else{const a=R(t);o=st(n.serverSyncTree_,r,a)}let l=r;o.length>0&&(l=Ve(n,r)),W(n.eventQueue_,l,o)}function nr(n,e){ns(n,"connected",e),!1===e&&function Ma(n){Ue(n,"onDisconnectEvents");const e=ht(n),t=Pt();Nn(n.onDisconnect_,T(),(i,r)=>{const o=Qi(i,r,n.serverSyncTree_,e);Me(t,i,o)});let s=[];Nn(t,T(),(i,r)=>{s=s.concat(st(n.serverSyncTree_,i,r));const o=os(n,i);Ve(n,o)}),n.onDisconnect_=Pt(),W(n.eventQueue_,T(),s)}(n)}function ns(n,e,t){const s=new I("/.info/"+e),i=R(t);n.infoData_.updateSnapshot(s,i);const r=st(n.infoSyncTree_,s,i);W(n.eventQueue_,s,r)}function $t(n){return n.nextWriteId_++}function ss(n,e,t,s,i){Ue(n,"set",{path:e.toString(),value:t,priority:s});const r=ht(n),o=R(t,s),l=Ht(n.serverSyncTree_,e),a=zn(o,l,r),u=$t(n),h=Hn(n.serverSyncTree_,e,a,u,!0);jt(n.eventQueue_,h),n.server_.put(e.toString(),o.val(!0),(f,_)=>{const p="ok"===f;p||O("set at "+e+" failed: "+f);const E=ce(n.serverSyncTree_,u,!p);W(n.eventQueue_,e,E),ue(0,i,f,_)});const d=os(n,e);Ve(n,d),W(n.eventQueue_,d,[])}function Fa(n,e,t){n.server_.onDisconnectCancel(e.toString(),(s,i)=>{"ok"===s&&bn(n.onDisconnect_,e),ue(0,t,s,i)})}function sr(n,e,t,s){const i=R(t);n.server_.onDisconnectPut(e.toString(),i.val(!0),(r,o)=>{"ok"===r&&Me(n.onDisconnect_,e,i),ue(0,s,r,o)})}function is(n,e,t){let s;s=".info"===y(e._path)?Bt(n.infoSyncTree_,e,t):Bt(n.serverSyncTree_,e,t),Xi(n.eventQueue_,e._path,s)}function ir(n){n.persistentConnection_&&n.persistentConnection_.interrupt(Zi)}function Ue(n,...e){let t="";n.persistentConnection_&&(t=n.persistentConnection_.id+":"),k(t,...e)}function ue(n,e,t,s){e&&Pe(()=>{if("ok"===t)e(null);else{const i=(t||"error").toUpperCase();let r=i;s&&(r+=": "+s);const o=new Error(r);o.code=i,e(o)}})}function rs(n,e,t){return Ht(n.serverSyncTree_,e,t)||m.EMPTY_NODE}function zt(n,e=n.transactionQueueTree_){if(e||qt(n,e),Ie(e)){const t=or(n,e);(0,c.vA)(t.length>0,"Sending zero length transaction queue"),t.every(i=>0===i.status)&&function Ha(n,e,t){const s=t.map(u=>u.currentWriteId),i=rs(n,e,s);let r=i;const o=i.hash();for(let u=0;u<t.length;u++){const h=t[u];(0,c.vA)(0===h.status,"tryToSendTransactionQueue_: items in queue should all be run."),h.status=1,h.retryCount++;const d=M(e,h.path);r=r.updateChild(d,h.currentOutputSnapshotRaw)}const l=r.val(!0),a=e;n.server_.put(a.toString(),l,u=>{Ue(n,"transaction put response",{path:a.toString(),status:u});let h=[];if("ok"===u){const d=[];for(let f=0;f<t.length;f++)t[f].status=2,h=h.concat(ce(n.serverSyncTree_,t[f].currentWriteId)),t[f].onComplete&&d.push(()=>t[f].onComplete(null,!0,t[f].currentOutputSnapshotResolved)),t[f].unwatcher();qt(n,Gt(n.transactionQueueTree_,e)),zt(n,n.transactionQueueTree_),W(n.eventQueue_,e,h);for(let f=0;f<d.length;f++)Pe(d[f])}else{if("datastale"===u)for(let d=0;d<t.length;d++)t[d].status=3===t[d].status?4:0;else{O("transaction at "+a.toString()+" failed: "+u);for(let d=0;d<t.length;d++)t[d].status=4,t[d].abortReason=u}Ve(n,e)}},o)}(n,ot(e),t)}else Yi(e)&&Qt(e,t=>{zt(n,t)})}function Ve(n,e){const t=rr(n,e),s=ot(t);return function Ka(n,e,t){if(0===e.length)return;const s=[];let i=[];const o=e.filter(l=>0===l.status).map(l=>l.currentWriteId);for(let l=0;l<e.length;l++){const a=e[l],u=M(t,a.path);let d,h=!1;if((0,c.vA)(null!==u,"rerunTransactionsUnderNode_: relativePath should not be null."),4===a.status)h=!0,d=a.abortReason,i=i.concat(ce(n.serverSyncTree_,a.currentWriteId,!0));else if(0===a.status)if(a.retryCount>=Ra)h=!0,d="maxretry",i=i.concat(ce(n.serverSyncTree_,a.currentWriteId,!0));else{const f=rs(n,a.path,o);a.currentInputSnapshot=f;const _=e[l].update(f.val());if(void 0!==_){at("transaction failed: Data returned ",_,a.path);let p=R(_);"object"==typeof _&&null!=_&&(0,c.gR)(_,".priority")||(p=p.updatePriority(f.getPriority()));const P=a.currentWriteId,be=ht(n),fe=zn(p,f,be);a.currentOutputSnapshotRaw=p,a.currentOutputSnapshotResolved=fe,a.currentWriteId=$t(n),o.splice(o.indexOf(P),1),i=i.concat(Hn(n.serverSyncTree_,a.path,fe,a.currentWriteId,a.applyLocally)),i=i.concat(ce(n.serverSyncTree_,P,!0))}else h=!0,d="nodata",i=i.concat(ce(n.serverSyncTree_,a.currentWriteId,!0))}W(n.eventQueue_,t,i),i=[],h&&(e[l].status=2,setTimeout(e[l].unwatcher,Math.floor(0)),e[l].onComplete&&s.push("nodata"===d?()=>e[l].onComplete(null,!1,e[l].currentInputSnapshot):()=>e[l].onComplete(new Error(d),!1,null)))}qt(n,n.transactionQueueTree_);for(let l=0;l<s.length;l++)Pe(s[l]);zt(n,n.transactionQueueTree_)}(n,or(n,t),s),s}function rr(n,e){let t,s=n.transactionQueueTree_;for(t=y(e);null!==t&&void 0===Ie(s);)s=Gt(s,t),t=y(e=S(e));return s}function or(n,e){const t=[];return lr(n,e,t),t.sort((s,i)=>s.order-i.order),t}function lr(n,e,t){const s=Ie(e);if(s)for(let i=0;i<s.length;i++)t.push(s[i]);Qt(e,i=>{lr(n,i,t)})}function qt(n,e){const t=Ie(e);if(t){let s=0;for(let i=0;i<t.length;i++)2!==t[i].status&&(t[s]=t[i],s++);t.length=s,Jn(e,t.length>0?t:void 0)}Qt(e,s=>{qt(n,s)})}function os(n,e){const t=ot(rr(n,e)),s=Gt(n.transactionQueueTree_,e);return function Ca(n,e,t){let s=t?n:n.parent;for(;null!==s;){if(e(s))return!0;s=s.parent}}(s,i=>{ls(n,i)}),ls(n,s),ji(s,i=>{ls(n,i)}),t}function ls(n,e){const t=Ie(e);if(t){const s=[];let i=[],r=-1;for(let o=0;o<t.length;o++)3===t[o].status||(1===t[o].status?((0,c.vA)(r===o-1,"All SENT items should be at beginning of queue."),r=o,t[o].status=3,t[o].abortReason="set"):((0,c.vA)(0===t[o].status,"Unexpected transaction status in abort"),t[o].unwatcher(),i=i.concat(ce(n.serverSyncTree_,t[o].currentWriteId,!0)),t[o].onComplete&&s.push(t[o].onComplete.bind(null,new Error("set"),!1,null))));-1===r?Jn(e,void 0):t.length=r+1,W(n.eventQueue_,ot(e),i);for(let o=0;o<s.length;o++)Pe(s[o])}}const as=function(n,e){const t=Ya(n),s=t.namespace;return"firebase.com"===t.domain&&$(t.host+" is no longer supported. Please use <YOUR FIREBASE>.firebaseio.com instead"),(!s||"undefined"===s)&&"localhost"!==t.domain&&$("Cannot parse Firebase url. Please use https://<YOUR FIREBASE>.firebaseio.com"),t.secure||typeof window<"u"&&window.location&&window.location.protocol&&-1!==window.location.protocol.indexOf("https:")&&O("Insecure Firebase access from a secure page. Please use https in calls to new Firebase()."),{repoInfo:new un(t.host,t.secure,s,"ws"===t.scheme||"wss"===t.scheme,e,"",s!==t.subdomain),path:new I(t.pathString)}},Ya=function(n){let e="",t="",s="",i="",r="",o=!0,l="https",a=443;if("string"==typeof n){let u=n.indexOf("//");u>=0&&(l=n.substring(0,u-1),n=n.substring(u+2));let h=n.indexOf("/");-1===h&&(h=n.length);let d=n.indexOf("?");-1===d&&(d=n.length),e=n.substring(0,Math.min(h,d)),h<d&&(i=function Ga(n){let e="";const t=n.split("/");for(let s=0;s<t.length;s++)if(t[s].length>0){let i=t[s];try{i=decodeURIComponent(i.replace(/\+/g," "))}catch{}e+="/"+i}return e}(n.substring(h,d)));const f=function Qa(n){const e={};"?"===n.charAt(0)&&(n=n.substring(1));for(const t of n.split("&")){if(0===t.length)continue;const s=t.split("=");2===s.length?e[decodeURIComponent(s[0])]=decodeURIComponent(s[1]):O(`Invalid query segment '${t}' in query '${n}'`)}return e}(n.substring(Math.min(n.length,d)));u=e.indexOf(":"),u>=0?(o="https"===l||"wss"===l,a=parseInt(e.substring(u+1),10)):u=e.length;const _=e.slice(0,u);if("localhost"===_.toLowerCase())t="localhost";else if(_.split(".").length<=2)t=_;else{const p=e.indexOf(".");s=e.substring(0,p).toLowerCase(),t=e.substring(p+1),r=s}"ns"in f&&(r=f.ns)}return{host:e,port:a,domain:t,subdomain:s,secure:o,scheme:l,pathString:i,namespace:r}},ar="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",ja=function(){let n=0;const e=[];return function(t){const s=t===n;let i;n=t;const r=new Array(8);for(i=7;i>=0;i--)r[i]=ar.charAt(t%64),t=Math.floor(t/64);(0,c.vA)(0===t,"Cannot push at time == 0");let o=r.join("");if(s){for(i=11;i>=0&&63===e[i];i--)e[i]=0;e[i]++}else for(i=0;i<12;i++)e[i]=Math.floor(64*Math.random());for(i=0;i<12;i++)o+=ar.charAt(e[i]);return(0,c.vA)(20===o.length,"nextPushId: Length should be 20."),o}}();class cr{constructor(e,t,s,i){this.eventType=e,this.eventRegistration=t,this.snapshot=s,this.prevName=i}getPath(){const e=this.snapshot.ref;return"value"===this.eventType?e._path:e.parent._path}getEventType(){return this.eventType}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.getPath().toString()+":"+this.eventType+":"+(0,c.As)(this.snapshot.exportVal())}}class ur{constructor(e,t,s){this.eventRegistration=e,this.error=t,this.path=s}getPath(){return this.path}getEventType(){return"cancel"}getEventRunner(){return this.eventRegistration.getEventRunner(this)}toString(){return this.path.toString()+":cancel"}}class cs{constructor(e,t){this.snapshotCallback=e,this.cancelCallback=t}onValue(e,t){this.snapshotCallback.call(null,e,t)}onCancel(e){return(0,c.vA)(this.hasCancelCallback,"Raising a cancel event on a listener with no cancel callback"),this.cancelCallback.call(null,e)}get hasCancelCallback(){return!!this.cancelCallback}matches(e){return this.snapshotCallback===e.snapshotCallback||void 0!==this.snapshotCallback.userCallback&&this.snapshotCallback.userCallback===e.snapshotCallback.userCallback&&this.snapshotCallback.context===e.snapshotCallback.context}}class hr{constructor(e,t){this._repo=e,this._path=t}cancel(){const e=new c.cY;return Fa(this._repo,this._path,e.wrapCallback(()=>{})),e.promise}remove(){B("OnDisconnect.remove",this._path);const e=new c.cY;return sr(this._repo,this._path,null,e.wrapCallback(()=>{})),e.promise}set(e){B("OnDisconnect.set",this._path),X("OnDisconnect.set",e,this._path,!1);const t=new c.cY;return sr(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}setWithPriority(e,t){B("OnDisconnect.setWithPriority",this._path),X("OnDisconnect.setWithPriority",e,this._path,!1),ts("OnDisconnect.setWithPriority",t,!1);const s=new c.cY;return function La(n,e,t,s,i){const r=R(t,s);n.server_.onDisconnectPut(e.toString(),r.val(!0),(o,l)=>{"ok"===o&&Me(n.onDisconnect_,e,r),ue(0,i,o,l)})}(this._repo,this._path,e,t,s.wrapCallback(()=>{})),s.promise}update(e){B("OnDisconnect.update",this._path),zi("OnDisconnect.update",e,this._path,!1);const t=new c.cY;return function Wa(n,e,t,s){if((0,c.Im)(t))return k("onDisconnect().update() called with empty data.  Don't do anything."),void ue(0,s,"ok",void 0);n.server_.onDisconnectMerge(e.toString(),t,(i,r)=>{"ok"===i&&x(t,(o,l)=>{const a=R(l);Me(n.onDisconnect_,N(e,o),a)}),ue(0,s,i,r)})}(this._repo,this._path,e,t.wrapCallback(()=>{})),t.promise}}class L{constructor(e,t,s,i){this._repo=e,this._path=t,this._queryParams=s,this._orderByCalled=i}get key(){return v(this._path)?null:gn(this._path)}get ref(){return new H(this._repo,this._path)}get _queryIdentifier(){const e=pi(this._queryParams),t=an(e);return"{}"===t?"default":t}get _queryObject(){return pi(this._queryParams)}isEqual(e){if(!((e=(0,c.Ku)(e))instanceof L))return!1;const t=this._repo===e._repo,s=mn(this._path,e._path);return t&&s&&this._queryIdentifier===e._queryIdentifier}toJSON(){return this.toString()}toString(){return this._repo.toString()+function Wo(n){let e="";for(let t=n.pieceNum_;t<n.pieces_.length;t++)""!==n.pieces_[t]&&(e+="/"+encodeURIComponent(String(n.pieces_[t])));return e||"/"}(this._path)}}function Xt(n,e){if(!0===n._orderByCalled)throw new Error(e+": You can't combine multiple orderBy calls.")}function he(n){let e=null,t=null;if(n.hasStart()&&(e=n.getIndexStartValue()),n.hasEnd()&&(t=n.getIndexEndValue()),n.getIndex()===z){const s="Query: When ordering by key, you may only pass one argument to startAt(), endAt(), or equalTo().",i="Query: When ordering by key, the argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() must be a string.";if(n.hasStart()){if(n.getIndexStartName()!==ne)throw new Error(s);if("string"!=typeof e)throw new Error(i)}if(n.hasEnd()){if(n.getIndexEndName()!==J)throw new Error(s);if("string"!=typeof t)throw new Error(i)}}else if(n.getIndex()===A){if(null!=e&&!lt(e)||null!=t&&!lt(t))throw new Error("Query: When ordering by priority, the first argument passed to startAt(), startAfter() endAt(), endBefore(), or equalTo() must be a valid priority value (null, a number, or a string).")}else if((0,c.vA)(n.getIndex()instanceof En||n.getIndex()===Tn,"unknown index type."),null!=e&&"object"==typeof e||null!=t&&"object"==typeof t)throw new Error("Query: First argument passed to startAt(), startAfter(), endAt(), endBefore(), or equalTo() cannot be an object.")}function Jt(n){if(n.hasStart()&&n.hasEnd()&&n.hasLimit()&&!n.hasAnchoredLimit())throw new Error("Query: Can't combine startAt(), startAfter(), endAt(), endBefore(), and limit(). Use limitToFirst() or limitToLast() instead.")}class H extends L{constructor(e,t){super(e,t,new bt,!1)}get parent(){const e=si(this._path);return null===e?null:new H(this._repo,e)}get root(){let e=this;for(;null!==e.parent;)e=e.parent;return e}}class Se{constructor(e,t,s){this._node=e,this.ref=t,this._index=s}get priority(){return this._node.getPriority().val()}get key(){return this.ref.key}get size(){return this._node.numChildren()}child(e){const t=new I(e),s=Ae(this.ref,e);return new Se(this._node.getChild(t),s,A)}exists(){return!this._node.isEmpty()}exportVal(){return this._node.val(!0)}forEach(e){return!this._node.isLeafNode()&&!!this._node.forEachChild(this._index,(s,i)=>e(new Se(i,Ae(this.ref,s),A)))}hasChild(e){const t=new I(e);return!this._node.getChild(t).isEmpty()}hasChildren(){return!this._node.isLeafNode()&&!this._node.isEmpty()}toJSON(){return this.exportVal()}val(){return this._node.val()}}function dr(n,e){return(n=(0,c.Ku)(n))._checkNotDeleted("ref"),void 0!==e?Ae(n._root,e):n._root}function fr(n,e){(n=(0,c.Ku)(n))._checkNotDeleted("refFromURL");const t=as(e,n._repo.repoInfo_.nodeAdmin);qi("refFromURL",t);const s=t.repoInfo;return!n._repo.repoInfo_.isCustomHost()&&s.host!==n._repo.repoInfo_.host&&$("refFromURL: Host name does not match the current database: (found "+s.host+" but expected "+n._repo.repoInfo_.host+")"),dr(n,t.path.toString())}function Ae(n,e){return null===y((n=(0,c.Ku)(n))._path)?Aa("child","path",e,!1):ut("child","path",e,!1),new H(n._repo,N(n._path,e))}function us(n,e){n=(0,c.Ku)(n),B("set",n._path),X("set",e,n._path,!1);const t=new c.cY;return ss(n._repo,n._path,e,null,t.wrapCallback(()=>{})),t.promise}function Ja(n,e){zi("update",e,n._path,!1);const t=new c.cY;return function Oa(n,e,t,s){Ue(n,"update",{path:e.toString(),value:t});let i=!0;const r=ht(n),o={};if(x(t,(l,a)=>{i=!1,o[l]=Qi(N(e,l),R(a),n.serverSyncTree_,r)}),i)k("update() called with empty data.  Don't do anything."),ue(0,s,"ok",void 0);else{const l=$t(n),a=function oa(n,e,t,s){!function Tl(n,e,t,s){(0,c.vA)(s>n.lastWriteId,"Stacking an older merge on top of newer ones"),n.allWrites.push({path:e,children:t,writeId:s,visible:!0}),n.visibleWrites=Dn(n.visibleWrites,e,t),n.lastWriteId=s}(n.pendingWriteTree_,e,t,s);const i=b.fromObject(t);return We(n,new Fe({fromUser:!0,fromServer:!1,queryId:null,tagged:!1},e,i))}(n.serverSyncTree_,e,o,l);jt(n.eventQueue_,a),n.server_.merge(e.toString(),t,(u,h)=>{const d="ok"===u;d||O("update at "+e+" failed: "+u);const f=ce(n.serverSyncTree_,l,!d),_=f.length>0?Ve(n,e):e;W(n.eventQueue_,_,f),ue(0,s,u,h)}),x(t,u=>{const h=os(n,N(e,u));Ve(n,h)}),W(n.eventQueue_,e,[])}}(n._repo,n._path,e,t.wrapCallback(()=>{})),t.promise}function Za(n){n=(0,c.Ku)(n);const e=new cs(()=>{}),t=new dt(e);return function Da(n,e,t){const s=function ha(n,e){const t=e._path;let s=null;n.syncPointTree_.foreachOnPath(t,(u,h)=>{const d=M(u,t);s=s||le(h,d)});let i=n.syncPointTree_.get(t);i?s=s||le(i,T()):(i=new Oi,n.syncPointTree_=n.syncPointTree_.set(t,i));const r=null!=s,o=r?new re(s,!0,!1):null;return function $l(n){return Dt(n.viewCache_)}(Mi(i,e,Ot(n.pendingWriteTree_,e._path),r?o.getNode():m.EMPTY_NODE,r))}(n.serverSyncTree_,e);return null!=s?Promise.resolve(s):n.server_.get(e).then(i=>{const r=R(i).withIndex(e._queryParams.getIndex());let o;if(Kn(n.serverSyncTree_,e,t,!0),e._queryParams.loadsAllData())o=st(n.serverSyncTree_,e._path,r);else{const l=it(n.serverSyncTree_,e);o=Vi(n.serverSyncTree_,e._path,r,l)}return W(n.eventQueue_,e._path,o),Bt(n.serverSyncTree_,e,t,null,!0),r},i=>(Ue(n,"get for query "+(0,c.As)(e)+" failed: "+i),Promise.reject(new Error(i))))}(n._repo,n,t).then(s=>new Se(s,new H(n._repo,n._path),n._queryParams.getIndex()))}class dt{constructor(e){this.callbackContext=e}respondsTo(e){return"value"===e}createEvent(e,t){const s=t._queryParams.getIndex();return new cr("value",this,new Se(e.snapshotNode,new H(t._repo,t._path),s))}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,null)}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ur(this,e,t):null}matches(e){return e instanceof dt&&(!e.callbackContext||!this.callbackContext||e.callbackContext.matches(this.callbackContext))}hasAnyCallback(){return null!==this.callbackContext}}class Zt{constructor(e,t){this.eventType=e,this.callbackContext=t}respondsTo(e){let t="children_added"===e?"child_added":e;return t="children_removed"===t?"child_removed":t,this.eventType===t}createCancelEvent(e,t){return this.callbackContext.hasCancelCallback?new ur(this,e,t):null}createEvent(e,t){(0,c.vA)(null!=e.childName,"Child events should have a childName.");const s=Ae(new H(t._repo,t._path),e.childName),i=t._queryParams.getIndex();return new cr(e.type,this,new Se(e.snapshotNode,s,i),e.prevName)}getEventRunner(e){return"cancel"===e.getEventType()?()=>this.callbackContext.onCancel(e.error):()=>this.callbackContext.onValue(e.snapshot,e.prevName)}matches(e){return e instanceof Zt&&this.eventType===e.eventType&&(!this.callbackContext||!e.callbackContext||this.callbackContext.matches(e.callbackContext))}hasAnyCallback(){return!!this.callbackContext}}function ft(n,e,t,s,i){let r;if("object"==typeof s&&(r=void 0,i=s),"function"==typeof s&&(r=s),i&&i.onlyOnce){const a=t,u=(h,d)=>{is(n._repo,n,l),a(h,d)};u.userCallback=t.userCallback,u.context=t.context,t=u}const o=new cs(t,r||void 0),l="value"===e?new dt(o):new Zt(e,o);return function Ua(n,e,t){let s;s=".info"===y(e._path)?Kn(n.infoSyncTree_,e,t):Kn(n.serverSyncTree_,e,t),Xi(n.eventQueue_,e._path,s)}(n._repo,n,l),()=>is(n._repo,n,l)}function hs(n,e,t,s){return ft(n,"value",e,t,s)}function _r(n,e,t,s){return ft(n,"child_added",e,t,s)}function pr(n,e,t,s){return ft(n,"child_changed",e,t,s)}function gr(n,e,t,s){return ft(n,"child_moved",e,t,s)}function mr(n,e,t,s){return ft(n,"child_removed",e,t,s)}function yr(n,e,t){let s=null;const i=t?new cs(t):null;"value"===e?s=new dt(i):e&&(s=new Zt(e,i)),is(n._repo,n,s)}class Y{}class vr extends Y{constructor(e,t){super(),this._value=e,this._key=t,this.type="endAt"}_apply(e){X("endAt",this._value,e._path,!0);const t=An(e._queryParams,this._value,this._key);if(Jt(t),he(t),e._queryParams.hasEnd())throw new Error("endAt: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new L(e._repo,e._path,t,e._orderByCalled)}}class tc extends Y{constructor(e,t){super(),this._value=e,this._key=t,this.type="endBefore"}_apply(e){X("endBefore",this._value,e._path,!1);const t=function ul(n,e,t){let s;return s=An(n,e,n.index_===z||t?t:ne),s.endBeforeSet_=!0,s}(e._queryParams,this._value,this._key);if(Jt(t),he(t),e._queryParams.hasEnd())throw new Error("endBefore: Starting point was already set (by another call to endAt, endBefore or equalTo).");return new L(e._repo,e._path,t,e._orderByCalled)}}class Cr extends Y{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAt"}_apply(e){X("startAt",this._value,e._path,!0);const t=Sn(e._queryParams,this._value,this._key);if(Jt(t),he(t),e._queryParams.hasStart())throw new Error("startAt: Starting point was already set (by another call to startAt, startBefore or equalTo).");return new L(e._repo,e._path,t,e._orderByCalled)}}class ic extends Y{constructor(e,t){super(),this._value=e,this._key=t,this.type="startAfter"}_apply(e){X("startAfter",this._value,e._path,!1);const t=function cl(n,e,t){let s;return s=Sn(n,e,n.index_===z||t?t:J),s.startAfterSet_=!0,s}(e._queryParams,this._value,this._key);if(Jt(t),he(t),e._queryParams.hasStart())throw new Error("startAfter: Starting point was already set (by another call to startAt, startAfter, or equalTo).");return new L(e._repo,e._path,t,e._orderByCalled)}}class oc extends Y{constructor(e){super(),this._limit=e,this.type="limitToFirst"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToFirst: Limit was already set (by another call to limitToFirst or limitToLast).");return new L(e._repo,e._path,function ll(n,e){const t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="l",t}(e._queryParams,this._limit),e._orderByCalled)}}class ac extends Y{constructor(e){super(),this._limit=e,this.type="limitToLast"}_apply(e){if(e._queryParams.hasLimit())throw new Error("limitToLast: Limit was already set (by another call to limitToFirst or limitToLast).");return new L(e._repo,e._path,function al(n,e){const t=n.copy();return t.limitSet_=!0,t.limit_=e,t.viewFrom_="r",t}(e._queryParams,this._limit),e._orderByCalled)}}class uc extends Y{constructor(e){super(),this._path=e,this.type="orderByChild"}_apply(e){Xt(e,"orderByChild");const t=new I(this._path);if(v(t))throw new Error("orderByChild: cannot pass in empty path. Use orderByValue() instead.");const s=new En(t),i=Nt(e._queryParams,s);return he(i),new L(e._repo,e._path,i,!0)}}class dc extends Y{constructor(){super(...arguments),this.type="orderByKey"}_apply(e){Xt(e,"orderByKey");const t=Nt(e._queryParams,z);return he(t),new L(e._repo,e._path,t,!0)}}class _c extends Y{constructor(){super(...arguments),this.type="orderByPriority"}_apply(e){Xt(e,"orderByPriority");const t=Nt(e._queryParams,A);return he(t),new L(e._repo,e._path,t,!0)}}class gc extends Y{constructor(){super(...arguments),this.type="orderByValue"}_apply(e){Xt(e,"orderByValue");const t=Nt(e._queryParams,Tn);return he(t),new L(e._repo,e._path,t,!0)}}class yc extends Y{constructor(e,t){super(),this._value=e,this._key=t,this.type="equalTo"}_apply(e){if(X("equalTo",this._value,e._path,!1),e._queryParams.hasStart())throw new Error("equalTo: Starting point was already set (by another call to startAt/startAfter or equalTo).");if(e._queryParams.hasEnd())throw new Error("equalTo: Ending point was already set (by another call to endAt/endBefore or equalTo).");return new vr(this._value,this._key)._apply(new Cr(this._value,this._key)._apply(e))}}function j(n,...e){let t=(0,c.Ku)(n);for(const s of e)t=s._apply(t);return t}(function Jl(n){(0,c.vA)(!Wt,"__referenceConstructor has already been defined"),Wt=n})(H),function sa(n){(0,c.vA)(!Vt,"__referenceConstructor has already been defined"),Vt=n}(H);const ds={};function fs(n,e,t,s,i){let r=s||n.options.databaseURL;void 0===r&&(n.options.projectId||$("Can't determine Firebase Database URL. Be sure to include  a Project ID when calling firebase.initializeApp()."),k("Using default host for project ",n.options.projectId),r=`${n.options.projectId}-default-rtdb.firebaseio.com`);let a,u,o=as(r,i),l=o.repoInfo;typeof process<"u"&&process.env&&(u=process.env.FIREBASE_DATABASE_EMULATOR_HOST),u?(a=!0,r=`http://${u}?ns=${l.namespace}`,o=as(r,i),l=o.repoInfo):a=!o.repoInfo.secure;const h=i&&a?new Qe(Qe.OWNER):new fo(n.name,n.options,e);qi("Invalid Firebase Database URL",o),v(o.path)||$("Database URL must point to the root of a Firebase Database (not including a child path).");const d=function Tc(n,e,t,s){let i=ds[e.name];i||(i={},ds[e.name]=i);let r=i[n.toURLString()];return r&&$("Database initialized multiple times. Please make sure the format of the database URL matches with each database() call."),r=new Pa(n,false,t,s),i[n.toURLString()]=r,r}(l,n,h,new ho(n.name,t));return new Sc(d,n)}class Sc{constructor(e,t){this._repoInternal=e,this.app=t,this.type="database",this._instanceStarted=!1}get _repo(){return this._instanceStarted||(function ka(n,e,t){if(n.stats_=fn(n.repoInfo_),n.forceRestClient_||("object"==typeof window&&window.navigator&&window.navigator.userAgent||"").search(/googlebot|google webmaster tools|bingbot|yahoo! slurp|baiduspider|yandexbot|duckduckbot/i)>=0)n.server_=new Rt(n.repoInfo_,(s,i,r,o)=>{tr(n,s,i,r,o)},n.authTokenProvider_,n.appCheckProvider_),setTimeout(()=>nr(n,!0),0);else{if(typeof t<"u"&&null!==t){if("object"!=typeof t)throw new Error("Only objects are supported for option databaseAuthVariableOverride");try{(0,c.As)(t)}catch(s){throw new Error("Invalid authOverride provided: "+s)}}n.persistentConnection_=new Ce(n.repoInfo_,e,(s,i,r,o)=>{tr(n,s,i,r,o)},s=>{nr(n,s)},s=>{!function xa(n,e){x(e,(t,s)=>{ns(n,t,s)})}(n,s)},n.authTokenProvider_,n.appCheckProvider_,t),n.server_=n.persistentConnection_}n.authTokenProvider_.addTokenChangeListener(s=>{n.server_.refreshAuthToken(s)}),n.appCheckProvider_.addTokenChangeListener(s=>{n.server_.refreshAppCheckToken(s.token)}),n.statsReporter_=function go(n,e){const t=n.toString();return dn[t]||(dn[t]=e()),dn[t]}(n.repoInfo_,()=>new gl(n.stats_,n.server_)),n.infoData_=new hl,n.infoSyncTree_=new Ui({startListening:(s,i,r,o)=>{let l=[];const a=n.infoData_.getNode(s._path);return a.isEmpty()||(l=st(n.infoSyncTree_,s._path,a),setTimeout(()=>{o("ok")},0)),l},stopListening:()=>{}}),ns(n,"connected",!1),n.serverSyncTree_=new Ui({startListening:(s,i,r,o)=>(n.server_.listen(s,r,i,(l,a)=>{const u=o(l,a);W(n.eventQueue_,s._path,u)}),[]),stopListening:(s,i)=>{n.server_.unlisten(s,i)}})}(this._repoInternal,this.app.options.appId,this.app.options.databaseAuthVariableOverride),this._instanceStarted=!0),this._repoInternal}get _root(){return this._rootInternal||(this._rootInternal=new H(this._repo,T())),this._rootInternal}_delete(){return null!==this._rootInternal&&(function Ec(n,e){const t=ds[e];(!t||t[n.key]!==n)&&$(`Database ${e}(${n.repoInfo_}) has already been deleted.`),ir(n),delete t[n.key]}(this._repo,this.app.name),this._repoInternal=null,this._rootInternal=null),Promise.resolve()}_checkNotDeleted(e){null===this._rootInternal&&$("Cannot call "+e+" on a deleted database.")}}function Er(){Qs.IS_TRANSPORT_INITIALIZED&&O("Transport has already been initialized. Please call this function before calling ref or setting up a listener")}function Ac(){Er(),se.forceDisallow()}function bc(){Er(),ke.forceDisallow(),se.forceAllow()}function Pc(n,e){Ss(n,e)}const xc={".sv":"timestamp"};class Mc{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return{committed:this.committed,snapshot:this.snapshot.toJSON()}}}Ce.prototype.simpleListen=function(n,e){this.sendRequest("q",{p:n},e)},Ce.prototype.echo=function(n,e){this.sendRequest("echo",{d:n},e)},function kc(n){rn(yt.SDK_VERSION),(0,yt._registerComponent)(new pe.uA("database",(e,{instanceIdentifier:t})=>fs(e.getProvider("app").getImmediate(),e.getProvider("auth-internal"),e.getProvider("app-check-internal"),t),"PUBLIC").setMultipleInstances(!0)),(0,yt.registerVersion)(vs,"1.0.5",n),(0,yt.registerVersion)(vs,"1.0.5","esm2017")}();const Uc=new nn.Vy("@firebase/database-compat"),Ir=function(n){Uc.warn("FIREBASE WARNING: "+n)};class Hc{constructor(e){this._delegate=e}cancel(e){(0,c.od)("OnDisconnect.cancel",0,1,arguments.length),(0,c.oD)("OnDisconnect.cancel","onComplete",e,!0);const t=this._delegate.cancel();return e&&t.then(()=>e(null),s=>e(s)),t}remove(e){(0,c.od)("OnDisconnect.remove",0,1,arguments.length),(0,c.oD)("OnDisconnect.remove","onComplete",e,!0);const t=this._delegate.remove();return e&&t.then(()=>e(null),s=>e(s)),t}set(e,t){(0,c.od)("OnDisconnect.set",1,2,arguments.length),(0,c.oD)("OnDisconnect.set","onComplete",t,!0);const s=this._delegate.set(e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){(0,c.od)("OnDisconnect.setWithPriority",2,3,arguments.length),(0,c.oD)("OnDisconnect.setWithPriority","onComplete",s,!0);const i=this._delegate.setWithPriority(e,t);return s&&i.then(()=>s(null),r=>s(r)),i}update(e,t){if((0,c.od)("OnDisconnect.update",1,2,arguments.length),Array.isArray(e)){const i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,Ir("Passing an Array to firebase.database.onDisconnect().update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}(0,c.oD)("OnDisconnect.update","onComplete",t,!0);const s=this._delegate.update(e);return t&&s.then(()=>t(null),i=>t(i)),s}}class Kc{constructor(e,t){this.committed=e,this.snapshot=t}toJSON(){return(0,c.od)("TransactionResult.toJSON",0,1,arguments.length),{committed:this.committed,snapshot:this.snapshot.toJSON()}}}class de{constructor(e,t){this._database=e,this._delegate=t}val(){return(0,c.od)("DataSnapshot.val",0,0,arguments.length),this._delegate.val()}exportVal(){return(0,c.od)("DataSnapshot.exportVal",0,0,arguments.length),this._delegate.exportVal()}toJSON(){return(0,c.od)("DataSnapshot.toJSON",0,1,arguments.length),this._delegate.toJSON()}exists(){return(0,c.od)("DataSnapshot.exists",0,0,arguments.length),this._delegate.exists()}child(e){return(0,c.od)("DataSnapshot.child",0,1,arguments.length),e=String(e),ut("DataSnapshot.child","path",e,!1),new de(this._database,this._delegate.child(e))}hasChild(e){return(0,c.od)("DataSnapshot.hasChild",1,1,arguments.length),ut("DataSnapshot.hasChild","path",e,!1),this._delegate.hasChild(e)}getPriority(){return(0,c.od)("DataSnapshot.getPriority",0,0,arguments.length),this._delegate.priority}forEach(e){return(0,c.od)("DataSnapshot.forEach",1,1,arguments.length),(0,c.oD)("DataSnapshot.forEach","action",e,!1),this._delegate.forEach(t=>e(new de(this._database,t)))}hasChildren(){return(0,c.od)("DataSnapshot.hasChildren",0,0,arguments.length),this._delegate.hasChildren()}get key(){return this._delegate.key}numChildren(){return(0,c.od)("DataSnapshot.numChildren",0,0,arguments.length),this._delegate.size}getRef(){return(0,c.od)("DataSnapshot.ref",0,0,arguments.length),new U(this._database,this._delegate.ref)}get ref(){return this.getRef()}}class D{constructor(e,t){this.database=e,this._delegate=t}on(e,t,s,i){var r;(0,c.od)("Query.on",2,4,arguments.length),(0,c.oD)("Query.on","callback",t,!1);const o=D.getCancelAndContextArgs_("Query.on",s,i),l=(u,h)=>{t.call(o.context,new de(this.database,u),h)};l.userCallback=t,l.context=o.context;const a=null===(r=o.cancel)||void 0===r?void 0:r.bind(o.context);switch(e){case"value":return hs(this._delegate,l,a),t;case"child_added":return _r(this._delegate,l,a),t;case"child_removed":return mr(this._delegate,l,a),t;case"child_changed":return pr(this._delegate,l,a),t;case"child_moved":return gr(this._delegate,l,a),t;default:throw new Error((0,c.dI)("Query.on","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}off(e,t,s){if((0,c.od)("Query.off",0,3,arguments.length),function(n,e,t){if(void 0!==e)switch(e){case"value":case"child_added":case"child_removed":case"child_changed":case"child_moved":break;default:throw new Error((0,c.dI)("Query.off","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}}(0,e),(0,c.oD)("Query.off","callback",t,!0),(0,c.HN)("Query.off","context",s,!0),t){const i=()=>{};i.userCallback=t,i.context=s,yr(this._delegate,e,i)}else yr(this._delegate,e)}get(){return Za(this._delegate).then(e=>new de(this.database,e))}once(e,t,s,i){(0,c.od)("Query.once",1,4,arguments.length),(0,c.oD)("Query.once","callback",t,!0);const r=D.getCancelAndContextArgs_("Query.once",s,i),o=new c.cY,l=(u,h)=>{const d=new de(this.database,u);t&&t.call(r.context,d,h),o.resolve(d)};l.userCallback=t,l.context=r.context;const a=u=>{r.cancel&&r.cancel.call(r.context,u),o.reject(u)};switch(e){case"value":hs(this._delegate,l,a,{onlyOnce:!0});break;case"child_added":_r(this._delegate,l,a,{onlyOnce:!0});break;case"child_removed":mr(this._delegate,l,a,{onlyOnce:!0});break;case"child_changed":pr(this._delegate,l,a,{onlyOnce:!0});break;case"child_moved":gr(this._delegate,l,a,{onlyOnce:!0});break;default:throw new Error((0,c.dI)("Query.once","eventType")+'must be a valid event type = "value", "child_added", "child_removed", "child_changed", or "child_moved".')}return o.promise}limitToFirst(e){return(0,c.od)("Query.limitToFirst",1,1,arguments.length),new D(this.database,j(this._delegate,function lc(n){if("number"!=typeof n||Math.floor(n)!==n||n<=0)throw new Error("limitToFirst: First argument must be a positive integer.");return new oc(n)}(e)))}limitToLast(e){return(0,c.od)("Query.limitToLast",1,1,arguments.length),new D(this.database,j(this._delegate,function cc(n){if("number"!=typeof n||Math.floor(n)!==n||n<=0)throw new Error("limitToLast: First argument must be a positive integer.");return new ac(n)}(e)))}orderByChild(e){return(0,c.od)("Query.orderByChild",1,1,arguments.length),new D(this.database,j(this._delegate,function hc(n){if("$key"===n)throw new Error('orderByChild: "$key" is invalid.  Use orderByKey() instead.');if("$priority"===n)throw new Error('orderByChild: "$priority" is invalid.  Use orderByPriority() instead.');if("$value"===n)throw new Error('orderByChild: "$value" is invalid.  Use orderByValue() instead.');return ut("orderByChild","path",n,!1),new uc(n)}(e)))}orderByKey(){return(0,c.od)("Query.orderByKey",0,0,arguments.length),new D(this.database,j(this._delegate,function fc(){return new dc}()))}orderByPriority(){return(0,c.od)("Query.orderByPriority",0,0,arguments.length),new D(this.database,j(this._delegate,function pc(){return new _c}()))}orderByValue(){return(0,c.od)("Query.orderByValue",0,0,arguments.length),new D(this.database,j(this._delegate,function mc(){return new gc}()))}startAt(e=null,t){return(0,c.od)("Query.startAt",0,2,arguments.length),new D(this.database,j(this._delegate,function sc(n=null,e){return ct("startAt","key",e,!0),new Cr(n,e)}(e,t)))}startAfter(e=null,t){return(0,c.od)("Query.startAfter",0,2,arguments.length),new D(this.database,j(this._delegate,function rc(n,e){return ct("startAfter","key",e,!0),new ic(n,e)}(e,t)))}endAt(e=null,t){return(0,c.od)("Query.endAt",0,2,arguments.length),new D(this.database,j(this._delegate,function ec(n,e){return ct("endAt","key",e,!0),new vr(n,e)}(e,t)))}endBefore(e=null,t){return(0,c.od)("Query.endBefore",0,2,arguments.length),new D(this.database,j(this._delegate,function nc(n,e){return ct("endBefore","key",e,!0),new tc(n,e)}(e,t)))}equalTo(e,t){return(0,c.od)("Query.equalTo",1,2,arguments.length),new D(this.database,j(this._delegate,function vc(n,e){return ct("equalTo","key",e,!0),new yc(n,e)}(e,t)))}toString(){return(0,c.od)("Query.toString",0,0,arguments.length),this._delegate.toString()}toJSON(){return(0,c.od)("Query.toJSON",0,1,arguments.length),this._delegate.toJSON()}isEqual(e){if((0,c.od)("Query.isEqual",1,1,arguments.length),!(e instanceof D))throw new Error("Query.isEqual failed: First argument must be an instance of firebase.database.Query.");return this._delegate.isEqual(e._delegate)}static getCancelAndContextArgs_(e,t,s){const i={cancel:void 0,context:void 0};if(t&&s)i.cancel=t,(0,c.oD)(e,"cancel",i.cancel,!0),i.context=s,(0,c.HN)(e,"context",i.context,!0);else if(t)if("object"==typeof t&&null!==t)i.context=t;else{if("function"!=typeof t)throw new Error((0,c.dI)(e,"cancelOrContext")+" must either be a cancel callback or a context object.");i.cancel=t}return i}get ref(){return new U(this.database,new H(this._delegate._repo,this._delegate._path))}}class U extends D{constructor(e,t){super(e,new L(t._repo,t._path,new bt,!1)),this.database=e,this._delegate=t}getKey(){return(0,c.od)("Reference.key",0,0,arguments.length),this._delegate.key}child(e){return(0,c.od)("Reference.child",1,1,arguments.length),"number"==typeof e&&(e=String(e)),new U(this.database,Ae(this._delegate,e))}getParent(){(0,c.od)("Reference.parent",0,0,arguments.length);const e=this._delegate.parent;return e?new U(this.database,e):null}getRoot(){return(0,c.od)("Reference.root",0,0,arguments.length),new U(this.database,this._delegate.root)}set(e,t){(0,c.od)("Reference.set",1,2,arguments.length),(0,c.oD)("Reference.set","onComplete",t,!0);const s=us(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}update(e,t){if((0,c.od)("Reference.update",1,2,arguments.length),Array.isArray(e)){const i={};for(let r=0;r<e.length;++r)i[""+r]=e[r];e=i,Ir("Passing an Array to Firebase.update() is deprecated. Use set() if you want to overwrite the existing data, or an Object with integer keys if you really do want to only update some of the children.")}B("Reference.update",this._delegate._path),(0,c.oD)("Reference.update","onComplete",t,!0);const s=Ja(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}setWithPriority(e,t,s){(0,c.od)("Reference.setWithPriority",2,3,arguments.length),(0,c.oD)("Reference.setWithPriority","onComplete",s,!0);const i=function Xa(n,e,t){if(B("setWithPriority",n._path),X("setWithPriority",e,n._path,!1),ts("setWithPriority",t,!1),".length"===n.key||".keys"===n.key)throw"setWithPriority failed: "+n.key+" is a read-only object.";const s=new c.cY;return ss(n._repo,n._path,e,t,s.wrapCallback(()=>{})),s.promise}(this._delegate,e,t);return s&&i.then(()=>s(null),r=>s(r)),i}remove(e){(0,c.od)("Reference.remove",0,1,arguments.length),(0,c.oD)("Reference.remove","onComplete",e,!0);const t=function za(n){return B("remove",n._path),us(n,null)}(this._delegate);return e&&t.then(()=>e(null),s=>e(s)),t}transaction(e,t,s){(0,c.od)("Reference.transaction",1,3,arguments.length),(0,c.oD)("Reference.transaction","transactionUpdate",e,!1),(0,c.oD)("Reference.transaction","onComplete",t,!0),function(n,e,t,s){if(void 0!==t&&"boolean"!=typeof t)throw new Error((0,c.dI)("Reference.transaction","applyLocally")+"must be a boolean.")}(0,0,s);const i=function Fc(n,e,t){var s;if(n=(0,c.Ku)(n),B("Reference.transaction",n._path),".length"===n.key||".keys"===n.key)throw"Reference.transaction failed: "+n.key+" is a read-only object.";const i=null===(s=null==t?void 0:t.applyLocally)||void 0===s||s,r=new c.cY,l=hs(n,()=>{});return function Ba(n,e,t,s,i,r){Ue(n,"transaction on "+e);const o={path:e,update:t,onComplete:s,status:null,order:Es(),applyLocally:r,retryCount:0,unwatcher:i,abortReason:null,currentWriteId:null,currentInputSnapshot:null,currentOutputSnapshotRaw:null,currentOutputSnapshotResolved:null},l=rs(n,e,void 0);o.currentInputSnapshot=l;const a=o.update(l.val());if(void 0===a)o.unwatcher(),o.currentOutputSnapshotRaw=null,o.currentOutputSnapshotResolved=null,o.onComplete&&o.onComplete(null,!1,o.currentInputSnapshot);else{at("transaction failed: Data returned ",a,o.path),o.status=0;const u=Gt(n.transactionQueueTree_,e),h=Ie(u)||[];let d;h.push(o),Jn(u,h),"object"==typeof a&&null!==a&&(0,c.gR)(a,".priority")?(d=(0,c.yw)(a,".priority"),(0,c.vA)(lt(d),"Invalid priority returned by transaction. Priority must be a valid string, finite number, server value, or null.")):d=(Ht(n.serverSyncTree_,e)||m.EMPTY_NODE).getPriority().val();const f=ht(n),_=R(a,d),p=zn(_,l,f);o.currentOutputSnapshotRaw=_,o.currentOutputSnapshotResolved=p,o.currentWriteId=$t(n);const E=Hn(n.serverSyncTree_,e,p,o.currentWriteId,o.applyLocally);W(n.eventQueue_,e,E),zt(n,n.transactionQueueTree_)}}(n._repo,n._path,e,(a,u,h)=>{let d=null;a?r.reject(a):(d=new Se(h,new H(n._repo,n._path),A),r.resolve(new Mc(u,d)))},l,i),r.promise}(this._delegate,e,{applyLocally:s}).then(r=>new Kc(r.committed,new de(this.database,r.snapshot)));return t&&i.then(r=>t(null,r.committed,r.snapshot),r=>t(r,!1,null)),i}setPriority(e,t){(0,c.od)("Reference.setPriority",1,2,arguments.length),(0,c.oD)("Reference.setPriority","onComplete",t,!0);const s=function qa(n,e){n=(0,c.Ku)(n),B("setPriority",n._path),ts("setPriority",e,!1);const t=new c.cY;return ss(n._repo,N(n._path,".priority"),e,null,t.wrapCallback(()=>{})),t.promise}(this._delegate,e);return t&&s.then(()=>t(null),i=>t(i)),s}push(e,t){(0,c.od)("Reference.push",0,2,arguments.length),(0,c.oD)("Reference.push","onComplete",t,!0);const s=function $a(n,e){n=(0,c.Ku)(n),B("push",n._path),X("push",e,n._path,!0);const t=er(n._repo),s=ja(t),i=Ae(n,s),r=Ae(n,s);let o;return o=null!=e?us(r,e).then(()=>r):Promise.resolve(r),i.then=o.then.bind(o),i.catch=o.then.bind(o,void 0),i}(this._delegate,e),i=s.then(o=>new U(this.database,o));t&&i.then(()=>t(null),o=>t(o));const r=new U(this.database,s);return r.then=i.then.bind(i),r.catch=i.catch.bind(i,void 0),r}onDisconnect(){return B("Reference.onDisconnect",this._delegate._path),new Hc(new hr(this._delegate._repo,this._delegate._path))}get key(){return this.getKey()}get parent(){return this.getParent()}get root(){return this.getRoot()}}class _t{constructor(e,t){this._delegate=e,this.app=t,this.INTERNAL={delete:()=>this._delegate._delete(),forceWebSockets:Ac,forceLongPolling:bc}}useEmulator(e,t,s={}){!function Tr(n,e,t,s={}){(n=(0,c.Ku)(n))._checkNotDeleted("useEmulator"),n._instanceStarted&&$("Cannot call useEmulator() after instance has already been initialized.");const i=n._repoInternal;let r;if(i.repoInfo_.nodeAdmin)s.mockUserToken&&$('mockUserToken is not supported by the Admin SDK. For client access with mock users, please use the "firebase" package instead of "firebase-admin".'),r=new Qe(Qe.OWNER);else if(s.mockUserToken){const o="string"==typeof s.mockUserToken?s.mockUserToken:(0,c.Fy)(s.mockUserToken,n.app.options.projectId);r=new Qe(o)}!function wc(n,e,t,s){n.repoInfo_=new un(`${e}:${t}`,!1,n.repoInfo_.namespace,n.repoInfo_.webSocketOnly,n.repoInfo_.nodeAdmin,n.repoInfo_.persistenceKey,n.repoInfo_.includeNamespaceInQueryParams,!0),s&&(n.authTokenProvider_=s)}(i,e,t,r)}(this._delegate,e,t,s)}ref(e){if((0,c.od)("database.ref",0,1,arguments.length),e instanceof U){const t=fr(this._delegate,e.toString());return new U(this,t)}{const t=dr(this._delegate,e);return new U(this,t)}}refFromURL(e){(0,c.od)("database.refFromURL",1,1,arguments.length);const s=fr(this._delegate,e);return new U(this,s)}goOffline(){return(0,c.od)("database.goOffline",0,0,arguments.length),function Nc(n){(n=(0,c.Ku)(n))._checkNotDeleted("goOffline"),ir(n._repo)}(this._delegate)}goOnline(){return(0,c.od)("database.goOnline",0,0,arguments.length),function Rc(n){(n=(0,c.Ku)(n))._checkNotDeleted("goOnline"),function Va(n){n.persistentConnection_&&n.persistentConnection_.resume(Zi)}(n._repo)}(this._delegate)}}_t.ServerValue={TIMESTAMP:function Dc(){return xc}(),increment:n=>function Oc(n){return{".sv":{increment:n}}}(n)};var Qc=Object.freeze({__proto__:null,initStandalone:function Gc({app:n,url:e,version:t,customAuthImpl:s,customAppCheckImpl:i,namespace:r,nodeAdmin:o=!1}){rn(t);const l=new pe.h1("database-standalone"),a=new pe.Kq("auth-internal",l);let u;return a.setComponent(new pe.uA("auth-internal",()=>s,"PRIVATE")),i&&(u=new pe.Kq("app-check-internal",l),u.setComponent(new pe.uA("app-check-internal",()=>i,"PRIVATE"))),{instance:new _t(fs(n,a,u,e,o),n),namespace:r}}});const Yc=_t.ServerValue;function pt(n,e,t="on",s=$r.E){return new zr.c(i=>{let r=null;return r=n[t](e,(o,l)=>{s.schedule(()=>{i.next({snapshot:o,prevKey:l})}),"once"===t&&s.schedule(()=>i.complete())},o=>{s.schedule(()=>i.error(o))}),"on"===t?{unsubscribe(){null!=r&&n.off(e,r)}}:{unsubscribe(){}}}).pipe((0,Ne.T)(i=>{const{snapshot:r,prevKey:o}=i;let l=null;return r.exists()&&(l=r.key),{type:e,payload:r,prevKey:o,key:l}}),(0,Ur.u)())}function Sr(n){return null==n}function Ar(n){return"function"==typeof n.set}function br(n,e){return Ar(e)?e:n.ref(e)}function Nr(n,e){if(function $c(n){return"string"==typeof n}(n))return e.stringCase();if(Ar(n))return e.firebaseCase();if(function zc(n){return"function"==typeof n.exportVal}(n))return e.snapshotCase();throw new Error("Expects a string, snapshot, or reference. Got: "+typeof n)}function Rr(n){return(Sr(n)||0===n.length)&&(n=["child_added","child_removed","child_changed","child_moved"]),n}function Pr(n,e,t){const s=(e=Rr(e)).map(i=>pt(n,i,"on",t));return(0,ys.h)(...s)}function kr(n,e){return function(s,i){return Nr(s,{stringCase:()=>n.child(s)[e](i),firebaseCase:()=>s[e](i),snapshotCase:()=>s.ref[e](i)})}}function Zc(n){return function(t){return t?Nr(t,{stringCase:()=>n.child(t).remove(),firebaseCase:()=>t.remove(),snapshotCase:()=>t.ref.remove()}):n.remove()}}function xr(n,e){const t=n.length;for(let s=0;s<t;s++)if(n[s].payload.key===e)return s;return-1}function nu(n,e){var t;const{payload:s,prevKey:i,key:r}=e,o=xr(n,r),l=function tu(n,e){if(Sr(e))return 0;{const t=xr(n,e);return-1===t?n.length:t+1}}(n,i);switch(e.type){case"value":if(null!==(t=e.payload)&&void 0!==t&&t.exists()){let a=null;e.payload.forEach(u=>{const h={payload:u,type:"value",prevKey:a,key:u.key};return a=u.key,n=[...n,h],!1})}return n;case"child_added":if(o>-1){const a=n[o-1];((null==a?void 0:a.key)||null)!==i&&(n=n.filter(u=>u.payload.key!==s.key)).splice(l,0,e)}else{if(null==i)return[e,...n];(n=n.slice()).splice(l,0,e)}return n;case"child_removed":return n.filter(a=>a.payload.key!==s.key);case"child_changed":return n.map(a=>a.payload.key===r?e:a);case"child_moved":if(o>-1){const a=n.splice(o,1)[0];return(n=n.slice()).splice(l,0,a),n}return n;default:return n}}function Dr(n,e,t){return function eu(n,e,t){return pt(n,"value","once",t).pipe((0,Yr.n)(s=>{const i=[(0,qr.of)(s)];return e.forEach(r=>i.push(pt(n,r,"on",t))),(0,ys.h)(...i).pipe((0,gs.S)(nu,[]))}),(0,jr.F)())}(n,e=Rr(e),t)}function Or(n,e){return function(){return pt(n,"value","on",e)}}!function jc(n){n.INTERNAL.registerComponent(new pe.uA("database-compat",(e,{instanceIdentifier:t})=>{const s=e.getProvider("app-compat").getImmediate(),i=e.getProvider("database").getImmediate({identifier:t});return new _t(i,s)},"PUBLIC").setServiceProps({Reference:U,Query:D,Database:_t,DataSnapshot:de,enableLogging:Pc,INTERNAL:Qc,ServerValue:Yc}).setMultipleInstances(!0)),n.registerVersion("@firebase/database-compat","1.0.5")}(Xr.A),w(7935);const ru=new g.nKC("angularfire2.realtimeDatabaseURL"),ou=new g.nKC("angularfire2.database.use-emulator");let lu=(()=>{var n;class e{constructor(s,i,r,o,l,a,u,h,d,f,_,p,E,P,be){(0,gt.A)(this,"schedulers",void 0),(0,gt.A)(this,"database",void 0),this.schedulers=a;const fe=u,_e=(0,mt.iB)(s,l,i);h&&(0,te.gF)(_e,l,d,_,p,E,f,P),this.database=(0,mt.BM)(`${_e.name}.database.${r}`,"AngularFireDatabase",_e.name,()=>{const en=l.runOutsideAngular(()=>_e.database(r||void 0));return fe&&en.useEmulator(...fe),en},[fe])}list(s,i){const r=this.schedulers.ngZone.runOutsideAngular(()=>br(this.database,s));let o=r;return i&&(o=i(r)),function su(n,e){const t=e.schedulers.outsideAngular,s=e.schedulers.ngZone.run(()=>n.ref);return{query:n,update:kr(s,"update"),set:kr(s,"set"),push:i=>s.push(i),remove:Zc(s),snapshotChanges:i=>Dr(n,i,t).pipe(ee.U0),stateChanges:i=>Pr(n,i,t).pipe(ee.U0),auditTrail:i=>function qc(n,e,t){return function Jc(n,e,t){return function Xc(n,e){return pt(n,"value","on",e).pipe((0,Ne.T)(t=>{let s;return t.payload.forEach(i=>(s=i.key,!1)),{data:t,lastKeyToLoad:s}}))}(n,t).pipe(function Gr(...n){const e=(0,Kr.ms)(n);return(0,ms.N)((t,s)=>{const i=n.length,r=new Array(i);let o=n.map(()=>!1),l=!1;for(let a=0;a<i;a++)(0,Vr.Tg)(n[a]).subscribe((0,tn._)(s,u=>{r[a]=u,!l&&!o[a]&&(o[a]=!0,(l=o.every(Br.D))&&(o=null))},Hr.l));t.subscribe((0,tn._)(s,a=>{if(l){const u=[a,...r];s.next(e?e(...u):u)}}))})}(e),(0,Ne.T)(([i,r])=>{const o=i.lastKeyToLoad,l=r.map(a=>a.key);return{actions:r,lastKeyToLoad:o,loadedKeys:l}}),function Qr(n){return(0,ms.N)((e,t)=>{let s=!1,i=0;e.subscribe((0,tn._)(t,r=>(s||(s=!n(r,i++)))&&t.next(r)))})}(i=>-1===i.loadedKeys.indexOf(i.lastKeyToLoad)),(0,Ne.T)(i=>i.actions))}(n,Pr(n,e).pipe((0,gs.S)((i,r)=>[...i,r],[])),t)}(n,i,t).pipe(ee.U0),valueChanges:(i,r)=>Dr(n,i,t).pipe((0,Ne.T)(l=>l.map(a=>r&&r.idField?{...a.payload.val(),[r.idField]:a.key}:a.payload.val())),ee.U0)}}(o,this)}object(s){return function iu(n,e){return{query:n,snapshotChanges:()=>Or(n,e.schedulers.outsideAngular)().pipe(ee.U0),update:t=>n.ref.update(t),set:t=>n.ref.set(t),remove:()=>n.ref.remove(),valueChanges:()=>Or(n,e.schedulers.outsideAngular)().pipe(ee.U0,(0,Ne.T)(s=>s.payload.exists()?s.payload.val():null))}}(this.schedulers.ngZone.runOutsideAngular(()=>br(this.database,s)),this)}createPushId(){return this.schedulers.ngZone.runOutsideAngular(()=>this.database.ref()).push().key}}return n=e,(0,gt.A)(e,"\u0275fac",function(s){return new(s||n)(g.KVO(mt.rx),g.KVO(mt.uP,8),g.KVO(ru,8),g.KVO(g.Agw),g.KVO(g.SKi),g.KVO(ee.u0),g.KVO(ou,8),g.KVO(te.DS,8),g.KVO(te.CP,8),g.KVO(te.yy,8),g.KVO(te.ZP,8),g.KVO(te.$z,8),g.KVO(te.AU,8),g.KVO(te.UB,8),g.KVO(ee.Jv,8))}),(0,gt.A)(e,"\u0275prov",g.jDH({token:n,factory:n.\u0275fac,providedIn:"any"})),e})();const au=[{path:"",component:(()=>{var n;class e{constructor(s,i,r){this.geolocation=s,this.nativeGeocoder=i,this.db=r,this.latitude=0,this.longitude=0,this.options={timeout:1e4,enableHighAccuracy:!0,maximumAge:3600},this.nativeGeocoderOptions={useLocale:!0,maxResults:5}}saveLocationData(){this.db.object("locations").set({latitude:this.latitude,longitude:this.longitude,address:this.address}).then(()=>{console.log("Datos de localizaci\xf3n guardados en Firebase")}).catch(i=>{console.error("Error al guardar los datos de localizaci\xf3n en Firebase:",i)})}getCurrentCoordinates(){this.geolocation.getCurrentPosition().then(s=>{console.log(s),this.latitude=s.coords.latitude,this.longitude=s.coords.longitude,this.getAddress(this.latitude,this.longitude),this.saveLocationData()}).catch(s=>{console.log("Error getting location",s)})}getAddress(s,i){this.nativeGeocoder.reverseGeocode(s,i,this.nativeGeocoderOptions).then(r=>{this.address=this.pretifyAddress(r[0])}).catch(r=>{alert("Error getting location"+JSON.stringify(r))})}pretifyAddress(s){let i=[],r="";for(let o in s)i.push(s[o]);i.reverse();for(let o in i)i[o].length&&(r+=i[o]+", ");return s.slice(0,-2)}}return(n=e).\u0275fac=function(s){return new(s||n)(g.rXU(Lr.L),g.rXU(Wr.K),g.rXU(lu))},n.\u0275cmp=g.VBU({type:n,selectors:[["app-home"]],decls:22,vars:2,consts:[[1,"ion-padding"],["expand","block",3,"click"],["color","danger","slot","end"]],template:function(s,i){1&s&&(g.j41(0,"ion-header")(1,"ion-toolbar")(2,"ion-title"),g.EFF(3," Ionic Geolocation & Geocoder Examples "),g.k0s()()(),g.j41(4,"ion-content")(5,"div",0)(6,"ion-button",1),g.bIt("click",function(){return i.getCurrentCoordinates()}),g.EFF(7," Get Location "),g.k0s(),g.j41(8,"ion-list")(9,"ion-list-header")(10,"ion-label"),g.EFF(11,"Location Coordinates"),g.k0s()(),g.j41(12,"ion-item")(13,"ion-label"),g.EFF(14," Latitue "),g.k0s(),g.j41(15,"ion-badge",2),g.EFF(16),g.k0s()(),g.j41(17,"ion-item")(18,"ion-label"),g.EFF(19," Longitude "),g.k0s(),g.j41(20,"ion-badge",2),g.EFF(21),g.k0s()()()()()),2&s&&(g.R7$(16),g.JRh(i.latitude),g.R7$(5),g.JRh(i.longitude))},dependencies:[K.In,K.Jm,K.W9,K.eU,K.uz,K.he,K.nf,K.AF,K.BC,K.ai],styles:["#container[_ngcontent-%COMP%]{text-align:center;position:absolute;left:0;right:0;top:50%;transform:translateY(-50%)}#container[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:20px;line-height:26px}#container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:16px;line-height:22px;color:#8c8c8c;margin:0}#container[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{text-decoration:none}"]}),e})()}];let cu=(()=>{var n;class e{}return(n=e).\u0275fac=function(s){return new(s||n)},n.\u0275mod=g.$C({type:n}),n.\u0275inj=g.G2t({imports:[ps.iI.forChild(au),ps.iI]}),e})(),uu=(()=>{var n;class e{}return(n=e).\u0275fac=function(s){return new(s||n)},n.\u0275mod=g.$C({type:n}),n.\u0275inj=g.G2t({imports:[Mr.MD,Fr.YN,K.bv,cu]}),e})()}}]);